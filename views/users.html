<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Управление пользователями — Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <a href="#" id="logout-link" class="logout-link">Выход</a>
  <h1>Beauty Studio</h1>
  <p>Управление пользователями</p>
  <div class="nav-links">
    <a href="/" id="salon-page-link">Страница салона</a>
    <a href="/admin">Админ-панель</a>
    <a href="/calendar">Календарь</a>
    <a href="/services">Услуги и мастера</a>
    <a href="/clients">Клиенты</a>
    <a href="#" id="logout-link">Выход</a>
  </div>
</header>

<div class="container">
  <div id="impersonation-banner" class="card" style="background: #fef3c7; border: 2px solid #fbbf24; margin-bottom: 16px; display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <strong>⚠️ Вы вошли под пользователем: <span id="impersonated-user"></span></strong>
        <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Оригинальный аккаунт: <span id="original-user"></span></p>
      </div>
      <button id="restore-account" class="btn-secondary" style="margin: 0;">Вернуться к своему аккаунту</button>
    </div>
  </div>

  <div class="user-info">
    <h3 id="user-name">Загрузка...</h3>
    <p id="user-email"></p>
  </div>

  <div class="card">
    <h2>Список пользователей</h2>
    <p class="description">Управление пользователями системы: блокировка, вход под пользователем, удаление.</p>

    <div id="users-list" style="margin-top: 16px;">
      <p style="text-align: center; color: #6b7280;">Загрузка...</p>
    </div>
  </div>
</div>

<footer>
  © 2025 Beauty Studio. Все права защищены.
</footer>

<script>
  let currentUser = null;
  let users = [];

  // Проверка авторизации и загрузка данных
  async function loadUserData() {
    try {
      const response = await fetch('/api/user');
      const result = await response.json();
      
      if (!result.success) {
        window.location.href = '/login';
        return;
      }

      currentUser = result.user;
      
      // Применяем дизайн
      if (currentUser.salonDesign) {
        applyDesign(currentUser.salonDesign);
      }
      
      // Проверяем, вошли ли мы под другим пользователем
      if (currentUser.isImpersonating) {
        document.getElementById('impersonation-banner').style.display = 'block';
        document.getElementById('impersonated-user').textContent = currentUser.username;
        document.getElementById('original-user').textContent = currentUser.originalUsername;
      }

      document.getElementById('user-name').textContent = `Добро пожаловать, ${currentUser.username}!`;
      document.getElementById('user-email').textContent = currentUser.email || 'Email не указан';
      
      // Обновляем ссылку "Страница салона" в навигации
      const salonPageLink = document.getElementById('salon-page-link');
      if (salonPageLink && currentUser.id) {
        salonPageLink.href = `/?userId=${currentUser.id}`;
      }
      
      // Проверяем права администратора (включая обратную совместимость)
      const isAdmin = currentUser.role === 'admin' || currentUser.username === 'admin';
      if (!isAdmin) {
        alert('Доступ запрещен. Требуются права администратора.');
        window.location.href = '/admin';
        return;
      }

      loadUsers();
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
      window.location.href = '/login';
    }
  }

  async function loadUsers() {
    try {
      const response = await fetch('/api/users');
      const result = await response.json();
      
      if (result.success) {
        users = result.users;
        renderUsers();
      }
    } catch (error) {
      console.error('Ошибка загрузки пользователей:', error);
      alert('Ошибка загрузки пользователей');
    }
  }

  function renderUsers() {
    const list = document.getElementById('users-list');
    if (!list) return;

    if (users.length === 0) {
      list.innerHTML = '<p style="text-align: center; color: #6b7280;">Пользователи не найдены</p>';
      return;
    }

    list.innerHTML = '';
    users.forEach((user) => {
      const row = document.createElement('div');
      row.className = 'admin-list-item';
      row.style.padding = '12px';
      row.style.marginBottom = '8px';
      row.style.border = '1px solid #e5e7eb';
      row.style.borderRadius = '8px';
      
      const main = document.createElement('div');
      main.className = 'admin-list-main';
      main.style.flex = '1';
      
      const nameRow = document.createElement('div');
      nameRow.style.display = 'flex';
      nameRow.style.alignItems = 'center';
      nameRow.style.gap = '8px';
      nameRow.style.marginBottom = '4px';
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = user.username;
      nameSpan.style.fontWeight = '600';
      nameSpan.style.fontSize = '1rem';
      
      if (user.role === 'admin') {
        const badge = document.createElement('span');
        badge.textContent = 'Админ';
        badge.style.background = '#fef3c7';
        badge.style.color = '#92400e';
        badge.style.padding = '2px 8px';
        badge.style.borderRadius = '999px';
        badge.style.fontSize = '0.75rem';
        nameRow.appendChild(badge);
      }
      
      if (user.isActive === false) {
        const badge = document.createElement('span');
        badge.textContent = 'Заблокирован';
        badge.style.background = '#fee2e2';
        badge.style.color = '#b91c1c';
        badge.style.padding = '2px 8px';
        badge.style.borderRadius = '999px';
        badge.style.fontSize = '0.75rem';
        nameRow.appendChild(badge);
      }
      
      nameRow.appendChild(nameSpan);
      main.appendChild(nameRow);
      
      const metaSpan = document.createElement('span');
      metaSpan.style.fontSize = '0.85rem';
      metaSpan.style.color = '#6b7280';
      metaSpan.innerHTML = `
        ${user.email || 'Email не указан'} • 
        Услуг: ${user.servicesCount} • 
        Мастеров: ${user.mastersCount} • 
        Создан: ${new Date(user.createdAt).toLocaleDateString('ru-RU')}
      `;
      main.appendChild(metaSpan);
      
      const actions = document.createElement('div');
      actions.className = 'admin-list-actions';
      actions.style.display = 'flex';
      actions.style.gap = '8px';
      actions.style.flexDirection = 'column';
      
      // Кнопка входа под пользователем
      if (user.id !== currentUser.id && user.isActive !== false) {
        const impersonateBtn = document.createElement('button');
        impersonateBtn.type = 'button';
        impersonateBtn.textContent = 'Войти под пользователем';
        impersonateBtn.className = 'btn-secondary';
        impersonateBtn.style.fontSize = '0.85rem';
        impersonateBtn.style.padding = '6px 12px';
        impersonateBtn.onclick = () => impersonateUser(user.id, user.username);
        actions.appendChild(impersonateBtn);
      }
      
      // Кнопка блокировки/разблокировки
      if (user.id !== currentUser.id && user.role !== 'admin') {
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.textContent = user.isActive ? 'Заблокировать' : 'Разблокировать';
        toggleBtn.className = user.isActive ? 'btn-secondary' : 'btn-primary';
        toggleBtn.style.fontSize = '0.85rem';
        toggleBtn.style.padding = '6px 12px';
        toggleBtn.onclick = () => toggleUser(user.id, user.isActive);
        actions.appendChild(toggleBtn);
      }
      
      // Кнопка удаления
      if (user.id !== currentUser.id && user.role !== 'admin') {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.style.background = '#fee2e2';
        deleteBtn.style.color = '#b91c1c';
        deleteBtn.style.border = '1px solid #fecaca';
        deleteBtn.style.fontSize = '0.85rem';
        deleteBtn.style.padding = '6px 12px';
        deleteBtn.style.borderRadius = '999px';
        deleteBtn.onclick = () => deleteUser(user.id, user.username);
        actions.appendChild(deleteBtn);
      }
      
      row.appendChild(main);
      row.appendChild(actions);
      list.appendChild(row);
    });
  }

  async function toggleUser(userId, currentStatus) {
    if (!confirm(`Вы уверены, что хотите ${currentStatus ? 'заблокировать' : 'разблокировать'} этого пользователя?`)) {
      return;
    }

    try {
      const response = await fetch(`/api/users/${userId}/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();
      if (result.success) {
        loadUsers();
      } else {
        alert(result.message || 'Ошибка');
      }
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка при изменении статуса пользователя');
    }
  }

  async function impersonateUser(userId, username) {
    if (!confirm(`Войти под пользователем "${username}"? Вы сможете вернуться к своему аккаунту.`)) {
      return;
    }

    try {
      const response = await fetch(`/api/users/${userId}/impersonate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();
      if (result.success) {
        alert(result.message);
        window.location.href = '/admin';
      } else {
        alert(result.message || 'Ошибка');
      }
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка при входе под пользователем');
    }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`ВНИМАНИЕ! Вы уверены, что хотите удалить пользователя "${username}"?\n\nЭто действие удалит:\n- Аккаунт пользователя\n- Все его записи\n\nДействие необратимо!`)) {
      return;
    }

    try {
      const response = await fetch(`/api/users/${userId}`, {
        method: 'DELETE'
      });

      const result = await response.json();
      if (result.success) {
        alert('Пользователь удален');
        loadUsers();
      } else {
        alert(result.message || 'Ошибка');
      }
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка при удалении пользователя');
    }
  }

  async function restoreAccount() {
    try {
      const response = await fetch('/api/users/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();
      if (result.success) {
        alert('Возврат к своему аккаунту выполнен');
        window.location.reload();
      } else {
        alert(result.message || 'Ошибка');
      }
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка при возврате к своему аккаунту');
    }
  }

  // Выход
  document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = '/login';
  });

  // Возврат к своему аккаунту
  document.getElementById('restore-account').addEventListener('click', restoreAccount);

  // Функция применения дизайна на всех страницах
  function applyDesign(design) {
    if (!design) return;

    const style = document.createElement('style');
    style.id = 'salon-custom-design';

    const primaryColor = design.primaryColor || '#f973b6';
    const secondaryColor = design.secondaryColor || '#a855f7';
    const headerBg = design.headerBg || '#f973b6';
    const cardBg = design.cardBg || '#ffffff';
    const textColor = design.textColor || '#222222';
    const pageBg = design.pageBg || '#f7f7fb';
    const pageBgType = design.pageBgType || 'color';
    const pageBgSecondary = design.pageBgSecondary || '#ffffff';
    const pageBgImage = design.pageBgImage || '';

    const isLightBg = isLightColor(cardBg);
    const finalTextColor = isLightBg ? textColor : '#ffffff';

    // Определяем фон страницы
    let bodyBg = pageBg;
    if (pageBgType === 'gradient') {
      bodyBg = `linear-gradient(135deg, ${pageBg}, ${pageBgSecondary})`;
    } else if (pageBgType === 'image' && pageBgImage) {
      bodyBg = `url(${pageBgImage}) center/cover no-repeat`;
    }

    // Применяем логотип в header, если есть
    if (design.logo) {
      const header = document.querySelector('header');
      const headerTitle = header ? header.querySelector('h1') : null;
      let logoImg = header ? header.querySelector('img.logo-img') : null;
      
      if (!logoImg && header && headerTitle) {
        logoImg = document.createElement('img');
        logoImg.src = design.logo;
        logoImg.className = 'logo-img';
        logoImg.alt = 'Логотип салона';
        logoImg.style.cssText = 'max-height: 80px; max-width: 200px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; object-fit: contain;';
        header.insertBefore(logoImg, headerTitle);
      } else if (logoImg) {
        logoImg.src = design.logo;
        logoImg.style.display = 'block';
      }
    } else {
      const logoImg = document.querySelector('header img.logo-img');
      if (logoImg) logoImg.remove();
    }

    style.textContent = `
      body {
        background: ${bodyBg} !important;
      }
      header {
        background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important;
        position: relative !important;
      }
      .card {
        background: ${cardBg} !important;
        color: ${finalTextColor} !important;
      }
      .card * {
        color: inherit !important;
      }
      .card h2, .card h3, .card h4, .card h5, .card h6 {
        color: ${finalTextColor} !important;
      }
      .card p, .card .description, .card .note, .card div, .card span:not(.price) {
        color: ${finalTextColor} !important;
      }
      .card label {
        color: ${finalTextColor} !important;
      }
      .btn-primary {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        color: white !important;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        filter: brightness(1.1);
        color: white !important;
      }
      input:focus, select:focus, textarea:focus {
        border-color: ${primaryColor} !important;
        box-shadow: 0 0 0 1px rgba(${hexToRgb(primaryColor)}, 0.35) !important;
      }
      input, select, textarea {
        color: ${finalTextColor} !important;
        background: ${isLightBg ? '#f9fafb' : 'rgba(255, 255, 255, 0.1)'} !important;
      }
      input::placeholder, textarea::placeholder {
        color: ${isLightBg ? '#9ca3af' : 'rgba(255, 255, 255, 0.6)'} !important;
      }
    `;

    const oldStyle = document.getElementById('salon-custom-design');
    if (oldStyle) oldStyle.remove();
    document.head.appendChild(style);
  }

  function isLightColor(hex) {
    const rgb = hexToRgbArray(hex);
    if (!rgb) return true;
    const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
    return brightness > 128;
  }

  function hexToRgbArray(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
      parseInt(result[1], 16),
      parseInt(result[2], 16),
      parseInt(result[3], 16)
    ] : null;
  }

  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
      `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
      : '249, 115, 182';
  }

  // Загружаем данные при загрузке страницы
  loadUserData();
</script>
</body>
</html>


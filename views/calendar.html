<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <div class="header-top-links">
    <a href="/users" id="users-link" class="header-top-link" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
    </a>
    <a href="#" id="logout-link" class="logout-link" title="–í—ã—Ö–æ–¥">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 17v-3h-5v-4h5V7l5 5-5 5zM14 2a2 2 0 012 2v2h-2V4H5v16h11v-2h2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V4a2 2 0 012-2h9z"/>
      </svg>
    </a>
  </div>
  <h1>Beauty Studio</h1>
  <p>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</p>
  <div class="nav-links">
    <a href="/booking" id="salon-page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–ª–æ–Ω–∞</a>
    <a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
    <a href="/calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="/services">–£—Å–ª—É–≥–∏ –∏ –º–∞—Å—Ç–µ—Ä–∞</a>
    <a href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
  </div>
</header>

<div class="container">
  <div class="card admin-calendar-card">
    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</h2>
    <p class="description">–ù–µ–¥–µ–ª—å–Ω—ã–π –≤–∏–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ —á–∞—Å–∞–º. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞—Ç—å –Ω–µ–¥–µ–ª–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –º–∞—Å—Ç–µ—Ä—É.</p>

    <div class="form-row" style="margin-bottom: 8px;">
      <div>
        <label for="calendar-master-filter">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞</label>
        <select id="calendar-master-filter">
          <option value="">–û–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞)</option>
        </select>
        <p class="note">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
      </div>
      <div>
        <label>–ù–µ–¥–µ–ª—è</label>
        <div class="week-controls">
          <button type="button" id="prev-week">‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</button>
          <div id="week-label"></div>
          <button type="button" id="next-week">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Ä∫</button>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
      <button type="button" id="create-booking-btn" class="btn-primary" style="display: flex; align-items: center; gap: 8px;">
        <span>‚ûï</span>
        <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</span>
      </button>
    </div>

    <div id="calendar-grid" class="calendar-grid"></div>
  </div>
</div>

<div id="booking-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">–ó–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞</div>
      <button type="button" id="modal-close" class="modal-close">√ó</button>
    </div>
    <div class="modal-body" id="modal-body-view">
      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏ –≤ –æ–¥–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ -->
      <div id="modal-bookings-navigation" style="display: none; margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <div style="font-weight: 600; color: #374151;">–ó–∞–ø–∏—Å–∏ –≤ —ç—Ç–æ –≤—Ä–µ–º—è:</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button type="button" id="modal-prev-booking" class="btn-secondary" style="padding: 4px 12px; font-size: 0.9rem;">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="modal-booking-counter" style="font-size: 0.9rem; color: #6b7280;">1 / 1</span>
            <button type="button" id="modal-next-booking" class="btn-secondary" style="padding: 4px 12px; font-size: 0.9rem;">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
          </div>
        </div>
        <div id="modal-other-bookings-list" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> <span id="modal-client-name"></span></p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="modal-client-phone"></span></p>
      <p>
        <span class="badge badge-service" id="modal-service"></span>
        <span class="badge badge-master" id="modal-master"></span>
      </p>
      <p><strong>–î–∞—Ç–∞:</strong> <span id="modal-date"></span></p>
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="modal-time"></span></p>
      <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong></p>
      <p id="modal-comment"></p>
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button type="button" class="btn-primary" id="edit-booking-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button type="button" class="btn-secondary" id="delete-booking-btn" style="background: #ef4444; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
    <div class="modal-body" id="modal-body-form" style="display: none;">
      <form id="new-booking-form">
        <div>
          <label for="new-booking-name">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ *</label>
          <input type="text" id="new-booking-name" required />
        </div>
        <div>
          <label for="new-booking-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input type="tel" id="new-booking-phone" placeholder="+998XX XXX XX XX" required />
        </div>
        <div>
          <label for="new-booking-service">–£—Å–ª—É–≥–∞ *</label>
          <select id="new-booking-service" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
          </select>
        </div>
        <div>
          <label for="new-booking-master">–ú–∞—Å—Ç–µ—Ä</label>
          <select id="new-booking-master">
            <option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>
          </select>
        </div>
        <div>
          <label for="new-booking-date">–î–∞—Ç–∞ *</label>
          <input type="date" id="new-booking-date" required min="" />
        </div>
        <div>
          <label for="new-booking-time">–í—Ä–µ–º—è *</label>
          <select id="new-booking-time" required>
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É</option>
          </select>
          <p id="new-booking-duration-hint" class="note"></p>
          <p id="new-booking-slot-hint" class="note"></p>
        </div>
        <div>
          <label for="new-booking-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="new-booking-comment" rows="3"></textarea>
        </div>
        <div id="new-booking-alert" style="display: none; margin-top: 12px;"></div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="submit" class="btn-primary" id="booking-form-submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button type="button" class="btn-secondary" id="cancel-booking-form">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Beauty Studio. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</footer>

<script>
  let bookings = [];
  let masters = [];
  let services = [];
  let currentUser = null;
  let currentWeekStart = null;
  const WEEK_DAYS = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToTime(total) {
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  }

  function dateToISO(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  async function loadData() {
    try {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const userRes = await fetch('/api/user');
      const userResult = await userRes.json();
      if (!userResult.success) {
        window.location.href = '/login';
        return;
      }

      currentUser = userResult.user;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∏–∑–∞–π–Ω
      if (currentUser.salonDesign) {
        applyDesign(currentUser.salonDesign);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É "–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–ª–æ–Ω–∞" –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      const salonPageLink = document.getElementById('salon-page-link');
      if (salonPageLink && currentUser && currentUser.id) {
        salonPageLink.href = `/booking?userId=${currentUser.id}`;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      const usersLink = document.getElementById('users-link');
      const isAdmin = currentUser.role === 'admin' || currentUser.username === 'admin';
      if (usersLink) {
        if (isAdmin) {
          usersLink.classList.add('show');
        } else {
          usersLink.classList.remove('show');
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π
      const bookingsRes = await fetch('/api/bookings');
      const bookingsResult = await bookingsRes.json();
      if (bookingsResult.success) {
        bookings = bookingsResult.bookings;
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', bookings.length);
        if (bookings.length > 0) {
          console.log('–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:', bookings[0]);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä bookingId
        const urlParams = new URLSearchParams(window.location.search);
        const bookingIdParam = urlParams.get('bookingId');
        if (bookingIdParam) {
          const bookingId = parseInt(bookingIdParam);
          // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
          window.history.replaceState({}, document.title, window.location.pathname);
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å
          openBookingById(bookingId);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä clientPhone –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const clientPhoneParam = urlParams.get('clientPhone');
        if (clientPhoneParam) {
          // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞
          const filteredBookings = bookings.filter(b => b.phone === clientPhoneParam);
          if (filteredBookings.length > 0) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ–¥–µ–ª—é —Å –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å—å—é –∫–ª–∏–µ–Ω—Ç–∞
            const firstBooking = filteredBookings[0];
            if (firstBooking.date) {
              const bookingDate = new Date(firstBooking.date);
              currentWeekStart = getWeekStart(bookingDate);
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            showNotification(
              '–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∏–µ–Ω—Ç—É',
              `–ü–æ–∫–∞–∑–∞–Ω—ã –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞: ${filteredBookings[0].name} (${filteredBookings.length} –∑–∞–ø–∏—Å–µ–π)`,
              'info'
            );
            // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          renderCalendar();
        }
      } else {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', bookingsResult);
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
      masters = currentUser.masters || [];
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥
      if (currentUser.id) {
        const servicesRes = await fetch(`/api/services/${currentUser.id}`);
        const servicesResult = await servicesRes.json();
        if (servicesResult.success) {
          services = servicesResult.services;
        }
      }
      
      renderMasterFilter();
      renderCalendar();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
      window.location.href = '/login';
    }
  }
  
  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è loadData, —á—Ç–æ–±—ã –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ Promise
  function loadDataPromise() {
    return loadData();
  }

  function renderMasterFilter() {
    const filter = document.getElementById('calendar-master-filter');
    if (!filter) return;

    const currentValue = filter.value;
    filter.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = '–û–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞)';
    filter.appendChild(allOpt);
    masters.forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      filter.appendChild(opt);
    });
    filter.value = currentValue || '';
  }

  function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    if (!currentWeekStart) {
      currentWeekStart = getWeekStart(new Date());
    }

    const startHour = 10;
    const endHour = 20;

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(currentWeekStart);
      d.setDate(d.getDate() + i);
      weekDates.push(d);
    }

    const weekLabel = document.getElementById('week-label');
    if (weekLabel) {
      const fmt = (d) => {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      };
      weekLabel.textContent = `${fmt(weekDates[0])} ‚Äì ${fmt(weekDates[6])}`;
    }

    grid.style.gridTemplateColumns = "80px repeat(7, 1fr)";
    grid.innerHTML = "";

    const emptyHeader = document.createElement("div");
    emptyHeader.className = "cal-cell cal-header cal-corner";
    grid.appendChild(emptyHeader);

    weekDates.forEach((d, idx) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-header cal-day-header";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      cell.textContent = `${WEEK_DAYS[idx]} ${dd}.${mm}`;
      grid.appendChild(cell);
    });

    const selectedMaster = document.getElementById('calendar-master-filter')?.value || "";

    for (let hour = startHour; hour < endHour; hour++) {
      const hourCell = document.createElement("div");
      hourCell.className = "cal-cell cal-hour-label";
      hourCell.textContent = `${String(hour).padStart(2, "0")}:00`;
      grid.appendChild(hourCell);

      weekDates.forEach((d) => {
        const cell = document.createElement("div");
        cell.className = "cal-cell cal-slot";
        const iso = dateToISO(d);

        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π —è—á–µ–π–∫–∏
        const bookingsForCell = bookings.filter((b) => {
          if (b.date !== iso) return false;
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –∑–∞–ø–∏—Å–∏
          if (selectedMaster && b.master !== selectedMaster) return false;
          const startM = timeToMinutes(b.time);
          if (startM === null) return false;
          // –ï—Å–ª–∏ endTime –Ω–µ —É–∫–∞–∑–∞–Ω, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∑–∞–ø–∏—Å—å –∑–∞–Ω–∏–º–∞–µ—Ç 1 —á–∞—Å
          const endM = b.endTime ? timeToMinutes(b.endTime) : (startM + 60);
          if (endM === null) return false;
          const cellStart = hour * 60;
          const cellEnd = (hour + 1) * 60;
          return startM < cellEnd && endM > cellStart;
        });

        if (bookingsForCell.length) {
          cell.classList.add("cal-slot-busy");
          
          // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –≤—Å–µ (—Ä–∞–∑–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
          if (bookingsForCell.length === 1) {
            // –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
            const b = bookingsForCell[0];
            const parts = [];
            if (b.service) parts.push(b.service);
            if (b.master && b.master.trim()) {
              parts.push(`üë§ ${b.master}`);
            } else {
              parts.push('üë§ –ë–µ–∑ –º–∞—Å—Ç–µ—Ä–∞');
            }
            if (b.name) parts.push(b.name);
            cell.textContent = parts.join(" ¬∑ ");
            cell.title = `${b.time}${b.endTime ? '-' + b.endTime : ''} ¬∑ ${b.service}${b.master ? ' ¬∑ ' + b.master : ''} ¬∑ ${b.name}`;
            const bookingIndex = bookings.indexOf(b);
            if (bookingIndex !== -1) {
              cell.dataset.bookingIndex = String(bookingIndex);
              cell.style.cursor = "pointer";
            }
          } else {
            // –ù–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤
            const mastersList = [...new Set(bookingsForCell.map(b => b.master || '–ë–µ–∑ –º–∞—Å—Ç–µ—Ä–∞'))];
            const parts = [];
            parts.push(`${bookingsForCell.length} –∑–∞–ø–∏—Å–µ–π`);
            if (mastersList.length <= 3) {
              parts.push(`üë§ ${mastersList.join(', ')}`);
            } else {
              parts.push(`üë§ ${mastersList.slice(0, 2).join(', ')} +${mastersList.length - 2}`);
            }
            cell.textContent = parts.join(" ¬∑ ");
            cell.title = bookingsForCell.map(b => 
              `${b.time}${b.endTime ? '-' + b.endTime : ''} ¬∑ ${b.master || '–ë–µ–∑ –º–∞—Å—Ç–µ—Ä–∞'}: ${b.name} - ${b.service}`
            ).join('\n');
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
            const b = bookingsForCell[0];
            const bookingIndex = bookings.indexOf(b);
            if (bookingIndex !== -1) {
              cell.dataset.bookingIndex = String(bookingIndex);
              cell.style.cursor = "pointer";
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
            cell.dataset.multipleBookings = "true";
            cell.style.fontSize = "0.85em";
          }
        } else {
          // –°–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
          cell.classList.add("cal-slot-free");
          cell.dataset.date = iso;
          cell.dataset.hour = String(hour);
          cell.style.cursor = "pointer";
          cell.title = "–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å";
        }

        grid.appendChild(cell);
      });
    }
  }

  let currentEditingBookingId = null; // ID –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
  let currentBookingIndex = 0; // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Å–ø–∏—Å–∫–µ –∑–∞–ø–∏—Å–µ–π –æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
  let sameTimeBookings = []; // –ú–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π –≤ –æ–¥–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ

  function openBookingModal(index) {
    const modal = document.getElementById('booking-modal');
    if (!modal) return;
    const booking = bookings[index];
    if (!booking) return;

    currentEditingBookingId = booking.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–æ–º –∂–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ (—Ç–∞ –∂–µ –¥–∞—Ç–∞ –∏ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–µ–µ—Å—è –≤—Ä–µ–º—è)
    const bookingStart = timeToMinutes(booking.time);
    const bookingEnd = booking.endTime ? timeToMinutes(booking.endTime) : (bookingStart + 60);
    
    sameTimeBookings = bookings.filter(b => {
      if (b.date !== booking.date) return false;
      const bStart = timeToMinutes(b.time);
      const bEnd = b.endTime ? timeToMinutes(b.endTime) : (bStart + 60);
      if (bStart === null || bEnd === null || bookingStart === null || bookingEnd === null) return false;
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
      return (bStart < bookingEnd && bEnd > bookingStart);
    });

    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Å–ø–∏—Å–∫–µ
    currentBookingIndex = sameTimeBookings.findIndex(b => b.id === booking.id);
    if (currentBookingIndex === -1) currentBookingIndex = 0;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é, –µ—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π
    const navSection = document.getElementById('modal-bookings-navigation');
    if (sameTimeBookings.length > 1) {
      navSection.style.display = 'block';
      updateBookingsNavigation();
      renderOtherBookingsList();
    } else {
      navSection.style.display = 'none';
    }

    displayBooking(booking);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('modal-body-view').style.display = 'block';
    document.getElementById('modal-body-form').style.display = 'none';
    document.getElementById('modal-title').textContent = '–ó–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞';
    
    modal.classList.remove("hidden");
  }

  function displayBooking(booking) {
    document.getElementById('modal-client-name').textContent = booking.name || "‚Äî";
    document.getElementById('modal-client-phone').textContent = booking.phone || "‚Äî";
    document.getElementById('modal-service').textContent = booking.service || "‚Äî";
    document.getElementById('modal-master').textContent = booking.master || "–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä";
    document.getElementById('modal-date').textContent = booking.date || "‚Äî";
    if (booking.time && booking.endTime) {
      document.getElementById('modal-time').textContent = `${booking.time}‚Äì${booking.endTime}`;
    } else {
      document.getElementById('modal-time').textContent = booking.time || "‚Äî";
    }
    document.getElementById('modal-comment').textContent = booking.comment || "–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è";
    
    currentEditingBookingId = booking.id;
  }

  function updateBookingsNavigation() {
    const counter = document.getElementById('modal-booking-counter');
    const prevBtn = document.getElementById('modal-prev-booking');
    const nextBtn = document.getElementById('modal-next-booking');
    
    if (counter) {
      counter.textContent = `${currentBookingIndex + 1} / ${sameTimeBookings.length}`;
    }
    
    if (prevBtn) {
      prevBtn.disabled = currentBookingIndex === 0;
      prevBtn.style.opacity = currentBookingIndex === 0 ? '0.5' : '1';
      prevBtn.style.cursor = currentBookingIndex === 0 ? 'not-allowed' : 'pointer';
    }
    
    if (nextBtn) {
      nextBtn.disabled = currentBookingIndex === sameTimeBookings.length - 1;
      nextBtn.style.opacity = currentBookingIndex === sameTimeBookings.length - 1 ? '0.5' : '1';
      nextBtn.style.cursor = currentBookingIndex === sameTimeBookings.length - 1 ? 'not-allowed' : 'pointer';
    }
  }

  function renderOtherBookingsList() {
    const listContainer = document.getElementById('modal-other-bookings-list');
    if (!listContainer) return;

    listContainer.innerHTML = sameTimeBookings.map((b, idx) => {
      const isActive = idx === currentBookingIndex;
      return `
        <div class="booking-list-item" data-index="${idx}" style="
          padding: 10px;
          background: ${isActive ? '#e0e7ff' : '#ffffff'};
          border: 2px solid ${isActive ? '#6366f1' : '#e5e7eb'};
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #1f2937;">${b.name || '‚Äî'}</div>
              <div style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">
                ${b.service || '‚Äî'} ${b.master ? '¬∑ üë§ ' + b.master : ''}
              </div>
            </div>
            <div style="font-size: 0.85rem; color: #6b7280;">
              ${b.time}${b.endTime ? '-' + b.endTime : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞
    listContainer.querySelectorAll('.booking-list-item').forEach(item => {
      item.addEventListener('click', () => {
        const idx = parseInt(item.dataset.index);
        if (idx !== currentBookingIndex && idx >= 0 && idx < sameTimeBookings.length) {
          currentBookingIndex = idx;
          const booking = sameTimeBookings[idx];
          const bookingIndex = bookings.findIndex(b => b.id === booking.id);
          if (bookingIndex !== -1) {
            displayBooking(booking);
            updateBookingsNavigation();
            renderOtherBookingsList();
          }
        }
      });
    });
  }
  
  function openEditBookingForm(bookingId) {
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) return;

    currentEditingBookingId = bookingId;

    document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å–∏
    document.getElementById('new-booking-name').value = booking.name || '';
    document.getElementById('new-booking-phone').value = booking.phone || '';
    const dateInput = document.getElementById('new-booking-date');
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è) –¥–∞–∂–µ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const today = new Date();
    const todayStr = dateToISO(today);
    dateInput.setAttribute('min', todayStr);
    dateInput.value = booking.date || '';
    document.getElementById('new-booking-comment').value = booking.comment || '';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —É—Å–ª—É–≥–∏
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} —Å—É–º, ${s.duration} –º–∏–Ω)`;
      opt.selected = s.name === booking.service;
      serviceSelect.appendChild(opt);
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>';
    masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      opt.selected = m.name === booking.master;
      masterSelect.appendChild(opt);
    });

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–µ–¥–≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
    generateNewBookingSlots().then(() => {
      const timeSelect = document.getElementById('new-booking-time');
      if (timeSelect && booking.time) {
        // –ò—â–µ–º —Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
        const bookingTime = booking.time.substring(0, 5); // –û–±—Ä–µ–∑–∞–µ–º –¥–æ HH:MM
        const options = Array.from(timeSelect.options);
        const matchingOption = options.find(opt => opt.value === bookingTime);
        if (matchingOption) {
          timeSelect.value = bookingTime;
        } else {
          // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫–∞–∫ –æ–ø—Ü–∏—é
          const customOption = document.createElement('option');
          customOption.value = bookingTime;
          customOption.textContent = `${bookingTime}${booking.endTime ? ' ‚Äì ' + booking.endTime.substring(0, 5) : ''} (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)`;
          timeSelect.appendChild(customOption);
          timeSelect.value = bookingTime;
        }
      }
    });

    // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) {
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–ø–∏—Å–∏ –ø–æ ID
  function openBookingById(bookingId) {
    const index = bookings.findIndex(b => b.id === bookingId);
    if (index !== -1) {
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ–¥–µ–ª—é —Å —ç—Ç–æ–π –∑–∞–ø–∏—Å—å—é
      const booking = bookings[index];
      if (booking.date) {
        const bookingDate = new Date(booking.date);
        currentWeekStart = getWeekStart(bookingDate);
        renderCalendar();
      }
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      setTimeout(() => {
        openBookingModal(index);
      }, 100);
    } else {
      // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      loadDataPromise().then(() => {
        const newIndex = bookings.findIndex(b => b.id === bookingId);
        if (newIndex !== -1) {
          const booking = bookings[newIndex];
          if (booking.date) {
            const bookingDate = new Date(booking.date);
            currentWeekStart = getWeekStart(bookingDate);
            renderCalendar();
          }
          setTimeout(() => {
            openBookingModal(newIndex);
          }, 100);
        }
      });
    }
  }

  async function generateNewBookingSlots() {
    const serviceSelect = document.getElementById('new-booking-service');
    const dateInput = document.getElementById('new-booking-date');
    const timeSelect = document.getElementById('new-booking-time');
    const masterSelect = document.getElementById('new-booking-master');
    const slotHint = document.getElementById('new-booking-slot-hint');
    const durationHint = document.getElementById('new-booking-duration-hint');

    if (timeSelect) {
      timeSelect.innerHTML = '';
      timeSelect.disabled = false;
    }
    if (slotHint) slotHint.textContent = '';
    if (durationHint) durationHint.textContent = '';

    if (!serviceSelect || !dateInput) return;

    const service = serviceSelect.value;
    const date = dateInput.value;
    const selectedMaster = masterSelect ? masterSelect.value : '';

    if (!service || !date) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    // –ù–∞—Ö–æ–¥–∏–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏
    const selectedService = services.find(s => s.name === service);
    if (!selectedService || !selectedService.duration) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const duration = selectedService.duration;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏ –º–∞—Å—Ç–µ—Ä–∞
    let busy = [];
    try {
      const bookingsRes = await fetch(`/api/bookings/${currentUser.id}?date=${date}`);
      const bookingsResult = await bookingsRes.json();
      if (bookingsResult.success && bookingsResult.bookings) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –º–∞—Å—Ç–µ—Ä—É
        const filteredBookings = selectedMaster && selectedMaster.trim() !== ''
          ? bookingsResult.bookings.filter(booking => {
              return booking.master === selectedMaster || !booking.master || booking.master.trim() === '';
            })
          : bookingsResult.bookings;
        
        busy = filteredBookings.map(booking => {
          const start = timeToMinutes(booking.time);
          const end = booking.endTime ? timeToMinutes(booking.endTime) : (start + 60);
          return [start, end].filter(v => v !== null);
        }).filter(interval => interval.length === 2);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', error);
    }

    const startOfDay = 10 * 60;
    const endOfDay = 20 * 60;
    const step = 30;

    const freeSlots = [];

    for (let start = startOfDay; start + duration <= endOfDay; start += step) {
      const end = start + duration;
      const overlaps = busy.some(([bStart, bEnd]) => start < bEnd && end > bStart);
      if (!overlaps) freeSlots.push({ start, end });
    }

    if (!freeSlots.length) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      if (slotHint) slotHint.textContent = '–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∏–ª–∏ —É—Å–ª—É–≥—É.';
      return;
    }

    if (timeSelect) {
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è';
      timeSelect.appendChild(defaultOption);

      freeSlots.forEach((slot) => {
        const opt = document.createElement('option');
        const startStr = minutesToTime(slot.start);
        const endStr = minutesToTime(slot.end);
        opt.value = startStr;
        opt.textContent = `${startStr} ‚Äì ${endStr}`;
        timeSelect.appendChild(opt);
      });
    }

    if (slotHint) slotHint.textContent = '–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.';
    if (durationHint) durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
  }

  function closeBookingModal() {
    const modal = document.getElementById('booking-modal');
    if (modal) {
      modal.classList.add("hidden");
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('modal-body-view').style.display = 'block';
      document.getElementById('modal-body-form').style.display = 'none';
      document.getElementById('new-booking-form').reset();
      document.getElementById('new-booking-alert').style.display = 'none';
      currentEditingBookingId = null;
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
      const submitBtn = document.getElementById('booking-form-submit');
      if (submitBtn) {
        submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
      }
    }
  }

  function openNewBookingForm(date = null, hour = null) {
    const modal = document.getElementById('booking-modal');
    if (!modal || !currentUser) return;
    
    currentEditingBookingId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    
    document.getElementById('modal-title').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('new-booking-form').reset();
    document.getElementById('new-booking-alert').style.display = 'none';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—É
    const dateInput = document.getElementById('new-booking-date');
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
    const today = new Date();
    const todayStr = dateToISO(today);
    dateInput.setAttribute('min', todayStr);
    
    if (date) {
      dateInput.value = date;
    } else {
      // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
      dateInput.value = todayStr;
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —É—Å–ª—É–≥–∏
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} —Å—É–º, ${s.duration} –º–∏–Ω)`;
      serviceSelect.appendChild(opt);
    });
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>';
    masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      masterSelect.appendChild(opt);
    });
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä –º–∞—Å—Ç–µ—Ä–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –≤ —Ñ–æ—Ä–º–µ
    const selectedMasterFilter = document.getElementById('calendar-master-filter')?.value;
    if (selectedMasterFilter && selectedMasterFilter.trim() !== '') {
      masterSelect.value = selectedMasterFilter;
    }
    
    // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) {
      submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ —É—Å–ª—É–≥–∞)
    generateNewBookingSlots();
    
    modal.classList.remove("hidden");
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
  document.getElementById('prev-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderCalendar();
  });

  document.getElementById('next-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderCalendar();
  });

  document.getElementById('calendar-master-filter')?.addEventListener('change', renderCalendar);

  // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
  document.getElementById('create-booking-btn')?.addEventListener('click', () => {
    openNewBookingForm();
  });

  document.getElementById('calendar-grid')?.addEventListener('click', (e) => {
    const target = e.target.closest(".cal-slot");
    if (!target) return;
    
    // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–∏—Å–∏
    if (target.classList.contains("cal-slot-busy")) {
      const idx = target.dataset.bookingIndex;
      if (idx !== undefined) {
        openBookingModal(Number(idx));
      }
      // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π, –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ (–ø–æ–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é)
      // TODO: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –≤ —ç—Ç–æ–º —Å–ª–æ—Ç–µ
    }
    // –ï—Å–ª–∏ —ç—Ç–æ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
    else if (target.classList.contains("cal-slot-free")) {
      const date = target.dataset.date;
      const hour = parseInt(target.dataset.hour);
      if (date && !isNaN(hour)) {
        openNewBookingForm(date, hour);
      }
    }
  });

  document.getElementById('modal-close')?.addEventListener('click', closeBookingModal);
  document.getElementById('booking-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'booking-modal') closeBookingModal();
  });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏ –≤ –æ–¥–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ
  document.getElementById('modal-prev-booking')?.addEventListener('click', () => {
    if (currentBookingIndex > 0) {
      currentBookingIndex--;
      const booking = sameTimeBookings[currentBookingIndex];
      displayBooking(booking);
      updateBookingsNavigation();
      renderOtherBookingsList();
    }
  });

  document.getElementById('modal-next-booking')?.addEventListener('click', () => {
    if (currentBookingIndex < sameTimeBookings.length - 1) {
      currentBookingIndex++;
      const booking = sameTimeBookings[currentBookingIndex];
      displayBooking(booking);
      updateBookingsNavigation();
      renderOtherBookingsList();
    }
  });

  document.getElementById('logout-link')?.addEventListener('click', async (e) => {
    e.preventDefault();
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = '/login';
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
  document.getElementById('new-booking-service')?.addEventListener('change', generateNewBookingSlots);
  document.getElementById('new-booking-date')?.addEventListener('change', generateNewBookingSlots);
  document.getElementById('new-booking-master')?.addEventListener('change', generateNewBookingSlots);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
  document.getElementById('new-booking-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const alert = document.getElementById('new-booking-alert');
    alert.style.display = 'none';
    
    const formData = {
      userId: currentUser.id,
      name: document.getElementById('new-booking-name').value.trim(),
      phone: document.getElementById('new-booking-phone').value.trim(),
      service: document.getElementById('new-booking-service').value,
      master: document.getElementById('new-booking-master').value,
      date: document.getElementById('new-booking-date').value,
      time: document.getElementById('new-booking-time').value,
      comment: document.getElementById('new-booking-comment').value.trim()
    };
    
    if (!formData.name || !formData.phone || !formData.service || !formData.date || !formData.time) {
      alert.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    const phoneDigits = formData.phone.replace(/\D/g, '');
    if (phoneDigits.length < 9) {
      alert.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 9 —Ü–∏—Ñ—Ä)';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    // –í—ã—á–∏—Å–ª—è–µ–º endTime –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ª—É–≥–∏
    const selectedService = services.find(s => s.name === formData.service);
    if (selectedService && selectedService.duration) {
      const [hours, minutes] = formData.time.split(':').map(Number);
      const startMinutes = hours * 60 + minutes;
      const endMinutes = startMinutes + selectedService.duration;
      const endHours = Math.floor(endMinutes / 60);
      const endMins = endMinutes % 60;
      formData.endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
    }
    
    const isEditing = currentEditingBookingId !== null;
    
    try {
      const url = isEditing ? `/api/bookings/${currentEditingBookingId}` : '/api/bookings';
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      if (result.success) {
        alert.textContent = isEditing ? '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!';
        alert.className = 'alert alert-success';
        alert.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const date = new Date(formData.date);
        const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        const bookingId = isEditing ? currentEditingBookingId : (result.booking?.id || null);
        showNotification(
          isEditing ? '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!',
          `${formData.name} - ${formData.service} –Ω–∞ ${dateStr} –≤ ${formData.time}`,
          'success',
          bookingId
        );
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        setTimeout(async () => {
          const bookingsRes = await fetch('/api/bookings');
          const bookingsResult = await bookingsRes.json();
          if (bookingsResult.success) {
            bookings = bookingsResult.bookings;
            lastBookingCount = bookings.length;
            renderCalendar();
          }
          closeBookingModal();
        }, 1000);
      } else {
        alert.textContent = result.message || (isEditing ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
        alert.className = 'alert alert-error';
        alert.style.display = 'block';
      }
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ ${isEditing ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '—Å–æ–∑–¥–∞–Ω–∏—è'} –∑–∞–ø–∏—Å–∏:`, error);
      alert.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ ${isEditing ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏' : '—Å–æ–∑–¥–∞–Ω–∏–∏'} –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
  document.getElementById('edit-booking-btn')?.addEventListener('click', () => {
    if (currentEditingBookingId) {
      openEditBookingForm(currentEditingBookingId);
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
  document.getElementById('delete-booking-btn')?.addEventListener('click', async () => {
    if (!currentEditingBookingId) return;
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/bookings/${currentEditingBookingId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      if (result.success) {
        showNotification('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è', 'info');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        setTimeout(async () => {
          const bookingsRes = await fetch('/api/bookings');
          const bookingsResult = await bookingsRes.json();
          if (bookingsResult.success) {
            bookings = bookingsResult.bookings;
            lastBookingCount = bookings.length;
            renderCalendar();
          }
          closeBookingModal();
        }, 500);
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  document.getElementById('cancel-booking-form')?.addEventListener('click', closeBookingModal);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  function highlightActivePage() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-links a, .header-top-links a');
    
    navLinks.forEach(link => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤—ã—Ö–æ–¥
      if (link.id === 'logout-link' || link.href === '#' || !link.href) {
        return;
      }
      
      try {
        const linkPath = new URL(link.href, window.location.origin).pathname;
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç–∏ (—É–±–∏—Ä–∞–µ–º trailing slash)
        const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
        const normalizedLink = linkPath.replace(/\/$/, '') || '/';
        
        if (normalizedLink === normalizedCurrent) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å URL, –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º href
        const href = link.getAttribute('href');
        if (href && (href === currentPath || href.replace(/\/$/, '') === currentPath.replace(/\/$/, ''))) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      }
    });
  }

  loadData();
  
  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  highlightActivePage();
</script>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notification-container" id="notification-container"></div>

<!-- –ò–∫–æ–Ω–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notifications-icon" id="notifications-icon">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25-2.5 7-2.5 7h15s-2.5-1.75-2.5-7c0-3.87-3.13-7-7-7zm0 2c2.76 0 5 2.24 5 5 0 2.88 2.88 4.5 2.88 4.5H4.12S7 11.88 7 9c0-2.76 2.24-5 5-5zm-1 15h2v2h-2v-2z"/>
  </svg>
  <div class="notifications-badge hidden" id="notifications-badge">0</div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notifications-panel" id="notifications-panel">
  <div class="notifications-panel-header">
    <div class="notifications-panel-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <button class="notifications-panel-close" id="notifications-panel-close">√ó</button>
  </div>
  <div class="notifications-panel-body" id="notifications-panel-body">
    <div class="notifications-panel-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
  </div>
  <div class="notifications-panel-footer">
    <button class="notifications-clear-all" id="notifications-clear-all">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
  </div>
</div>

<script>
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  let notificationsList = JSON.parse(localStorage.getItem('notifications') || '[]');
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ localStorage
  function saveNotifications() {
    localStorage.setItem('notifications', JSON.stringify(notificationsList));
    updateNotificationsPanel();
    updateNotificationsBadge();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫
  function addNotificationToList(title, message, type = 'success', bookingId = null) {
    const notification = {
      id: Date.now(),
      title,
      message,
      type,
      time: new Date().toISOString(),
      read: false,
      bookingId: bookingId // ID –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
    };
    
    notificationsList.unshift(notification); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)
    if (notificationsList.length > 50) {
      notificationsList = notificationsList.slice(0, 50);
    }
    
    saveNotifications();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function updateNotificationsBadge() {
    const badge = document.getElementById('notifications-badge');
    if (!badge) return;
    
    const unreadCount = notificationsList.filter(n => !n.read).length;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function updateNotificationsPanel() {
    const panelBody = document.getElementById('notifications-panel-body');
    if (!panelBody) return;
    
    if (notificationsList.length === 0) {
      panelBody.innerHTML = '<div class="notifications-panel-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
      return;
    }
    
    const icons = {
      success: '‚úì',
      error: '‚úï',
      warning: '‚ö†',
      info: '‚Ñπ'
    };
    
    const iconColors = {
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b',
      info: '#3b82f6'
    };
    
    panelBody.innerHTML = notificationsList.map(notif => {
      const date = new Date(notif.time);
      const timeStr = date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}" data-booking-id="${notif.bookingId || ''}">
          <div class="notification-item-icon" style="color: ${iconColors[notif.type] || iconColors.success}">
            ${icons[notif.type] || icons.success}
          </div>
          <div class="notification-item-content">
            <div class="notification-item-title">${notif.title}</div>
            <div class="notification-item-message">${notif.message}</div>
            <div class="notification-item-time">${timeStr}</div>
          </div>
          <button class="notification-item-close" onclick="removeNotification(${notif.id})">√ó</button>
        </div>
      `;
    }).join('');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞
    panelBody.querySelectorAll('.notification-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.classList.contains('notification-item-close')) return;
        const notifId = parseInt(item.dataset.id);
        const notification = notificationsList.find(n => n.id === notifId);
        markAsRead(notifId);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å bookingId, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        if (notification && notification.bookingId) {
          openBookingById(notification.bookingId);
        }
      });
    });
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
  function markAsRead(id) {
    const notification = notificationsList.find(n => n.id === id);
    if (notification && !notification.read) {
      notification.read = true;
      saveNotifications();
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  function removeNotification(id) {
    notificationsList = notificationsList.filter(n => n.id !== id);
    saveNotifications();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function showNotification(title, message, type = 'success', bookingId = null) {
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
    addNotificationToList(title, message, type, bookingId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = {
      success: '‚úì',
      error: '‚úï',
      warning: '‚ö†',
      info: '‚Ñπ'
    };
    
    notification.innerHTML = `
      <div class="notification-icon">${icons[type] || icons.success}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      notification.classList.add('hiding');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 5000);
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  document.getElementById('notifications-icon')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        notificationsList.forEach(n => n.read = true);
        saveNotifications();
      }
    }
  });
  
  document.getElementById('notifications-panel-close')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.remove('open');
    }
  });
  
  document.getElementById('notifications-clear-all')?.addEventListener('click', () => {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')) {
      notificationsList = [];
      saveNotifications();
    }
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
  document.addEventListener('click', (e) => {
    const panel = document.getElementById('notifications-panel');
    const icon = document.getElementById('notifications-icon');
    if (panel && icon && !panel.contains(e.target) && !icon.contains(e.target)) {
      panel.classList.remove('open');
    }
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  updateNotificationsPanel();
  updateNotificationsBadge();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  let knownBookingIds = new Set(); // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–∂–µ –≤–∏–¥–µ–ª–∏
  let lastBookingCheck = Date.now();
  
  async function checkNewBookings() {
    try {
      const bookingsRes = await fetch('/api/bookings');
      const bookingsResult = await bookingsRes.json();
      
      if (bookingsResult.success && bookingsResult.bookings) {
        const currentBookings = bookingsResult.bookings;
        
        // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ (—Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ knownBookingIds)
        const newBookings = currentBookings.filter(booking => {
          const bookingId = String(booking.id);
          if (!knownBookingIds.has(bookingId)) {
            knownBookingIds.add(bookingId);
            return true;
          }
          return false;
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
        // –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 2 —Å–µ–∫—É–Ω–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
        if (newBookings.length > 0 && (Date.now() - lastBookingCheck) > 2000) {
          newBookings.forEach(booking => {
            const date = new Date(booking.date);
            const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            showNotification(
              '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å!',
              `${booking.name} - ${booking.service} –Ω–∞ ${dateStr} –≤ ${booking.time}`,
              'info',
              booking.id // –ü–µ—Ä–µ–¥–∞–µ–º ID –∑–∞–ø–∏—Å–∏
            );
          });
        }
        
        lastBookingCheck = Date.now();
        bookings = currentBookings;
        renderCalendar();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π:', error);
    }
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  setTimeout(() => {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∫ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ
    bookings.forEach(booking => {
      knownBookingIds.add(String(booking.id));
    });
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(checkNewBookings, 30000);
  }, 2000);

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
  function applyDesign(design) {
    if (!design) return;

    const style = document.createElement('style');
    style.id = 'salon-custom-design';

    const primaryColor = design.primaryColor || '#f973b6';
    const secondaryColor = design.secondaryColor || '#a855f7';
    const headerBg = design.headerBg || '#f973b6';
    const cardBg = design.cardBg || '#ffffff';
    const textColor = design.textColor || '#222222';
    const buttonTextColor = design.buttonTextColor || '#ffffff';
    const pageBg = design.pageBg || '#f7f7fb';
    const pageBgType = design.pageBgType || 'color';
    const pageBgSecondary = design.pageBgSecondary || '#ffffff';
    const pageBgImage = design.pageBgImage || '';

    const isLightBg = isLightColor(cardBg);
    const finalTextColor = isLightBg ? textColor : '#ffffff';

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    let bodyBg = pageBg;
    if (pageBgType === 'gradient') {
      bodyBg = `linear-gradient(135deg, ${pageBg}, ${pageBgSecondary})`;
    } else if (pageBgType === 'image' && pageBgImage) {
      bodyBg = `url(${pageBgImage}) center/cover no-repeat`;
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ header, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (design.logo) {
      const header = document.querySelector('header');
      const headerTitle = header ? header.querySelector('h1') : null;
      let logoImg = header ? header.querySelector('img.logo-img') : null;
      
      if (!logoImg && header && headerTitle) {
        logoImg = document.createElement('img');
        logoImg.src = design.logo;
        logoImg.className = 'logo-img';
        logoImg.alt = '–õ–æ–≥–æ—Ç–∏–ø —Å–∞–ª–æ–Ω–∞';
        logoImg.style.cssText = 'max-height: 80px; max-width: 200px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; object-fit: contain;';
        header.insertBefore(logoImg, headerTitle);
      } else if (logoImg) {
        logoImg.src = design.logo;
        logoImg.style.display = 'block';
      }
    } else {
      const logoImg = document.querySelector('header img.logo-img');
      if (logoImg) logoImg.remove();
    }

    style.textContent = `
      body {
        background: ${bodyBg} !important;
      }
      header {
        background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important;
        position: relative !important;
      }
      .card {
        background: ${cardBg} !important;
        color: ${finalTextColor} !important;
      }
      .card * {
        color: inherit !important;
      }
      .card h2, .card h3, .card h4, .card h5, .card h6 {
        color: ${finalTextColor} !important;
      }
      .card p, .card .description, .card .note, .card div, .card span:not(.price) {
        color: ${finalTextColor} !important;
      }
      .card label {
        color: ${finalTextColor} !important;
      }
      .btn-primary {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        color: ${buttonTextColor} !important;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        filter: brightness(1.1);
        color: ${buttonTextColor} !important;
      }
      input:focus, select:focus, textarea:focus {
        border-color: ${primaryColor} !important;
        box-shadow: 0 0 0 1px rgba(${hexToRgb(primaryColor)}, 0.35) !important;
      }
      input, select, textarea {
        color: ${finalTextColor} !important;
        background: ${isLightBg ? '#f9fafb' : 'rgba(255, 255, 255, 0.1)'} !important;
      }
      input::placeholder, textarea::placeholder {
        color: ${isLightBg ? '#9ca3af' : 'rgba(255, 255, 255, 0.6)'} !important;
      }
    `;

    const oldStyle = document.getElementById('salon-custom-design');
    if (oldStyle) oldStyle.remove();
    document.head.appendChild(style);
  }

  function isLightColor(hex) {
    const rgb = hexToRgbArray(hex);
    if (!rgb) return true;
    const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
    return brightness > 128;
  }

  function hexToRgbArray(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
      parseInt(result[1], 16),
      parseInt(result[2], 16),
      parseInt(result[3], 16)
    ] : null;
  }

  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
      `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
      : '249, 115, 182';
  }
</script>
</body>
</html>


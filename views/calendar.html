<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Календарь — Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <h1>Beauty Studio</h1>
  <p>Календарь записей</p>
  <div class="nav-links">
    <a href="/" id="salon-page-link">Страница салона</a>
    <a href="/admin">Админ-панель</a>
    <a href="#" id="logout-link">Выход</a>
  </div>
</header>

<div class="container">
  <div class="card admin-calendar-card">
    <h2>Календарь записей</h2>
    <p class="description">Недельный вид расписания по часам. Можно перелистывать недели и фильтровать по мастеру.</p>

    <div class="form-row" style="margin-bottom: 8px;">
      <div>
        <label for="calendar-master-filter">Календарь мастера</label>
        <select id="calendar-master-filter">
          <option value="">Общий календарь (все мастера)</option>
        </select>
        <p class="note">Выберите конкретного мастера, чтобы посмотреть его личное расписание.</p>
      </div>
      <div>
        <label>Неделя</label>
        <div class="week-controls">
          <button type="button" id="prev-week">‹ Предыдущая неделя</button>
          <div id="week-label"></div>
          <button type="button" id="next-week">Следующая неделя ›</button>
        </div>
      </div>
    </div>

    <div id="calendar-grid" class="calendar-grid"></div>
  </div>
</div>

<div id="booking-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Запись клиента</div>
      <button type="button" id="modal-close" class="modal-close">×</button>
    </div>
    <div class="modal-body" id="modal-body-view">
      <p><strong>Клиент:</strong> <span id="modal-client-name"></span></p>
      <p><strong>Телефон:</strong> <span id="modal-client-phone"></span></p>
      <p>
        <span class="badge badge-service" id="modal-service"></span>
        <span class="badge badge-master" id="modal-master"></span>
      </p>
      <p><strong>Дата:</strong> <span id="modal-date"></span></p>
      <p><strong>Время:</strong> <span id="modal-time"></span></p>
      <p><strong>Комментарий:</strong></p>
      <p id="modal-comment"></p>
    </div>
    <div class="modal-body" id="modal-body-form" style="display: none;">
      <form id="new-booking-form">
        <div>
          <label for="new-booking-name">Имя клиента *</label>
          <input type="text" id="new-booking-name" required />
        </div>
        <div>
          <label for="new-booking-phone">Телефон *</label>
          <input type="tel" id="new-booking-phone" placeholder="+998XX XXX XX XX" required />
        </div>
        <div>
          <label for="new-booking-service">Услуга *</label>
          <select id="new-booking-service" required>
            <option value="">Выберите услугу</option>
          </select>
        </div>
        <div>
          <label for="new-booking-master">Мастер</label>
          <select id="new-booking-master">
            <option value="">Любой мастер</option>
          </select>
        </div>
        <div>
          <label for="new-booking-date">Дата *</label>
          <input type="date" id="new-booking-date" required />
        </div>
        <div>
          <label for="new-booking-time">Время *</label>
          <input type="time" id="new-booking-time" required />
        </div>
        <div>
          <label for="new-booking-comment">Комментарий</label>
          <textarea id="new-booking-comment" rows="3"></textarea>
        </div>
        <div id="new-booking-alert" style="display: none; margin-top: 12px;"></div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="submit" class="btn-primary">Создать запись</button>
          <button type="button" class="btn-secondary" id="cancel-booking-form">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  © 2025 Beauty Studio. Все права защищены.
</footer>

<script>
  let bookings = [];
  let masters = [];
  let services = [];
  let currentUser = null;
  let currentWeekStart = null;
  const WEEK_DAYS = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];

  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function dateToISO(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  async function loadData() {
    try {
      // Проверка авторизации
      const userRes = await fetch('/api/user');
      const userResult = await userRes.json();
      if (!userResult.success) {
        window.location.href = '/login';
        return;
      }

      currentUser = userResult.user;
      
      // Обновляем ссылку "Страница салона" в навигации
      const salonPageLink = document.getElementById('salon-page-link');
      if (salonPageLink && currentUser && currentUser.id) {
        salonPageLink.href = `/?userId=${currentUser.id}`;
      }

      // Загрузка записей
      const bookingsRes = await fetch('/api/bookings');
      const bookingsResult = await bookingsRes.json();
      if (bookingsResult.success) {
        bookings = bookingsResult.bookings;
        console.log('Загружено записей:', bookings.length);
        if (bookings.length > 0) {
          console.log('Пример записи:', bookings[0]);
        }
      } else {
        console.error('Ошибка загрузки записей:', bookingsResult);
      }

      // Загрузка мастеров
      masters = currentUser.masters || [];
      
      // Загрузка услуг
      if (currentUser.id) {
        const servicesRes = await fetch(`/api/services/${currentUser.id}`);
        const servicesResult = await servicesRes.json();
        if (servicesResult.success) {
          services = servicesResult.services;
        }
      }
      
      renderMasterFilter();
      renderCalendar();
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
      window.location.href = '/login';
    }
  }

  function renderMasterFilter() {
    const filter = document.getElementById('calendar-master-filter');
    if (!filter) return;

    const currentValue = filter.value;
    filter.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'Общий календарь (все мастера)';
    filter.appendChild(allOpt);
    masters.forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      filter.appendChild(opt);
    });
    filter.value = currentValue || '';
  }

  function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    if (!currentWeekStart) {
      currentWeekStart = getWeekStart(new Date());
    }

    const startHour = 10;
    const endHour = 20;

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(currentWeekStart);
      d.setDate(d.getDate() + i);
      weekDates.push(d);
    }

    const weekLabel = document.getElementById('week-label');
    if (weekLabel) {
      const fmt = (d) => {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      };
      weekLabel.textContent = `${fmt(weekDates[0])} – ${fmt(weekDates[6])}`;
    }

    grid.style.gridTemplateColumns = "80px repeat(7, 1fr)";
    grid.innerHTML = "";

    const emptyHeader = document.createElement("div");
    emptyHeader.className = "cal-cell cal-header cal-corner";
    grid.appendChild(emptyHeader);

    weekDates.forEach((d, idx) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-header cal-day-header";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      cell.textContent = `${WEEK_DAYS[idx]} ${dd}.${mm}`;
      grid.appendChild(cell);
    });

    const selectedMaster = document.getElementById('calendar-master-filter')?.value || "";

    for (let hour = startHour; hour < endHour; hour++) {
      const hourCell = document.createElement("div");
      hourCell.className = "cal-cell cal-hour-label";
      hourCell.textContent = `${String(hour).padStart(2, "0")}:00`;
      grid.appendChild(hourCell);

      weekDates.forEach((d) => {
        const cell = document.createElement("div");
        cell.className = "cal-cell cal-slot";
        const iso = dateToISO(d);

        const bookingsForCell = bookings.filter((b) => {
          if (b.date !== iso) return false;
          if (selectedMaster && b.master !== selectedMaster) return false;
          const startM = timeToMinutes(b.time);
          if (startM === null) return false;
          // Если endTime не указан, считаем что запись занимает 1 час
          const endM = b.endTime ? timeToMinutes(b.endTime) : (startM + 60);
          if (endM === null) return false;
          const cellStart = hour * 60;
          const cellEnd = (hour + 1) * 60;
          return startM < cellEnd && endM > cellStart;
        });

        if (bookingsForCell.length) {
          cell.classList.add("cal-slot-busy");
          const b = bookingsForCell[0];
          const parts = [];
          if (b.time && b.endTime) parts.push(`${b.time}-${b.endTime}`);
          if (b.service) parts.push(b.service);
          if (b.master) parts.push(b.master);
          cell.textContent = parts.join(" · ");
          const bookingIndex = bookings.indexOf(b);
          if (bookingIndex !== -1) {
            cell.dataset.bookingIndex = String(bookingIndex);
            cell.style.cursor = "pointer";
          }
        } else {
          // Свободный слот - можно создать запись
          cell.classList.add("cal-slot-free");
          cell.dataset.date = iso;
          cell.dataset.hour = String(hour);
          cell.style.cursor = "pointer";
          cell.title = "Кликните, чтобы создать запись";
        }

        grid.appendChild(cell);
      });
    }
  }

  function openBookingModal(index) {
    const modal = document.getElementById('booking-modal');
    if (!modal) return;
    const booking = bookings[index];
    if (!booking) return;

    document.getElementById('modal-client-name').textContent = booking.name || "—";
    document.getElementById('modal-client-phone').textContent = booking.phone || "—";
    document.getElementById('modal-service').textContent = booking.service || "—";
    document.getElementById('modal-master').textContent = booking.master || "Любой мастер";
    document.getElementById('modal-date').textContent = booking.date || "—";
    if (booking.time && booking.endTime) {
      document.getElementById('modal-time').textContent = `${booking.time}–${booking.endTime}`;
    } else {
      document.getElementById('modal-time').textContent = booking.time || "—";
    }
    document.getElementById('modal-comment').textContent = booking.comment || "Нет комментария";

    modal.classList.remove("hidden");
  }

  function closeBookingModal() {
    const modal = document.getElementById('booking-modal');
    if (modal) {
      modal.classList.add("hidden");
      // Сбрасываем форму
      document.getElementById('modal-body-view').style.display = 'block';
      document.getElementById('modal-body-form').style.display = 'none';
      document.getElementById('new-booking-form').reset();
      document.getElementById('new-booking-alert').style.display = 'none';
    }
  }

  function openNewBookingForm(date, hour) {
    const modal = document.getElementById('booking-modal');
    if (!modal || !currentUser) return;
    
    document.getElementById('modal-title').textContent = 'Создать новую запись';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';
    
    // Заполняем дату и время
    document.getElementById('new-booking-date').value = date;
    document.getElementById('new-booking-time').value = `${String(hour).padStart(2, '0')}:00`;
    
    // Заполняем услуги
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} сум, ${s.duration} мин)`;
      serviceSelect.appendChild(opt);
    });
    
    // Заполняем мастеров
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">Любой мастер</option>';
    masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      masterSelect.appendChild(opt);
    });
    
    modal.classList.remove("hidden");
  }

  // Слушатели событий
  document.getElementById('prev-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderCalendar();
  });

  document.getElementById('next-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderCalendar();
  });

  document.getElementById('calendar-master-filter')?.addEventListener('change', renderCalendar);

  document.getElementById('calendar-grid')?.addEventListener('click', (e) => {
    const target = e.target.closest(".cal-slot");
    if (!target) return;
    
    // Если это занятый слот - показываем информацию о записи
    if (target.classList.contains("cal-slot-busy")) {
      const idx = target.dataset.bookingIndex;
      if (idx !== undefined) {
        openBookingModal(Number(idx));
      }
    }
    // Если это свободный слот - открываем форму создания записи
    else if (target.classList.contains("cal-slot-free")) {
      const date = target.dataset.date;
      const hour = parseInt(target.dataset.hour);
      if (date && !isNaN(hour)) {
        openNewBookingForm(date, hour);
      }
    }
  });

  document.getElementById('modal-close')?.addEventListener('click', closeBookingModal);
  document.getElementById('booking-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'booking-modal') closeBookingModal();
  });

  document.getElementById('logout-link')?.addEventListener('click', async (e) => {
    e.preventDefault();
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = '/login';
  });

  // Обработчик формы создания записи
  document.getElementById('new-booking-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const alert = document.getElementById('new-booking-alert');
    alert.style.display = 'none';
    
    const formData = {
      userId: currentUser.id,
      name: document.getElementById('new-booking-name').value.trim(),
      phone: document.getElementById('new-booking-phone').value.trim(),
      service: document.getElementById('new-booking-service').value,
      master: document.getElementById('new-booking-master').value,
      date: document.getElementById('new-booking-date').value,
      time: document.getElementById('new-booking-time').value,
      comment: document.getElementById('new-booking-comment').value.trim()
    };
    
    if (!formData.name || !formData.phone || !formData.service || !formData.date || !formData.time) {
      alert.textContent = 'Заполните все обязательные поля';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    const phoneDigits = formData.phone.replace(/\D/g, '');
    if (phoneDigits.length < 9) {
      alert.textContent = 'Некорректный номер телефона (минимум 9 цифр)';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    // Вычисляем endTime на основе услуги
    const selectedService = services.find(s => s.name === formData.service);
    if (selectedService && selectedService.duration) {
      const [hours, minutes] = formData.time.split(':').map(Number);
      const startMinutes = hours * 60 + minutes;
      const endMinutes = startMinutes + selectedService.duration;
      const endHours = Math.floor(endMinutes / 60);
      const endMins = endMinutes % 60;
      formData.endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
    }
    
    try {
      const response = await fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      if (result.success) {
        alert.textContent = 'Запись успешно создана!';
        alert.className = 'alert alert-success';
        alert.style.display = 'block';
        
        // Обновляем данные и календарь
        setTimeout(async () => {
          const bookingsRes = await fetch('/api/bookings');
          const bookingsResult = await bookingsRes.json();
          if (bookingsResult.success) {
            bookings = bookingsResult.bookings;
            renderCalendar();
          }
          closeBookingModal();
        }, 1000);
      } else {
        alert.textContent = result.message || 'Ошибка при создании записи';
        alert.className = 'alert alert-error';
        alert.style.display = 'block';
      }
    } catch (error) {
      console.error('Ошибка создания записи:', error);
      alert.textContent = 'Ошибка при создании записи. Попробуйте позже.';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
    }
  });

  document.getElementById('cancel-booking-form')?.addEventListener('click', closeBookingModal);

  // Загружаем данные при загрузке страницы
  loadData();
</script>
</body>
</html>


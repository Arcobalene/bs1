<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <div class="header-top-links">
    <a href="/users" id="users-link" class="header-top-link" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
    </a>
    <a href="#" id="logout-link" class="logout-link" title="–í—ã—Ö–æ–¥">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 17v-3h-5v-4h5V7l5 5-5 5zM14 2a2 2 0 012 2v2h-2V4H5v16h11v-2h2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V4a2 2 0 012-2h9z"/>
      </svg>
    </a>
  </div>
  <h1>Beauty Studio</h1>
  <p>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</p>
  <div class="nav-links">
    <a href="/booking" id="salon-page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–ª–æ–Ω–∞</a>
    <a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
    <a href="/calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="/services">–£—Å–ª—É–≥–∏ –∏ –º–∞—Å—Ç–µ—Ä–∞</a>
    <a href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
  </div>
</header>

<div class="container">
  <div class="card admin-calendar-card">
    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</h2>
    <p class="description">–ù–µ–¥–µ–ª—å–Ω—ã–π –≤–∏–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ —á–∞—Å–∞–º. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞—Ç—å –Ω–µ–¥–µ–ª–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –º–∞—Å—Ç–µ—Ä—É.</p>

    <div class="form-row" style="margin-bottom: 8px;">
      <div>
        <label for="calendar-master-filter">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞</label>
        <select id="calendar-master-filter">
          <option value="">–û–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞)</option>
        </select>
        <p class="note">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
      </div>
      <div>
        <label>–ù–µ–¥–µ–ª—è</label>
        <div class="week-controls">
          <button type="button" id="prev-week">‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</button>
          <div id="week-label"></div>
          <button type="button" id="next-week">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Ä∫</button>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
      <button type="button" id="create-booking-btn" class="btn-primary" style="display: flex; align-items: center; gap: 8px;">
        <span>‚ûï</span>
        <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</span>
      </button>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-scroll-container">
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
    </div>
  </div>
</div>

<div id="booking-modal" class="modal-overlay hidden" style="z-index: 999999 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">–ó–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞</div>
      <button type="button" id="modal-close" class="modal-close">√ó</button>
    </div>
    <div class="modal-body" id="modal-body-view">
      <div id="modal-bookings-navigation" style="display: none; margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <div style="font-weight: 600; color: #374151;">–ó–∞–ø–∏—Å–∏ –≤ —ç—Ç–æ –≤—Ä–µ–º—è:</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button type="button" id="modal-prev-booking" class="btn-secondary" style="padding: 4px 12px; font-size: 0.9rem;">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="modal-booking-counter" style="font-size: 0.9rem; color: #6b7280;">1 / 1</span>
            <button type="button" id="modal-next-booking" class="btn-secondary" style="padding: 4px 12px; font-size: 0.9rem;">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
          </div>
        </div>
        <div id="modal-other-bookings-list" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> <span id="modal-client-name"></span></p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="modal-client-phone"></span></p>
      <p>
        <span class="badge badge-service" id="modal-service"></span>
        <span class="badge badge-master" id="modal-master"></span>
      </p>
      <p><strong>–î–∞—Ç–∞:</strong> <span id="modal-date"></span></p>
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="modal-time"></span></p>
      <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong></p>
      <p id="modal-comment"></p>
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button type="button" class="btn-primary" id="edit-booking-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button type="button" class="btn-secondary" id="delete-booking-btn" style="background: #ef4444; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
    <div class="modal-body" id="modal-body-form" style="display: none;">
      <form id="new-booking-form">
        <div>
          <label for="new-booking-name">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ *</label>
          <input type="text" id="new-booking-name" required />
        </div>
        <div>
          <label for="new-booking-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input type="tel" id="new-booking-phone" placeholder="+998XX XXX XX XX" required />
        </div>
        <div>
          <label for="new-booking-service">–£—Å–ª—É–≥–∞ *</label>
          <select id="new-booking-service" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
          </select>
        </div>
        <div>
          <label for="new-booking-master">–ú–∞—Å—Ç–µ—Ä</label>
          <select id="new-booking-master">
            <option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>
          </select>
        </div>
        <div>
          <label for="new-booking-date">–î–∞—Ç–∞ *</label>
          <input type="date" id="new-booking-date" required min="" />
        </div>
        <div>
          <label for="new-booking-time">–í—Ä–µ–º—è *</label>
          <select id="new-booking-time" required>
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É</option>
          </select>
          <p id="new-booking-duration-hint" class="note"></p>
          <p id="new-booking-slot-hint" class="note"></p>
        </div>
        <div>
          <label for="new-booking-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="new-booking-comment" rows="3"></textarea>
        </div>
        <div id="new-booking-alert" style="display: none; margin-top: 12px;"></div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="submit" class="btn-primary" id="booking-form-submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button type="button" class="btn-secondary" id="cancel-booking-form">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Beauty Studio. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</footer>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notification-container" id="notification-container"></div>

<!-- –ò–∫–æ–Ω–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notifications-icon" id="notifications-icon">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25-2.5 7-2.5 7h15s-2.5-1.75-2.5-7c0-3.87-3.13-7-7-7zm0 2c2.76 0 5 2.24 5 5 0 2.88 2.88 4.5 2.88 4.5H4.12S7 11.88 7 9c0-2.76 2.24-5 5-5zm-1 15h2v2h-2v-2z"/>
  </svg>
  <div class="notifications-badge hidden" id="notifications-badge">0</div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="notifications-panel" id="notifications-panel">
  <div class="notifications-panel-header">
    <div class="notifications-panel-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <button class="notifications-panel-close" id="notifications-panel-close">√ó</button>
  </div>
  <div class="notifications-panel-body" id="notifications-panel-body">
    <div class="notifications-panel-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
  </div>
  <div class="notifications-panel-footer">
    <button class="notifications-clear-all" id="notifications-clear-all">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
  </div>
</div>

<script>
// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
const CalendarApp = {
  bookings: [],
  masters: [],
  services: [],
  currentUser: null,
  currentWeekStart: null,
  currentEditingBookingId: null,
  currentBookingIndex: 0,
  sameTimeBookings: [],
  knownBookingIds: new Set(),
  lastBookingCheck: Date.now(),
  notificationsList: JSON.parse(localStorage.getItem('notifications') || '[]'),
  WEEK_DAYS: ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"],
  get START_HOUR() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    if (this.currentUser && this.currentUser.workHours) {
      return this.currentUser.workHours.startHour || 10;
    }
    return 10; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
  },
  get END_HOUR() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    if (this.currentUser && this.currentUser.workHours) {
      return this.currentUser.workHours.endHour || 20;
    }
    return 20; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }
};

// ========== –£–¢–ò–õ–ò–¢–´ ==========
const Utils = {
  timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  },

  minutesToTime(total) {
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  },

  dateToISO(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  },

  getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  },

  formatDate(dateStr) {
    if (!dateStr) return "‚Äî";
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }
};

// ========== API ==========
const API = {
  async getUser() {
    const res = await fetch('/api/user');
    return await res.json();
  },

  async getBookings() {
    const res = await fetch('/api/bookings');
    return await res.json();
  },

  async getBookingsByDate(userId, date) {
    const res = await fetch(`/api/bookings/${userId}?date=${date}`);
    return await res.json();
  },

  async getServices(userId) {
    const res = await fetch(`/api/services/${userId}`);
    return await res.json();
  },

  async createBooking(bookingData) {
    const res = await fetch('/api/bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bookingData)
    });
    return await res.json();
  },

  async updateBooking(id, bookingData) {
    const res = await fetch(`/api/bookings/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bookingData)
    });
    return await res.json();
  },

  async deleteBooking(id) {
    const res = await fetch(`/api/bookings/${id}`, { method: 'DELETE' });
    return await res.json();
  },

  async logout() {
    await fetch('/api/logout', { method: 'POST' });
  }
};

// ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==========
const DataLoader = {
  async loadAll() {
    try {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const userResult = await API.getUser();
      if (!userResult.success) {
        window.location.href = '/';
        return;
      }

      CalendarApp.currentUser = userResult.user;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∏–∑–∞–π–Ω
      if (CalendarApp.currentUser.salonDesign) {
        DesignManager.apply(CalendarApp.currentUser.salonDesign);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      NavigationManager.update(CalendarApp.currentUser);
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π
      const bookingsResult = await API.getBookings();
      if (bookingsResult.success) {
        CalendarApp.bookings = bookingsResult.bookings;
        this.initializeKnownBookings();
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
      CalendarApp.masters = CalendarApp.currentUser.masters || [];
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥
      if (CalendarApp.currentUser.id) {
        const servicesResult = await API.getServices(CalendarApp.currentUser.id);
        if (servicesResult.success) {
          CalendarApp.services = servicesResult.services;
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      this.handleURLParams();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      CalendarRenderer.renderMasterFilter();
      CalendarRenderer.render();
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
      window.location.href = '/';
    }
  },

  initializeKnownBookings() {
    CalendarApp.bookings.forEach(booking => {
      CalendarApp.knownBookingIds.add(String(booking.id));
    });
  },

  handleURLParams() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä bookingId
    const bookingIdParam = urlParams.get('bookingId');
    if (bookingIdParam) {
      const bookingId = parseInt(bookingIdParam);
      window.history.replaceState({}, document.title, window.location.pathname);
      BookingModal.openById(bookingId);
    }

    // –ü–∞—Ä–∞–º–µ—Ç—Ä clientPhone –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    const clientPhoneParam = urlParams.get('clientPhone');
    if (clientPhoneParam) {
      const filteredBookings = CalendarApp.bookings.filter(b => b.phone === clientPhoneParam);
      if (filteredBookings.length > 0) {
        const firstBooking = filteredBookings[0];
        if (firstBooking.date) {
          const bookingDate = new Date(firstBooking.date);
          CalendarApp.currentWeekStart = Utils.getWeekStart(bookingDate);
        }
        NotificationManager.show(
          '–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∏–µ–Ω—Ç—É',
          `–ü–æ–∫–∞–∑–∞–Ω—ã –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞: ${filteredBookings[0].name} (${filteredBookings.length} –∑–∞–ø–∏—Å–µ–π)`,
          'info'
        );
        window.history.replaceState({}, document.title, window.location.pathname);
        CalendarRenderer.render();
      }
    }
  }
};

// ========== –†–ï–ù–î–ï–†–ò–ù–ì –ö–ê–õ–ï–ù–î–ê–†–Ø ==========
const CalendarRenderer = {
  renderMasterFilter() {
    const filter = document.getElementById('calendar-master-filter');
    if (!filter) return;

    const currentValue = filter.value;
    filter.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = '–û–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞)';
    filter.appendChild(allOpt);
    
    CalendarApp.masters.forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      filter.appendChild(opt);
    });
    filter.value = currentValue || '';
  },

  render() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    if (!CalendarApp.currentWeekStart) {
      CalendarApp.currentWeekStart = Utils.getWeekStart(new Date());
    }

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(CalendarApp.currentWeekStart);
      d.setDate(d.getDate() + i);
      weekDates.push(d);
    }

    this.updateWeekLabel(weekDates);
    this.setupGridLayout(grid);
    grid.innerHTML = "";

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const emptyHeader = document.createElement("div");
    emptyHeader.className = "cal-cell cal-header cal-corner";
    grid.appendChild(emptyHeader);

    weekDates.forEach((d, idx) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-header cal-day-header";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      cell.textContent = `${CalendarApp.WEEK_DAYS[idx]} ${dd}.${mm}`;
      grid.appendChild(cell);
    });

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–ø–∏—Å—è—Ö
    const selectedMaster = document.getElementById('calendar-master-filter')?.value || "";
    const bookingsByDay = this.prepareBookingsByDay(weekDates, selectedMaster);
    const occupiedCells = {};

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞
    for (let hour = CalendarApp.START_HOUR; hour < CalendarApp.END_HOUR; hour++) {
      const hourCell = document.createElement("div");
      hourCell.className = "cal-cell cal-hour-label";
      hourCell.textContent = `${String(hour).padStart(2, "0")}:00`;
      grid.appendChild(hourCell);

      weekDates.forEach((d, dayIdx) => {
        const iso = Utils.dateToISO(d);
        const cellKey = `${iso}_${hour}`;
        
        if (occupiedCells[cellKey]) return;
        
        // –ò–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏: 2 (–ø–æ—Å–ª–µ –∫–æ–ª–æ–Ω–∫–∏ —á–∞—Å–æ–≤) + –∏–Ω–¥–µ–∫—Å –¥–Ω—è (0-6)
        const columnIndex = dayIdx + 2;
        const cell = this.createTimeSlotCell(iso, hour, bookingsByDay[iso], occupiedCells, columnIndex);
        grid.appendChild(cell);
      });
    }
  },

  updateWeekLabel(weekDates) {
    const weekLabel = document.getElementById('week-label');
    if (weekLabel) {
      const fmt = (d) => {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      };
      weekLabel.textContent = `${fmt(weekDates[0])} ‚Äì ${fmt(weekDates[6])}`;
    }
  },

  setupGridLayout(grid) {
    const isMobile = window.innerWidth <= 768;
    const timeColumnWidth = isMobile ? "45px" : "80px";
    
    if (isMobile) {
      grid.style.minWidth = "680px";
      grid.style.width = "680px";
      grid.style.maxWidth = "none";
      grid.style.gridTemplateColumns = `${timeColumnWidth} repeat(7, 91px)`;
    } else {
      grid.style.minWidth = "";
      grid.style.width = "";
      grid.style.maxWidth = "";
      grid.style.gridTemplateColumns = `${timeColumnWidth} repeat(7, 1fr)`;
    }
  },

  prepareBookingsByDay(weekDates, selectedMaster) {
    const bookingsByDay = {};
    weekDates.forEach((d) => {
      const iso = Utils.dateToISO(d);
      bookingsByDay[iso] = CalendarApp.bookings.filter(b => {
        if (b.date !== iso) return false;
        if (selectedMaster && b.master !== selectedMaster) return false;
        return true;
      });
    });
    return bookingsByDay;
  },

  createTimeSlotCell(iso, hour, dayBookings, occupiedCells, columnIndex) {
    const cell = document.createElement("div");
    cell.className = "cal-cell cal-slot";

    const bookingsForThisHour = (dayBookings || []).filter(b => {
      const startM = Utils.timeToMinutes(b.time);
      if (startM === null) return false;
      const cellStart = hour * 60;
      const cellEnd = (hour + 1) * 60;
      return startM >= cellStart && startM < cellEnd;
    });

    if (bookingsForThisHour.length) {
      cell.classList.add("cal-slot-busy");
      
      if (bookingsForThisHour.length === 1) {
        this.renderSingleBooking(cell, bookingsForThisHour[0], hour, iso, occupiedCells, columnIndex);
      } else {
        this.renderMultipleBookings(cell, bookingsForThisHour);
      }
    } else {
      cell.classList.add("cal-slot-free");
      cell.dataset.date = iso;
      cell.dataset.hour = String(hour);
      cell.style.cursor = "pointer";
      cell.title = "–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å";
    }

    return cell;
  },

  renderSingleBooking(cell, booking, hour, iso, occupiedCells, columnIndex) {
    const displayParts = [];
    if (booking.name) displayParts.push(booking.name);
    const timeStr = booking.time + (booking.endTime ? `-${booking.endTime}` : '');
    displayParts.push(timeStr);
    cell.textContent = displayParts.join(" ¬∑ ");
    
    const startM = Utils.timeToMinutes(booking.time);
    const endM = booking.endTime ? Utils.timeToMinutes(booking.endTime) : (startM + 60);
    
    if (startM !== null && endM !== null && endM > startM) {
      const durationMinutes = endM - startM;
      const durationHours = Math.ceil(durationMinutes / 60);
      const rowStart = (hour - CalendarApp.START_HOUR) + 2;
      const rowSpan = Math.min(durationHours, CalendarApp.END_HOUR - hour);
      
      if (rowSpan > 1) {
        // –£–∫–∞–∑—ã–≤–∞–µ–º –∏ —Å—Ç—Ä–æ–∫—É –∏ –∫–æ–ª–æ–Ω–∫—É, —á—Ç–æ–±—ã —è—á–µ–π–∫–∞ –Ω–µ —Å–¥–≤–∏–≥–∞–ª–∞—Å—å
        cell.style.gridRow = `${rowStart} / span ${rowSpan}`;
        cell.style.gridColumn = columnIndex;
        for (let h = hour + 1; h < hour + rowSpan && h < CalendarApp.END_HOUR; h++) {
          occupiedCells[`${iso}_${h}`] = true;
        }
      }
    }
    
    const fullInfo = [];
    if (booking.time) fullInfo.push(`–í—Ä–µ–º—è: ${booking.time}${booking.endTime ? '-' + booking.endTime : ''}`);
    if (booking.name) fullInfo.push(`–ö–ª–∏–µ–Ω—Ç: ${booking.name}`);
    if (booking.service) fullInfo.push(`–£—Å–ª—É–≥–∞: ${booking.service}`);
    if (booking.master && booking.master.trim()) {
      fullInfo.push(`–ú–∞—Å—Ç–µ—Ä: ${booking.master}`);
    }
    cell.title = fullInfo.join('\n');
    
    const bookingIndex = CalendarApp.bookings.indexOf(booking);
    if (bookingIndex !== -1) {
      cell.dataset.bookingIndex = String(bookingIndex);
      cell.style.cursor = "pointer";
    }
  },

  renderMultipleBookings(cell, bookings) {
    cell.textContent = `${bookings.length} –∑–∞–ø–∏—Å–µ–π`;
    const booking = bookings[0];
    const bookingIndex = CalendarApp.bookings.indexOf(booking);
    if (bookingIndex !== -1) {
      cell.dataset.bookingIndex = String(bookingIndex);
      cell.style.cursor = "pointer";
    }
    cell.dataset.multipleBookings = "true";
  }
};

// ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–ü–ò–°–ò ==========
const BookingModal = {
  open(index) {
    const booking = CalendarApp.bookings[index];
    if (!booking) return;

    CalendarApp.currentEditingBookingId = booking.id;
    this.findSameTimeBookings(booking);
    this.updateNavigation();
    this.displayBooking(booking);

    document.getElementById('modal-body-view').style.display = 'block';
    document.getElementById('modal-body-form').style.display = 'none';
    document.getElementById('modal-title').textContent = '–ó–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞';
    
    const modal = document.getElementById('booking-modal');
    if (modal) modal.classList.remove("hidden");
  },

  openById(bookingId) {
    const index = CalendarApp.bookings.findIndex(b => b.id === bookingId);
    if (index !== -1) {
      const booking = CalendarApp.bookings[index];
      if (booking.date) {
        const bookingDate = new Date(booking.date);
        CalendarApp.currentWeekStart = Utils.getWeekStart(bookingDate);
        CalendarRenderer.render();
      }
      setTimeout(() => this.open(index), 100);
    } else {
      DataLoader.loadAll().then(() => {
        const newIndex = CalendarApp.bookings.findIndex(b => b.id === bookingId);
        if (newIndex !== -1) {
          const booking = CalendarApp.bookings[newIndex];
          if (booking.date) {
            const bookingDate = new Date(booking.date);
            CalendarApp.currentWeekStart = Utils.getWeekStart(bookingDate);
            CalendarRenderer.render();
          }
          setTimeout(() => this.open(newIndex), 100);
        }
      });
    }
  },

  findSameTimeBookings(booking) {
    const bookingStart = Utils.timeToMinutes(booking.time);
    const bookingEnd = booking.endTime ? Utils.timeToMinutes(booking.endTime) : (bookingStart + 60);
    
    CalendarApp.sameTimeBookings = CalendarApp.bookings.filter(b => {
      if (b.date !== booking.date) return false;
      const bStart = Utils.timeToMinutes(b.time);
      const bEnd = b.endTime ? Utils.timeToMinutes(b.endTime) : (bStart + 60);
      if (bStart === null || bEnd === null || bookingStart === null || bookingEnd === null) return false;
      return (bStart < bookingEnd && bEnd > bookingStart);
    });

    CalendarApp.currentBookingIndex = CalendarApp.sameTimeBookings.findIndex(b => b.id === booking.id);
    if (CalendarApp.currentBookingIndex === -1) CalendarApp.currentBookingIndex = 0;
  },

  updateNavigation() {
    const navSection = document.getElementById('modal-bookings-navigation');
    if (CalendarApp.sameTimeBookings.length > 1) {
      navSection.style.display = 'block';
      this.updateBookingsNavigation();
      this.renderOtherBookingsList();
    } else {
      navSection.style.display = 'none';
    }
  },

  displayBooking(booking) {
    document.getElementById('modal-client-name').textContent = booking.name || "‚Äî";
    document.getElementById('modal-client-phone').textContent = booking.phone || "‚Äî";
    document.getElementById('modal-service').textContent = booking.service || "‚Äî";
    document.getElementById('modal-master').textContent = booking.master || "–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä";
    document.getElementById('modal-date').textContent = Utils.formatDate(booking.date);
    if (booking.time && booking.endTime) {
      document.getElementById('modal-time').textContent = `${booking.time}‚Äì${booking.endTime}`;
    } else {
      document.getElementById('modal-time').textContent = booking.time || "‚Äî";
    }
    document.getElementById('modal-comment').textContent = booking.comment || "–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è";
    CalendarApp.currentEditingBookingId = booking.id;
  },

  updateBookingsNavigation() {
    const counter = document.getElementById('modal-booking-counter');
    const prevBtn = document.getElementById('modal-prev-booking');
    const nextBtn = document.getElementById('modal-next-booking');
    
    if (counter) {
      counter.textContent = `${CalendarApp.currentBookingIndex + 1} / ${CalendarApp.sameTimeBookings.length}`;
    }
    
    if (prevBtn) {
      prevBtn.disabled = CalendarApp.currentBookingIndex === 0;
      prevBtn.style.opacity = CalendarApp.currentBookingIndex === 0 ? '0.5' : '1';
      prevBtn.style.cursor = CalendarApp.currentBookingIndex === 0 ? 'not-allowed' : 'pointer';
    }
    
    if (nextBtn) {
      nextBtn.disabled = CalendarApp.currentBookingIndex === CalendarApp.sameTimeBookings.length - 1;
      nextBtn.style.opacity = CalendarApp.currentBookingIndex === CalendarApp.sameTimeBookings.length - 1 ? '0.5' : '1';
      nextBtn.style.cursor = CalendarApp.currentBookingIndex === CalendarApp.sameTimeBookings.length - 1 ? 'not-allowed' : 'pointer';
    }
  },

  renderOtherBookingsList() {
    const listContainer = document.getElementById('modal-other-bookings-list');
    if (!listContainer) return;

    listContainer.innerHTML = CalendarApp.sameTimeBookings.map((b, idx) => {
      const isActive = idx === CalendarApp.currentBookingIndex;
      return `
        <div class="booking-list-item" data-index="${idx}" style="
          padding: 10px;
          background: ${isActive ? '#e0e7ff' : '#ffffff'};
          border: 2px solid ${isActive ? '#6366f1' : '#e5e7eb'};
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #1f2937;">${b.name || '‚Äî'}</div>
              <div style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">
                ${b.service || '‚Äî'} ${b.master ? '¬∑ üë§ ' + b.master : ''}
              </div>
            </div>
            <div style="font-size: 0.85rem; color: #6b7280;">
              ${b.time}${b.endTime ? '-' + b.endTime : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');

    listContainer.querySelectorAll('.booking-list-item').forEach(item => {
      item.addEventListener('click', () => {
        const idx = parseInt(item.dataset.index);
        if (idx !== CalendarApp.currentBookingIndex && idx >= 0 && idx < CalendarApp.sameTimeBookings.length) {
          CalendarApp.currentBookingIndex = idx;
          const booking = CalendarApp.sameTimeBookings[idx];
          const bookingIndex = CalendarApp.bookings.findIndex(b => b.id === booking.id);
          if (bookingIndex !== -1) {
            this.displayBooking(booking);
            this.updateBookingsNavigation();
            this.renderOtherBookingsList();
          }
        }
      });
    });
  },

  openEditForm(bookingId) {
    const booking = CalendarApp.bookings.find(b => b.id === bookingId);
    if (!booking) return;

    CalendarApp.currentEditingBookingId = bookingId;
    document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';

    BookingForm.fill(booking);
    BookingForm.generateSlots().then(() => {
      const timeSelect = document.getElementById('new-booking-time');
      if (timeSelect && booking.time) {
        const bookingTime = booking.time.substring(0, 5);
        const options = Array.from(timeSelect.options);
        const matchingOption = options.find(opt => opt.value === bookingTime);
        if (matchingOption) {
          timeSelect.value = bookingTime;
        } else {
          const customOption = document.createElement('option');
          customOption.value = bookingTime;
          customOption.textContent = `${bookingTime}${booking.endTime ? ' ‚Äì ' + booking.endTime.substring(0, 5) : ''} (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)`;
          timeSelect.appendChild(customOption);
          timeSelect.value = bookingTime;
        }
      }
    });

    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    
    // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å "hidden" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const modal = document.getElementById('booking-modal');
    if (modal) modal.classList.remove("hidden");
  },

  openNewForm(date = null, hour = null) {
    CalendarApp.currentEditingBookingId = null;
    document.getElementById('modal-title').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';
    
    document.getElementById('new-booking-form').reset();
    document.getElementById('new-booking-alert').style.display = 'none';
    
    const dateInput = document.getElementById('new-booking-date');
    const today = new Date();
    const todayStr = Utils.dateToISO(today);
    dateInput.setAttribute('min', todayStr);
    dateInput.value = date || todayStr;
    
    BookingForm.fillServices();
    BookingForm.fillMasters();
    
    const selectedMasterFilter = document.getElementById('calendar-master-filter')?.value;
    if (selectedMasterFilter && selectedMasterFilter.trim() !== '') {
      document.getElementById('new-booking-master').value = selectedMasterFilter;
    }
    
    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
    
    BookingForm.generateSlots();
    
    const modal = document.getElementById('booking-modal');
    if (modal) modal.classList.remove("hidden");
  },

  close() {
    const modal = document.getElementById('booking-modal');
    if (modal) {
      modal.classList.add("hidden");
      document.getElementById('modal-body-view').style.display = 'block';
      document.getElementById('modal-body-form').style.display = 'none';
      document.getElementById('new-booking-form').reset();
      document.getElementById('new-booking-alert').style.display = 'none';
      CalendarApp.currentEditingBookingId = null;
      const submitBtn = document.getElementById('booking-form-submit');
      if (submitBtn) submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
    }
  }
};

// ========== –§–û–†–ú–ê –ó–ê–ü–ò–°–ò ==========
const BookingForm = {
  fill(booking) {
    document.getElementById('new-booking-name').value = booking.name || '';
    document.getElementById('new-booking-phone').value = booking.phone || '';
    const dateInput = document.getElementById('new-booking-date');
    const today = new Date();
    const todayStr = Utils.dateToISO(today);
    dateInput.setAttribute('min', todayStr);
    dateInput.value = booking.date || '';
    document.getElementById('new-booking-comment').value = booking.comment || '';
    
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
    CalendarApp.services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} —Å—É–º, ${s.duration} –º–∏–Ω)`;
      opt.selected = s.name === booking.service;
      serviceSelect.appendChild(opt);
    });

    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>';
    CalendarApp.masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      opt.selected = m.name === booking.master;
      masterSelect.appendChild(opt);
    });
  },

  fillServices() {
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
    CalendarApp.services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} —Å—É–º, ${s.duration} –º–∏–Ω)`;
      serviceSelect.appendChild(opt);
    });
  },

  fillMasters() {
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä</option>';
    CalendarApp.masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      masterSelect.appendChild(opt);
    });
  },

  async generateSlots() {
    const serviceSelect = document.getElementById('new-booking-service');
    const dateInput = document.getElementById('new-booking-date');
    const timeSelect = document.getElementById('new-booking-time');
    const masterSelect = document.getElementById('new-booking-master');
    const slotHint = document.getElementById('new-booking-slot-hint');
    const durationHint = document.getElementById('new-booking-duration-hint');

    if (timeSelect) {
      timeSelect.innerHTML = '';
      timeSelect.disabled = false;
    }
    if (slotHint) slotHint.textContent = '';
    if (durationHint) durationHint.textContent = '';

    if (!serviceSelect || !dateInput) return;

    const service = serviceSelect.value;
    const date = dateInput.value;
    const selectedMaster = masterSelect ? masterSelect.value : '';

    if (!service || !date) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const selectedService = CalendarApp.services.find(s => s.name === service);
    if (!selectedService || !selectedService.duration) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const duration = selectedService.duration;
    let busy = [];
    
    try {
      const bookingsResult = await API.getBookingsByDate(CalendarApp.currentUser.id, date);
      if (bookingsResult.success && bookingsResult.bookings) {
        const filteredBookings = selectedMaster && selectedMaster.trim() !== ''
          ? bookingsResult.bookings.filter(booking => {
              return booking.master === selectedMaster || !booking.master || booking.master.trim() === '';
            })
          : bookingsResult.bookings;
        
        busy = filteredBookings.map(booking => {
          const start = Utils.timeToMinutes(booking.time);
          const end = booking.endTime ? Utils.timeToMinutes(booking.endTime) : (start + 60);
          return [start, end].filter(v => v !== null);
        }).filter(interval => interval.length === 2);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', error);
    }

    const startOfDay = CalendarApp.START_HOUR * 60;
    const endOfDay = CalendarApp.END_HOUR * 60;
    const step = 30;
    const freeSlots = [];

    for (let start = startOfDay; start + duration <= endOfDay; start += step) {
      const end = start + duration;
      const overlaps = busy.some(([bStart, bEnd]) => start < bEnd && end > bStart);
      if (!overlaps) freeSlots.push({ start, end });
    }

    if (!freeSlots.length) {
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å';
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      if (slotHint) slotHint.textContent = '–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∏–ª–∏ —É—Å–ª—É–≥—É.';
      return;
    }

    if (timeSelect) {
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è';
      timeSelect.appendChild(defaultOption);

      freeSlots.forEach((slot) => {
        const opt = document.createElement('option');
        const startStr = Utils.minutesToTime(slot.start);
        const endStr = Utils.minutesToTime(slot.end);
        opt.value = startStr;
        opt.textContent = `${startStr} ‚Äì ${endStr}`;
        timeSelect.appendChild(opt);
      });
    }

    if (slotHint) slotHint.textContent = '–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.';
    if (durationHint) durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
  },

  async submit() {
    const alert = document.getElementById('new-booking-alert');
    alert.style.display = 'none';
    
    const formData = {
      userId: CalendarApp.currentUser.id,
      name: document.getElementById('new-booking-name').value.trim(),
      phone: document.getElementById('new-booking-phone').value.trim(),
      service: document.getElementById('new-booking-service').value,
      master: document.getElementById('new-booking-master').value,
      date: document.getElementById('new-booking-date').value,
      time: document.getElementById('new-booking-time').value,
      comment: document.getElementById('new-booking-comment').value.trim()
    };
    
    if (!formData.name || !formData.phone || !formData.service || !formData.date || !formData.time) {
      alert.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    const phoneDigits = formData.phone.replace(/\D/g, '');
    if (phoneDigits.length < 9) {
      alert.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 9 —Ü–∏—Ñ—Ä)';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    const selectedService = CalendarApp.services.find(s => s.name === formData.service);
    if (selectedService && selectedService.duration) {
      const [hours, minutes] = formData.time.split(':').map(Number);
      const startMinutes = hours * 60 + minutes;
      const endMinutes = startMinutes + selectedService.duration;
      const endHours = Math.floor(endMinutes / 60);
      const endMins = endMinutes % 60;
      formData.endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
    }
    
    const isEditing = CalendarApp.currentEditingBookingId !== null;
    
    try {
      const result = isEditing 
        ? await API.updateBooking(CalendarApp.currentEditingBookingId, formData)
        : await API.createBooking(formData);
      
      if (result.success) {
        alert.textContent = isEditing ? '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!';
        alert.className = 'alert alert-success';
        alert.style.display = 'block';
        
        const date = new Date(formData.date);
        const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        const bookingId = isEditing ? CalendarApp.currentEditingBookingId : (result.booking?.id || null);
        NotificationManager.show(
          isEditing ? '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!',
          `${formData.name} - ${formData.service} –Ω–∞ ${dateStr} –≤ ${formData.time}`,
          'success',
          bookingId
        );
        
        setTimeout(async () => {
          const bookingsResult = await API.getBookings();
          if (bookingsResult.success) {
            CalendarApp.bookings = bookingsResult.bookings;
            CalendarRenderer.render();
          }
          BookingModal.close();
        }, 1000);
      } else {
        alert.textContent = result.message || (isEditing ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
        alert.className = 'alert alert-error';
        alert.style.display = 'block';
      }
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ ${isEditing ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '—Å–æ–∑–¥–∞–Ω–∏—è'} –∑–∞–ø–∏—Å–∏:`, error);
      alert.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ ${isEditing ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏' : '—Å–æ–∑–¥–∞–Ω–∏–∏'} –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
    }
  }
};

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò ==========
const NotificationManager = {
  save() {
    localStorage.setItem('notifications', JSON.stringify(CalendarApp.notificationsList));
    this.updatePanel();
    this.updateBadge();
  },
  
  addToList(title, message, type = 'success', bookingId = null) {
    const notification = {
      id: Date.now(),
      title,
      message,
      type,
      time: new Date().toISOString(),
      read: false,
      bookingId
    };
    
    CalendarApp.notificationsList.unshift(notification);
    if (CalendarApp.notificationsList.length > 50) {
      CalendarApp.notificationsList = CalendarApp.notificationsList.slice(0, 50);
    }
    
    this.save();
  },
  
  updateBadge() {
    const badge = document.getElementById('notifications-badge');
    if (!badge) return;
    
    const unreadCount = CalendarApp.notificationsList.filter(n => !n.read).length;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  },
  
  updatePanel() {
    const panelBody = document.getElementById('notifications-panel-body');
    if (!panelBody) return;
    
    if (CalendarApp.notificationsList.length === 0) {
      panelBody.innerHTML = '<div class="notifications-panel-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
      return;
    }
    
    const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
    const iconColors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
    
    panelBody.innerHTML = CalendarApp.notificationsList.map(notif => {
      const date = new Date(notif.time);
      const timeStr = date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}" data-booking-id="${notif.bookingId || ''}">
          <div class="notification-item-icon" style="color: ${iconColors[notif.type] || iconColors.success}">
            ${icons[notif.type] || icons.success}
          </div>
          <div class="notification-item-content">
            <div class="notification-item-title">${notif.title}</div>
            <div class="notification-item-message">${notif.message}</div>
            <div class="notification-item-time">${timeStr}</div>
          </div>
          <button class="notification-item-close" data-notification-id="${notif.id}">√ó</button>
        </div>
      `;
    }).join('');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    panelBody.querySelectorAll('.notification-item-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        const notifId = parseInt(closeBtn.dataset.notificationId);
        if (notifId) {
          NotificationManager.remove(notifId);
        }
      });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    panelBody.querySelectorAll('.notification-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.classList.contains('notification-item-close')) return;
        const notifId = parseInt(item.dataset.id);
        const notification = CalendarApp.notificationsList.find(n => n.id === notifId);
        this.markAsRead(notifId);
        
        if (notification && notification.bookingId) {
          BookingModal.openById(notification.bookingId);
        }
      });
    });
  },
  
  markAsRead(id) {
    const notification = CalendarApp.notificationsList.find(n => n.id === id);
    if (notification && !notification.read) {
      notification.read = true;
      this.save();
    }
  },
  
  remove(id) {
    CalendarApp.notificationsList = CalendarApp.notificationsList.filter(n => n.id !== id);
    this.save();
  },
  
  show(title, message, type = 'success', bookingId = null) {
    this.addToList(title, message, type, bookingId);
    
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
    
    notification.innerHTML = `
      <div class="notification-icon">${icons[type] || icons.success}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('hiding');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 5000);
  }
};

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ò–ó–ê–ô–ù–û–ú ==========
const DesignManager = {
  apply(design) {
    if (!design) return;

    const style = document.createElement('style');
    style.id = 'salon-custom-design';

    const primaryColor = design.primaryColor || '#f973b6';
    const secondaryColor = design.secondaryColor || '#a855f7';
    const headerBg = design.headerBg || '#f973b6';
    const cardBg = design.cardBg || '#ffffff';
    const textColor = design.textColor || '#222222';
    const buttonTextColor = design.buttonTextColor || '#ffffff';
    const pageBg = design.pageBg || '#f7f7fb';
    const pageBgType = design.pageBgType || 'color';
    const pageBgSecondary = design.pageBgSecondary || '#ffffff';
    const pageBgImage = design.pageBgImage || '';

    const isLightBg = this.isLightColor(cardBg);
    const finalTextColor = isLightBg ? textColor : '#ffffff';

    let bodyBg = pageBg;
    if (pageBgType === 'gradient') {
      bodyBg = `linear-gradient(135deg, ${pageBg}, ${pageBgSecondary})`;
    } else if (pageBgType === 'image' && pageBgImage) {
      bodyBg = `url(${pageBgImage}) center/cover no-repeat`;
    }

    if (design.logo) {
      const header = document.querySelector('header');
      const headerTitle = header ? header.querySelector('h1') : null;
      let logoImg = header ? header.querySelector('img.logo-img') : null;
      
      if (!logoImg && header && headerTitle) {
        logoImg = document.createElement('img');
        logoImg.src = design.logo;
        logoImg.className = 'logo-img';
        logoImg.alt = '–õ–æ–≥–æ—Ç–∏–ø —Å–∞–ª–æ–Ω–∞';
        logoImg.style.cssText = 'max-height: 80px; max-width: 200px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; object-fit: contain;';
        header.insertBefore(logoImg, headerTitle);
      } else if (logoImg) {
        logoImg.src = design.logo;
        logoImg.style.display = 'block';
      }
    } else {
      const logoImg = document.querySelector('header img.logo-img');
      if (logoImg) logoImg.remove();
    }

    style.textContent = `
      html { 
        background: ${bodyBg} !important; 
        min-height: 100% !important;
      }
      body { 
        background: transparent !important; 
        min-height: 100% !important;
      }
      @media (max-width: 768px) {
        html { background: ${bodyBg} !important; }
        body { background: transparent !important; }
      }
      @media (max-width: 480px) {
        html { background: ${bodyBg} !important; }
        body { background: transparent !important; }
      }
      header { 
        background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important; 
        position: relative !important;
        background-attachment: scroll !important;
      }
      @media (max-width: 768px) {
        header { background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important; }
      }
      @media (max-width: 480px) {
        header { background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important; }
      }
      .card { background: ${cardBg} !important; color: ${finalTextColor} !important; }
      .card * { color: inherit !important; }
      .card h2, .card h3, .card h4, .card h5, .card h6 { color: ${finalTextColor} !important; }
      .card p, .card .description, .card .note, .card div, .card span:not(.price) { color: ${finalTextColor} !important; }
      .card label { color: ${finalTextColor} !important; }
      .btn-primary { background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important; color: ${buttonTextColor} !important; }
      .btn-primary:hover { background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important; filter: brightness(1.1); color: ${buttonTextColor} !important; }
      input:focus, select:focus, textarea:focus { border-color: ${primaryColor} !important; box-shadow: 0 0 0 1px rgba(${this.hexToRgb(primaryColor)}, 0.35) !important; }
      input, select, textarea { color: ${finalTextColor} !important; background: ${isLightBg ? '#f9fafb' : 'rgba(255, 255, 255, 0.1)'} !important; }
      input::placeholder, textarea::placeholder { color: ${isLightBg ? '#9ca3af' : 'rgba(255, 255, 255, 0.6)'} !important; }
    `;

    const oldStyle = document.getElementById('salon-custom-design');
    if (oldStyle) oldStyle.remove();
    document.head.appendChild(style);
  },

  isLightColor(hex) {
    const rgb = this.hexToRgbArray(hex);
    if (!rgb) return true;
    const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
    return brightness > 128;
  },

  hexToRgbArray(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
      parseInt(result[1], 16),
      parseInt(result[2], 16),
      parseInt(result[3], 16)
    ] : null;
  },

  hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
      `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
      : '249, 115, 182';
  }
};

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–í–ò–ì–ê–¶–ò–ï–ô ==========
const NavigationManager = {
  update(user) {
    const salonPageLink = document.getElementById('salon-page-link');
    if (salonPageLink && user && user.id) {
      salonPageLink.href = `/booking?userId=${user.id}`;
    }
    
    const usersLink = document.getElementById('users-link');
    const isAdmin = user.role === 'admin' || user.username === 'admin';
    if (usersLink) {
      if (isAdmin) {
        usersLink.classList.add('show');
      } else {
        usersLink.classList.remove('show');
      }
    }
    
    this.highlightActivePage();
  },
  
  highlightActivePage() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-links a, .header-top-links a');
    
    navLinks.forEach(link => {
      if (link.id === 'logout-link' || link.href === '#' || !link.href) {
        return;
      }
      
      try {
        const linkPath = new URL(link.href, window.location.origin).pathname;
        const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
        const normalizedLink = linkPath.replace(/\/$/, '') || '/';
        
        if (normalizedLink === normalizedCurrent) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      } catch (e) {
        const href = link.getAttribute('href');
        if (href && (href === currentPath || href.replace(/\/$/, '') === currentPath.replace(/\/$/, ''))) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      }
    });
  }
};

// ========== –ü–†–û–í–ï–†–ö–ê –ù–û–í–´–• –ó–ê–ü–ò–°–ï–ô ==========
const BookingChecker = {
  async check() {
    try {
      const bookingsResult = await API.getBookings();
      
      if (bookingsResult.success && bookingsResult.bookings) {
        const currentBookings = bookingsResult.bookings;
        
        const newBookings = currentBookings.filter(booking => {
          const bookingId = String(booking.id);
          if (!CalendarApp.knownBookingIds.has(bookingId)) {
            CalendarApp.knownBookingIds.add(bookingId);
            return true;
          }
          return false;
        });
        
        if (newBookings.length > 0 && (Date.now() - CalendarApp.lastBookingCheck) > 2000) {
          newBookings.forEach(booking => {
            const date = new Date(booking.date);
            const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            NotificationManager.show(
              '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å!',
              `${booking.name} - ${booking.service} –Ω–∞ ${dateStr} –≤ ${booking.time}`,
              'info',
              booking.id
            );
          });
        }
        
        CalendarApp.lastBookingCheck = Date.now();
        CalendarApp.bookings = currentBookings;
        CalendarRenderer.render();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π:', error);
    }
  },
  
  start() {
    setTimeout(() => {
      if (CalendarApp.bookings && Array.isArray(CalendarApp.bookings)) {
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (' + CalendarApp.bookings.length + ' –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –∏–Ω—Ç–µ—Ä–≤–∞–ª: 30 —Å–µ–∫—É–Ω–¥)');
      } else {
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (0 –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –∏–Ω—Ç–µ—Ä–≤–∞–ª: 30 —Å–µ–∫—É–Ω–¥)');
      }
      setInterval(() => this.check(), 30000);
    }, 2000);
  }
};

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', () => {
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  DataLoader.loadAll();
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  document.getElementById('prev-week')?.addEventListener('click', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ currentWeekStart –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!CalendarApp.currentWeekStart) {
      CalendarApp.currentWeekStart = Utils.getWeekStart(new Date());
    }
    CalendarApp.currentWeekStart.setDate(CalendarApp.currentWeekStart.getDate() - 7);
    CalendarRenderer.render();
  });

  document.getElementById('next-week')?.addEventListener('click', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ currentWeekStart –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!CalendarApp.currentWeekStart) {
      CalendarApp.currentWeekStart = Utils.getWeekStart(new Date());
    }
    CalendarApp.currentWeekStart.setDate(CalendarApp.currentWeekStart.getDate() + 7);
    CalendarRenderer.render();
  });

  document.getElementById('calendar-master-filter')?.addEventListener('change', () => {
    CalendarRenderer.render();
  });

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ currentWeekStart –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
      if (!CalendarApp.currentWeekStart) {
        CalendarApp.currentWeekStart = Utils.getWeekStart(new Date());
      }
      CalendarRenderer.render();
    }, 250);
  });

  document.getElementById('create-booking-btn')?.addEventListener('click', () => {
    BookingModal.openNewForm();
  });

  document.getElementById('calendar-grid')?.addEventListener('click', (e) => {
    const target = e.target.closest(".cal-slot");
    if (!target) return;
    
    if (target.classList.contains("cal-slot-busy")) {
      const idx = target.dataset.bookingIndex;
      if (idx !== undefined) {
        BookingModal.open(Number(idx));
      }
    } else if (target.classList.contains("cal-slot-free")) {
      const date = target.dataset.date;
      const hour = parseInt(target.dataset.hour);
      if (date && !isNaN(hour)) {
        BookingModal.openNewForm(date, hour);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  document.getElementById('modal-close')?.addEventListener('click', () => BookingModal.close());
  document.getElementById('booking-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'booking-modal') BookingModal.close();
  });

  document.getElementById('modal-prev-booking')?.addEventListener('click', () => {
    if (CalendarApp.currentBookingIndex > 0) {
      CalendarApp.currentBookingIndex--;
      const booking = CalendarApp.sameTimeBookings[CalendarApp.currentBookingIndex];
      BookingModal.displayBooking(booking);
      BookingModal.updateBookingsNavigation();
      BookingModal.renderOtherBookingsList();
    }
  });

  document.getElementById('modal-next-booking')?.addEventListener('click', () => {
    if (CalendarApp.currentBookingIndex < CalendarApp.sameTimeBookings.length - 1) {
      CalendarApp.currentBookingIndex++;
      const booking = CalendarApp.sameTimeBookings[CalendarApp.currentBookingIndex];
      BookingModal.displayBooking(booking);
      BookingModal.updateBookingsNavigation();
      BookingModal.renderOtherBookingsList();
    }
  });

  document.getElementById('edit-booking-btn')?.addEventListener('click', () => {
    if (CalendarApp.currentEditingBookingId) {
      BookingModal.openEditForm(CalendarApp.currentEditingBookingId);
    }
  });

  document.getElementById('delete-booking-btn')?.addEventListener('click', async () => {
    if (!CalendarApp.currentEditingBookingId) return;
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
      return;
    }
    
    try {
      const result = await API.deleteBooking(CalendarApp.currentEditingBookingId);
      if (result.success) {
        NotificationManager.show('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è', 'info');
        
        setTimeout(async () => {
          const bookingsResult = await API.getBookings();
          if (bookingsResult.success) {
            CalendarApp.bookings = bookingsResult.bookings;
            CalendarRenderer.render();
          }
          BookingModal.close();
        }, 500);
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  document.getElementById('cancel-booking-form')?.addEventListener('click', () => BookingModal.close());

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º—ã
  document.getElementById('new-booking-service')?.addEventListener('change', () => BookingForm.generateSlots());
  document.getElementById('new-booking-date')?.addEventListener('change', () => BookingForm.generateSlots());
  document.getElementById('new-booking-master')?.addEventListener('change', () => BookingForm.generateSlots());

  document.getElementById('new-booking-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await BookingForm.submit();
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  document.getElementById('logout-link')?.addEventListener('click', async (e) => {
    e.preventDefault();
    await API.logout();
    window.location.href = '/';
  });

  document.getElementById('notifications-icon')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        CalendarApp.notificationsList.forEach(n => n.read = true);
        NotificationManager.save();
      }
    }
  });

  document.getElementById('notifications-panel-close')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.remove('open');
    }
  });

  document.getElementById('notifications-clear-all')?.addEventListener('click', () => {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')) {
      CalendarApp.notificationsList = [];
      NotificationManager.save();
    }
  });

  document.addEventListener('click', (e) => {
    const panel = document.getElementById('notifications-panel');
    const icon = document.getElementById('notifications-icon');
    if (panel && icon && !panel.contains(e.target) && !icon.contains(e.target)) {
      panel.classList.remove('open');
    }
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  NotificationManager.updatePanel();
  NotificationManager.updateBadge();
  
  // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
  BookingChecker.start();
});
</script>
</body>
</html>

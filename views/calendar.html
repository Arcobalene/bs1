<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Календарь — Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <h1>Beauty Studio</h1>
  <p>Календарь записей</p>
  <div class="nav-links">
    <a href="/" id="salon-page-link">Страница салона</a>
    <a href="/admin">Админ-панель</a>
    <a href="#" id="logout-link">Выход</a>
  </div>
</header>

<div class="container">
  <div class="card admin-calendar-card">
    <h2>Календарь записей</h2>
    <p class="description">Недельный вид расписания по часам. Можно перелистывать недели и фильтровать по мастеру.</p>

    <div class="form-row" style="margin-bottom: 8px;">
      <div>
        <label for="calendar-master-filter">Календарь мастера</label>
        <select id="calendar-master-filter">
          <option value="">Общий календарь (все мастера)</option>
        </select>
        <p class="note">Выберите конкретного мастера, чтобы посмотреть его личное расписание.</p>
      </div>
      <div>
        <label>Неделя</label>
        <div class="week-controls">
          <button type="button" id="prev-week">‹ Предыдущая неделя</button>
          <div id="week-label"></div>
          <button type="button" id="next-week">Следующая неделя ›</button>
        </div>
      </div>
    </div>

    <div id="calendar-grid" class="calendar-grid"></div>
  </div>
</div>

<div id="booking-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Запись клиента</div>
      <button type="button" id="modal-close" class="modal-close">×</button>
    </div>
    <div class="modal-body" id="modal-body-view">
      <p><strong>Клиент:</strong> <span id="modal-client-name"></span></p>
      <p><strong>Телефон:</strong> <span id="modal-client-phone"></span></p>
      <p>
        <span class="badge badge-service" id="modal-service"></span>
        <span class="badge badge-master" id="modal-master"></span>
      </p>
      <p><strong>Дата:</strong> <span id="modal-date"></span></p>
      <p><strong>Время:</strong> <span id="modal-time"></span></p>
      <p><strong>Комментарий:</strong></p>
      <p id="modal-comment"></p>
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button type="button" class="btn-primary" id="edit-booking-btn">Редактировать</button>
        <button type="button" class="btn-secondary" id="delete-booking-btn" style="background: #ef4444; color: white;">Удалить</button>
      </div>
    </div>
    <div class="modal-body" id="modal-body-form" style="display: none;">
      <form id="new-booking-form">
        <div>
          <label for="new-booking-name">Имя клиента *</label>
          <input type="text" id="new-booking-name" required />
        </div>
        <div>
          <label for="new-booking-phone">Телефон *</label>
          <input type="tel" id="new-booking-phone" placeholder="+998XX XXX XX XX" required />
        </div>
        <div>
          <label for="new-booking-service">Услуга *</label>
          <select id="new-booking-service" required>
            <option value="">Выберите услугу</option>
          </select>
        </div>
        <div>
          <label for="new-booking-master">Мастер</label>
          <select id="new-booking-master">
            <option value="">Любой мастер</option>
          </select>
        </div>
        <div>
          <label for="new-booking-date">Дата *</label>
          <input type="date" id="new-booking-date" required />
        </div>
        <div>
          <label for="new-booking-time">Время *</label>
          <input type="time" id="new-booking-time" required />
        </div>
        <div>
          <label for="new-booking-comment">Комментарий</label>
          <textarea id="new-booking-comment" rows="3"></textarea>
        </div>
        <div id="new-booking-alert" style="display: none; margin-top: 12px;"></div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="submit" class="btn-primary" id="booking-form-submit">Создать запись</button>
          <button type="button" class="btn-secondary" id="cancel-booking-form">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  © 2025 Beauty Studio. Все права защищены.
</footer>

<script>
  let bookings = [];
  let masters = [];
  let services = [];
  let currentUser = null;
  let currentWeekStart = null;
  const WEEK_DAYS = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];

  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function dateToISO(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  async function loadData() {
    try {
      // Проверка авторизации
      const userRes = await fetch('/api/user');
      const userResult = await userRes.json();
      if (!userResult.success) {
        window.location.href = '/login';
        return;
      }

      currentUser = userResult.user;
      
      // Обновляем ссылку "Страница салона" в навигации
      const salonPageLink = document.getElementById('salon-page-link');
      if (salonPageLink && currentUser && currentUser.id) {
        salonPageLink.href = `/?userId=${currentUser.id}`;
      }

      // Загрузка записей
      const bookingsRes = await fetch('/api/bookings');
      const bookingsResult = await bookingsRes.json();
      if (bookingsResult.success) {
        bookings = bookingsResult.bookings;
        console.log('Загружено записей:', bookings.length);
        if (bookings.length > 0) {
          console.log('Пример записи:', bookings[0]);
        }
        
        // Проверяем, есть ли в URL параметр bookingId
        const urlParams = new URLSearchParams(window.location.search);
        const bookingIdParam = urlParams.get('bookingId');
        if (bookingIdParam) {
          const bookingId = parseInt(bookingIdParam);
          // Удаляем параметр из URL
          window.history.replaceState({}, document.title, window.location.pathname);
          // Открываем запись
          openBookingById(bookingId);
        }
      } else {
        console.error('Ошибка загрузки записей:', bookingsResult);
      }

      // Загрузка мастеров
      masters = currentUser.masters || [];
      
      // Загрузка услуг
      if (currentUser.id) {
        const servicesRes = await fetch(`/api/services/${currentUser.id}`);
        const servicesResult = await servicesRes.json();
        if (servicesResult.success) {
          services = servicesResult.services;
        }
      }
      
      renderMasterFilter();
      renderCalendar();
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
      window.location.href = '/login';
    }
  }
  
  // Обертка для loadData, чтобы она возвращала Promise
  function loadDataPromise() {
    return loadData();
  }

  function renderMasterFilter() {
    const filter = document.getElementById('calendar-master-filter');
    if (!filter) return;

    const currentValue = filter.value;
    filter.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'Общий календарь (все мастера)';
    filter.appendChild(allOpt);
    masters.forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      filter.appendChild(opt);
    });
    filter.value = currentValue || '';
  }

  function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    if (!currentWeekStart) {
      currentWeekStart = getWeekStart(new Date());
    }

    const startHour = 10;
    const endHour = 20;

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(currentWeekStart);
      d.setDate(d.getDate() + i);
      weekDates.push(d);
    }

    const weekLabel = document.getElementById('week-label');
    if (weekLabel) {
      const fmt = (d) => {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      };
      weekLabel.textContent = `${fmt(weekDates[0])} – ${fmt(weekDates[6])}`;
    }

    grid.style.gridTemplateColumns = "80px repeat(7, 1fr)";
    grid.innerHTML = "";

    const emptyHeader = document.createElement("div");
    emptyHeader.className = "cal-cell cal-header cal-corner";
    grid.appendChild(emptyHeader);

    weekDates.forEach((d, idx) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-header cal-day-header";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      cell.textContent = `${WEEK_DAYS[idx]} ${dd}.${mm}`;
      grid.appendChild(cell);
    });

    const selectedMaster = document.getElementById('calendar-master-filter')?.value || "";

    for (let hour = startHour; hour < endHour; hour++) {
      const hourCell = document.createElement("div");
      hourCell.className = "cal-cell cal-hour-label";
      hourCell.textContent = `${String(hour).padStart(2, "0")}:00`;
      grid.appendChild(hourCell);

      weekDates.forEach((d) => {
        const cell = document.createElement("div");
        cell.className = "cal-cell cal-slot";
        const iso = dateToISO(d);

        const bookingsForCell = bookings.filter((b) => {
          if (b.date !== iso) return false;
          if (selectedMaster && b.master !== selectedMaster) return false;
          const startM = timeToMinutes(b.time);
          if (startM === null) return false;
          // Если endTime не указан, считаем что запись занимает 1 час
          const endM = b.endTime ? timeToMinutes(b.endTime) : (startM + 60);
          if (endM === null) return false;
          const cellStart = hour * 60;
          const cellEnd = (hour + 1) * 60;
          return startM < cellEnd && endM > cellStart;
        });

        if (bookingsForCell.length) {
          cell.classList.add("cal-slot-busy");
          const b = bookingsForCell[0];
          const parts = [];
          if (b.time && b.endTime) parts.push(`${b.time}-${b.endTime}`);
          if (b.service) parts.push(b.service);
          if (b.master) parts.push(b.master);
          cell.textContent = parts.join(" · ");
          const bookingIndex = bookings.indexOf(b);
          if (bookingIndex !== -1) {
            cell.dataset.bookingIndex = String(bookingIndex);
            cell.style.cursor = "pointer";
          }
        } else {
          // Свободный слот - можно создать запись
          cell.classList.add("cal-slot-free");
          cell.dataset.date = iso;
          cell.dataset.hour = String(hour);
          cell.style.cursor = "pointer";
          cell.title = "Кликните, чтобы создать запись";
        }

        grid.appendChild(cell);
      });
    }
  }

  let currentEditingBookingId = null; // ID записи, которую редактируем

  function openBookingModal(index) {
    const modal = document.getElementById('booking-modal');
    if (!modal) return;
    const booking = bookings[index];
    if (!booking) return;

    currentEditingBookingId = booking.id; // Сохраняем ID для редактирования

    document.getElementById('modal-client-name').textContent = booking.name || "—";
    document.getElementById('modal-client-phone').textContent = booking.phone || "—";
    document.getElementById('modal-service').textContent = booking.service || "—";
    document.getElementById('modal-master').textContent = booking.master || "Любой мастер";
    document.getElementById('modal-date').textContent = booking.date || "—";
    if (booking.time && booking.endTime) {
      document.getElementById('modal-time').textContent = `${booking.time}–${booking.endTime}`;
    } else {
      document.getElementById('modal-time').textContent = booking.time || "—";
    }
    document.getElementById('modal-comment').textContent = booking.comment || "Нет комментария";

    // Показываем модальное окно просмотра, скрываем форму
    document.getElementById('modal-body-view').style.display = 'block';
    document.getElementById('modal-body-form').style.display = 'none';
    document.getElementById('modal-title').textContent = 'Запись клиента';
    
    modal.classList.remove("hidden");
  }
  
  function openEditBookingForm(bookingId) {
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) return;

    currentEditingBookingId = bookingId;

    document.getElementById('modal-title').textContent = 'Редактировать запись';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';

    // Заполняем форму данными записи
    document.getElementById('new-booking-name').value = booking.name || '';
    document.getElementById('new-booking-phone').value = booking.phone || '';
    document.getElementById('new-booking-date').value = booking.date || '';
    document.getElementById('new-booking-time').value = booking.time || '';
    document.getElementById('new-booking-comment').value = booking.comment || '';

    // Заполняем услуги
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} сум, ${s.duration} мин)`;
      opt.selected = s.name === booking.service;
      serviceSelect.appendChild(opt);
    });

    // Заполняем мастеров
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">Любой мастер</option>';
    masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      opt.selected = m.name === booking.master;
      masterSelect.appendChild(opt);
    });

    // Меняем текст кнопки
    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) {
      submitBtn.textContent = 'Сохранить изменения';
    }
  }
  
  // Функция для открытия записи по ID
  function openBookingById(bookingId) {
    const index = bookings.findIndex(b => b.id === bookingId);
    if (index !== -1) {
      // Переключаемся на неделю с этой записью
      const booking = bookings[index];
      if (booking.date) {
        const bookingDate = new Date(booking.date);
        currentWeekStart = getWeekStart(bookingDate);
        renderCalendar();
      }
      // Открываем модальное окно
      setTimeout(() => {
        openBookingModal(index);
      }, 100);
    } else {
      // Если запись не найдена, перезагружаем данные
      loadDataPromise().then(() => {
        const newIndex = bookings.findIndex(b => b.id === bookingId);
        if (newIndex !== -1) {
          const booking = bookings[newIndex];
          if (booking.date) {
            const bookingDate = new Date(booking.date);
            currentWeekStart = getWeekStart(bookingDate);
            renderCalendar();
          }
          setTimeout(() => {
            openBookingModal(newIndex);
          }, 100);
        }
      });
    }
  }

  function closeBookingModal() {
    const modal = document.getElementById('booking-modal');
    if (modal) {
      modal.classList.add("hidden");
      // Сбрасываем форму
      document.getElementById('modal-body-view').style.display = 'block';
      document.getElementById('modal-body-form').style.display = 'none';
      document.getElementById('new-booking-form').reset();
      document.getElementById('new-booking-alert').style.display = 'none';
      currentEditingBookingId = null;
      // Возвращаем текст кнопки
      const submitBtn = document.getElementById('booking-form-submit');
      if (submitBtn) {
        submitBtn.textContent = 'Создать запись';
      }
    }
  }

  function openNewBookingForm(date, hour) {
    const modal = document.getElementById('booking-modal');
    if (!modal || !currentUser) return;
    
    currentEditingBookingId = null; // Сбрасываем ID редактирования
    
    document.getElementById('modal-title').textContent = 'Создать новую запись';
    document.getElementById('modal-body-view').style.display = 'none';
    document.getElementById('modal-body-form').style.display = 'block';
    
    // Сбрасываем форму
    document.getElementById('new-booking-form').reset();
    
    // Заполняем дату и время
    document.getElementById('new-booking-date').value = date;
    document.getElementById('new-booking-time').value = `${String(hour).padStart(2, '0')}:00`;
    
    // Заполняем услуги
    const serviceSelect = document.getElementById('new-booking-service');
    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (${s.price.toLocaleString('ru-RU')} сум, ${s.duration} мин)`;
      serviceSelect.appendChild(opt);
    });
    
    // Заполняем мастеров
    const masterSelect = document.getElementById('new-booking-master');
    masterSelect.innerHTML = '<option value="">Любой мастер</option>';
    masters.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      masterSelect.appendChild(opt);
    });
    
    // Меняем текст кнопки
    const submitBtn = document.getElementById('booking-form-submit');
    if (submitBtn) {
      submitBtn.textContent = 'Создать запись';
    }
    
    modal.classList.remove("hidden");
  }

  // Слушатели событий
  document.getElementById('prev-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderCalendar();
  });

  document.getElementById('next-week')?.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderCalendar();
  });

  document.getElementById('calendar-master-filter')?.addEventListener('change', renderCalendar);

  document.getElementById('calendar-grid')?.addEventListener('click', (e) => {
    const target = e.target.closest(".cal-slot");
    if (!target) return;
    
    // Если это занятый слот - показываем информацию о записи
    if (target.classList.contains("cal-slot-busy")) {
      const idx = target.dataset.bookingIndex;
      if (idx !== undefined) {
        openBookingModal(Number(idx));
      }
    }
    // Если это свободный слот - открываем форму создания записи
    else if (target.classList.contains("cal-slot-free")) {
      const date = target.dataset.date;
      const hour = parseInt(target.dataset.hour);
      if (date && !isNaN(hour)) {
        openNewBookingForm(date, hour);
      }
    }
  });

  document.getElementById('modal-close')?.addEventListener('click', closeBookingModal);
  document.getElementById('booking-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'booking-modal') closeBookingModal();
  });

  document.getElementById('logout-link')?.addEventListener('click', async (e) => {
    e.preventDefault();
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = '/login';
  });

  // Обработчик формы создания/редактирования записи
  document.getElementById('new-booking-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const alert = document.getElementById('new-booking-alert');
    alert.style.display = 'none';
    
    const formData = {
      userId: currentUser.id,
      name: document.getElementById('new-booking-name').value.trim(),
      phone: document.getElementById('new-booking-phone').value.trim(),
      service: document.getElementById('new-booking-service').value,
      master: document.getElementById('new-booking-master').value,
      date: document.getElementById('new-booking-date').value,
      time: document.getElementById('new-booking-time').value,
      comment: document.getElementById('new-booking-comment').value.trim()
    };
    
    if (!formData.name || !formData.phone || !formData.service || !formData.date || !formData.time) {
      alert.textContent = 'Заполните все обязательные поля';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    const phoneDigits = formData.phone.replace(/\D/g, '');
    if (phoneDigits.length < 9) {
      alert.textContent = 'Некорректный номер телефона (минимум 9 цифр)';
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
      return;
    }
    
    // Вычисляем endTime на основе услуги
    const selectedService = services.find(s => s.name === formData.service);
    if (selectedService && selectedService.duration) {
      const [hours, minutes] = formData.time.split(':').map(Number);
      const startMinutes = hours * 60 + minutes;
      const endMinutes = startMinutes + selectedService.duration;
      const endHours = Math.floor(endMinutes / 60);
      const endMins = endMinutes % 60;
      formData.endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
    }
    
    const isEditing = currentEditingBookingId !== null;
    
    try {
      const url = isEditing ? `/api/bookings/${currentEditingBookingId}` : '/api/bookings';
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      if (result.success) {
        alert.textContent = isEditing ? 'Запись успешно обновлена!' : 'Запись успешно создана!';
        alert.className = 'alert alert-success';
        alert.style.display = 'block';
        
        // Показываем push-уведомление
        const date = new Date(formData.date);
        const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        const bookingId = isEditing ? currentEditingBookingId : (result.booking?.id || null);
        showNotification(
          isEditing ? 'Запись обновлена!' : 'Запись создана!',
          `${formData.name} - ${formData.service} на ${dateStr} в ${formData.time}`,
          'success',
          bookingId
        );
        
        // Обновляем данные и календарь
        setTimeout(async () => {
          const bookingsRes = await fetch('/api/bookings');
          const bookingsResult = await bookingsRes.json();
          if (bookingsResult.success) {
            bookings = bookingsResult.bookings;
            lastBookingCount = bookings.length;
            renderCalendar();
          }
          closeBookingModal();
        }, 1000);
      } else {
        alert.textContent = result.message || (isEditing ? 'Ошибка при обновлении записи' : 'Ошибка при создании записи');
        alert.className = 'alert alert-error';
        alert.style.display = 'block';
      }
    } catch (error) {
      console.error(`Ошибка ${isEditing ? 'обновления' : 'создания'} записи:`, error);
      alert.textContent = `Ошибка при ${isEditing ? 'обновлении' : 'создании'} записи. Попробуйте позже.`;
      alert.className = 'alert alert-error';
      alert.style.display = 'block';
    }
  });
  
  // Обработчик кнопки "Редактировать"
  document.getElementById('edit-booking-btn')?.addEventListener('click', () => {
    if (currentEditingBookingId) {
      openEditBookingForm(currentEditingBookingId);
    }
  });
  
  // Обработчик кнопки "Удалить"
  document.getElementById('delete-booking-btn')?.addEventListener('click', async () => {
    if (!currentEditingBookingId) return;
    
    if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/bookings/${currentEditingBookingId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      if (result.success) {
        showNotification('Запись удалена', 'Запись успешно удалена из календаря', 'info');
        
        // Обновляем данные и календарь
        setTimeout(async () => {
          const bookingsRes = await fetch('/api/bookings');
          const bookingsResult = await bookingsRes.json();
          if (bookingsResult.success) {
            bookings = bookingsResult.bookings;
            lastBookingCount = bookings.length;
            renderCalendar();
          }
          closeBookingModal();
        }, 500);
      } else {
        alert('Ошибка при удалении записи: ' + (result.message || 'Неизвестная ошибка'));
      }
    } catch (error) {
      console.error('Ошибка удаления записи:', error);
      alert('Ошибка при удалении записи. Попробуйте позже.');
    }
  });

  document.getElementById('cancel-booking-form')?.addEventListener('click', closeBookingModal);

  // Загружаем данные при загрузке страницы
  loadData();
</script>

<!-- Контейнер для push-уведомлений -->
<div class="notification-container" id="notification-container"></div>

<!-- Иконка уведомлений -->
<div class="notifications-icon" id="notifications-icon">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25-2.5 7-2.5 7h15s-2.5-1.75-2.5-7c0-3.87-3.13-7-7-7zm0 2c2.76 0 5 2.24 5 5 0 2.88 2.88 4.5 2.88 4.5H4.12S7 11.88 7 9c0-2.76 2.24-5 5-5zm-1 15h2v2h-2v-2z"/>
  </svg>
  <div class="notifications-badge hidden" id="notifications-badge">0</div>
</div>

<!-- Панель уведомлений -->
<div class="notifications-panel" id="notifications-panel">
  <div class="notifications-panel-header">
    <div class="notifications-panel-title">Уведомления</div>
    <button class="notifications-panel-close" id="notifications-panel-close">×</button>
  </div>
  <div class="notifications-panel-body" id="notifications-panel-body">
    <div class="notifications-panel-empty">Нет уведомлений</div>
  </div>
  <div class="notifications-panel-footer">
    <button class="notifications-clear-all" id="notifications-clear-all">Очистить все</button>
  </div>
</div>

<script>
  // Хранилище уведомлений
  let notificationsList = JSON.parse(localStorage.getItem('notifications') || '[]');
  
  // Функция для сохранения уведомлений в localStorage
  function saveNotifications() {
    localStorage.setItem('notifications', JSON.stringify(notificationsList));
    updateNotificationsPanel();
    updateNotificationsBadge();
  }
  
  // Функция для добавления уведомления в список
  function addNotificationToList(title, message, type = 'success', bookingId = null) {
    const notification = {
      id: Date.now(),
      title,
      message,
      type,
      time: new Date().toISOString(),
      read: false,
      bookingId: bookingId // ID записи для перехода
    };
    
    notificationsList.unshift(notification); // Добавляем в начало
    // Ограничиваем количество уведомлений (последние 50)
    if (notificationsList.length > 50) {
      notificationsList = notificationsList.slice(0, 50);
    }
    
    saveNotifications();
  }
  
  // Функция для обновления счетчика уведомлений
  function updateNotificationsBadge() {
    const badge = document.getElementById('notifications-badge');
    if (!badge) return;
    
    const unreadCount = notificationsList.filter(n => !n.read).length;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }
  
  // Функция для обновления панели уведомлений
  function updateNotificationsPanel() {
    const panelBody = document.getElementById('notifications-panel-body');
    if (!panelBody) return;
    
    if (notificationsList.length === 0) {
      panelBody.innerHTML = '<div class="notifications-panel-empty">Нет уведомлений</div>';
      return;
    }
    
    const icons = {
      success: '✓',
      error: '✕',
      warning: '⚠',
      info: 'ℹ'
    };
    
    const iconColors = {
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b',
      info: '#3b82f6'
    };
    
    panelBody.innerHTML = notificationsList.map(notif => {
      const date = new Date(notif.time);
      const timeStr = date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}">
          <div class="notification-item-icon" style="color: ${iconColors[notif.type] || iconColors.success}">
            ${icons[notif.type] || icons.success}
          </div>
          <div class="notification-item-content">
            <div class="notification-item-title">${notif.title}</div>
            <div class="notification-item-message">${notif.message}</div>
            <div class="notification-item-time">${timeStr}</div>
          </div>
          <button class="notification-item-close" onclick="removeNotification(${notif.id})">×</button>
        </div>
      `;
    }).join('');
    
    // Добавляем обработчики клика для отметки как прочитанное и перехода
    panelBody.querySelectorAll('.notification-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.classList.contains('notification-item-close')) return;
        const notifId = parseInt(item.dataset.id);
        const notification = notificationsList.find(n => n.id === notifId);
        markAsRead(notifId);
        
        // Если есть bookingId, открываем запись в календаре
        if (notification && notification.bookingId) {
          openBookingById(notification.bookingId);
        }
      });
    });
  }
  
  // Функция для отметки уведомления как прочитанного
  function markAsRead(id) {
    const notification = notificationsList.find(n => n.id === id);
    if (notification && !notification.read) {
      notification.read = true;
      saveNotifications();
    }
  }
  
  // Функция для удаления уведомления
  function removeNotification(id) {
    notificationsList = notificationsList.filter(n => n.id !== id);
    saveNotifications();
  }
  
  // Функция для показа push-уведомлений
  function showNotification(title, message, type = 'success', bookingId = null) {
    // Добавляем в список
    addNotificationToList(title, message, type, bookingId);
    
    // Показываем временное уведомление
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = {
      success: '✓',
      error: '✕',
      warning: '⚠',
      info: 'ℹ'
    };
    
    notification.innerHTML = `
      <div class="notification-icon">${icons[type] || icons.success}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    container.appendChild(notification);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
      notification.classList.add('hiding');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 5000);
  }
  
  // Обработчики для панели уведомлений
  document.getElementById('notifications-icon')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        // Отмечаем все как прочитанные при открытии
        notificationsList.forEach(n => n.read = true);
        saveNotifications();
      }
    }
  });
  
  document.getElementById('notifications-panel-close')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    if (panel) {
      panel.classList.remove('open');
    }
  });
  
  document.getElementById('notifications-clear-all')?.addEventListener('click', () => {
    if (confirm('Удалить все уведомления?')) {
      notificationsList = [];
      saveNotifications();
    }
  });
  
  // Закрытие панели при клике вне её
  document.addEventListener('click', (e) => {
    const panel = document.getElementById('notifications-panel');
    const icon = document.getElementById('notifications-icon');
    if (panel && icon && !panel.contains(e.target) && !icon.contains(e.target)) {
      panel.classList.remove('open');
    }
  });
  
  // Инициализация при загрузке страницы
  updateNotificationsPanel();
  updateNotificationsBadge();
  
  // Проверка новых записей каждые 30 секунд
  let lastBookingCount = 0;
  let lastBookingCheck = Date.now();
  
  async function checkNewBookings() {
    try {
      const bookingsRes = await fetch('/api/bookings');
      const bookingsResult = await bookingsRes.json();
      
      if (bookingsResult.success) {
        const currentCount = bookingsResult.bookings.length;
        
        // Если количество записей увеличилось и прошло больше 5 секунд с последней проверки
        if (currentCount > lastBookingCount && lastBookingCount > 0 && (Date.now() - lastBookingCheck) > 5000) {
          const newBookings = bookingsResult.bookings.slice(0, currentCount - lastBookingCount);
          
          newBookings.forEach(booking => {
            const date = new Date(booking.date);
            const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            showNotification(
              'Новая запись!',
              `${booking.name} - ${booking.service} на ${dateStr} в ${booking.time}`,
              'info',
              booking.id // Передаем ID записи
            );
          });
        }
        
        lastBookingCount = currentCount;
        lastBookingCheck = Date.now();
        bookings = bookingsResult.bookings;
        renderCalendar();
      }
    } catch (error) {
      console.error('Ошибка проверки новых записей:', error);
    }
  }
  
  // Инициализируем счетчик после загрузки данных
  setTimeout(() => {
    lastBookingCount = bookings.length;
    // Проверяем новые записи каждые 30 секунд
    setInterval(checkNewBookings, 30000);
  }, 2000);
</script>
</body>
</html>


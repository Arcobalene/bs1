<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Личный кабинет мастера — Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <div class="header-top-links">
    <a href="#" id="logout-link" class="logout-link" title="Выход">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 17v-3h-5v-4h5V7l5 5-5 5zM14 2a2 2 0 012 2v2h-2V4H5v16h11v-2h2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V4a2 2 0 012-2h9z"/>
      </svg>
    </a>
  </div>
  <h1>Beauty Studio</h1>
  <p>Личный кабинет мастера</p>
  <div class="nav-links">
    <a href="/" title="На главную" id="home-link-nav" style="display: none;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      Главная
    </a>
    <a href="/master" title="Мои салоны">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
      Мои салоны
    </a>
    <a href="/master/calendar" title="Мои записи">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Мои записи
    </a>
    <a href="/master/profile" title="Профиль мастера">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      Профиль
    </a>
  </div>
</header>

<div class="container">
  <div class="breadcrumbs">
    <a href="/" id="home-link-breadcrumb" style="display: none;">Главная</a>
    <span class="separator" id="breadcrumb-separator" style="display: none;">/</span>
    <span class="current">Личный кабинет мастера</span>
  </div>
  
  <div class="user-info">
    <h3 id="user-name">Загрузка...</h3>
    <p id="user-email"></p>
  </div>

  <!-- Главные вкладки -->
  <div class="main-tabs">
    <button class="main-tab-button active" data-main-tab="salons">Мои салоны</button>
    <button class="main-tab-button" data-main-tab="bookings">Записи</button>
    <button class="main-tab-button" data-main-tab="profile">Профиль</button>
  </div>

  <!-- Вкладка: Мои салоны -->
  <div class="main-tab-content active" id="salons-tab">
    <div class="card">
      <h2>Мои салоны</h2>
      <p class="description">Список салонов, где вы работаете</p>
      
      <div id="salons-list" style="margin-top: 16px;">
        <p style="text-align: center; color: #6b7280;">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- Вкладка: Записи -->
  <div class="main-tab-content" id="bookings-tab" style="display: none;">
    <div class="card">
      <h2>Мои записи</h2>
      <p class="description">Все ваши записи в салонах</p>
      
      <div id="bookings-list" style="margin-top: 16px;">
        <p style="text-align: center; color: #6b7280;">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- Вкладка: Профиль -->
  <div class="main-tab-content" id="profile-tab" style="display: none;">
    <div class="card">
      <h2>Профиль мастера</h2>
      <p class="description">Обновите информацию о себе</p>

      <form id="profile-form">
        <div>
          <label for="profile-email">Email</label>
          <input type="email" id="profile-email" placeholder="your@email.com" />
        </div>

        <div>
          <label for="profile-phone">Телефон</label>
          <input type="tel" id="profile-phone" placeholder="+998XX XXX XX XX" />
        </div>

        <button type="submit" class="btn-primary">Сохранить изменения</button>
        <div id="profile-alert" class="alert" style="display: none;"></div>
      </form>
    </div>

    <div class="card" style="margin-top: 24px;">
      <h2>Фото моих работ</h2>
      <p class="description">Загрузите фото ваших работ. Они будут отображаться на страницах салонов, где вы работаете.</p>

      <div style="margin-bottom: 16px;">
        <label for="photos-upload" style="display: inline-block; cursor: pointer;">
          <input type="file" id="photos-upload" multiple accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;" />
          <button type="button" class="btn-primary" onclick="document.getElementById('photos-upload').click();">
            Загрузить фото
          </button>
        </label>
        <span style="margin-left: 12px; color: #6b7280; font-size: 0.9rem;">Максимум 10 файлов, до 10 МБ каждый</span>
      </div>

      <div id="photos-loading" style="text-align: center; padding: 20px; display: none;">
        <p style="color: #6b7280;">Загрузка...</p>
      </div>

      <div id="photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
        <p style="text-align: center; color: #6b7280; grid-column: 1 / -1;">Загрузка фото...</p>
      </div>

      <div id="photos-alert" class="alert" style="display: none; margin-top: 16px;"></div>
    </div>
  </div>
</div>

<footer>
  © 2025 Beauty Studio. Все права защищены.
</footer>

<script>
  let currentUser = null;

  // Проверка авторизации и загрузка данных
  async function loadUserData() {
    try {
      const response = await fetch('/api/user');
      const result = await response.json();
      
      if (!result.success) {
        window.location.href = '/login';
        return;
      }

      currentUser = result.user;
      
      if (currentUser.role !== 'master') {
        window.location.href = '/admin';
        return;
      }

      // Скрываем ссылку "Главная" в навигации
      const homeLinkNav = document.getElementById('home-link-nav');
      if (homeLinkNav) homeLinkNav.style.display = 'none';
      
      // Скрываем ссылку "Главная" в breadcrumbs
      const homeLinkBreadcrumb = document.getElementById('home-link-breadcrumb');
      const breadcrumbSeparator = document.getElementById('breadcrumb-separator');
      if (homeLinkBreadcrumb) homeLinkBreadcrumb.style.display = 'none';
      if (breadcrumbSeparator) breadcrumbSeparator.style.display = 'none';

      document.getElementById('user-name').textContent = `Добро пожаловать, ${currentUser.username}!`;
      document.getElementById('user-email').textContent = currentUser.email || 'Email не указан';
      
      loadSalons();
      loadBookings();
      loadProfile();
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
      window.location.href = '/login';
    }
  }

  async function loadSalons() {
    try {
      const response = await fetch('/api/master/salons');
      const result = await response.json();
      
      if (result.success) {
        renderSalons(result.salons);
      }
    } catch (error) {
      console.error('Ошибка загрузки салонов:', error);
    }
  }

  function renderSalons(salons) {
    const list = document.getElementById('salons-list');
    if (!list) return;

    if (salons.length === 0) {
      list.innerHTML = '<p style="text-align: center; color: #6b7280;">Вы еще не добавлены ни в один салон. Ожидайте приглашения от владельца салона.</p>';
      return;
    }

    list.innerHTML = '';
    salons.forEach((salon) => {
      const item = document.createElement('div');
      item.className = 'admin-list-item';
      item.style.padding = '16px';
      item.style.marginBottom = '12px';
      item.style.border = '1px solid #e5e7eb';
      item.style.borderRadius = '8px';
      
      item.innerHTML = `
        <div>
          <h4 style="margin: 0 0 8px 0;">${salon.salon_name || salon.salon_username}</h4>
          ${salon.salon_address ? `<p style="margin: 4px 0; color: #6b7280; font-size: 0.9rem;">${salon.salon_address}</p>` : ''}
          <p style="margin: 4px 0; color: #6b7280; font-size: 0.85rem;">
            Добавлен: ${new Date(salon.created_at).toLocaleDateString('ru-RU')}
          </p>
        </div>
      `;
      
      list.appendChild(item);
    });
  }

  async function loadBookings() {
    try {
      const response = await fetch('/api/master/bookings');
      const result = await response.json();
      
      if (result.success) {
        renderBookings(result.bookings);
      }
    } catch (error) {
      console.error('Ошибка загрузки записей:', error);
    }
  }

  function renderBookings(bookings) {
    const list = document.getElementById('bookings-list');
    if (!list) return;

    if (bookings.length === 0) {
      list.innerHTML = '<p style="text-align: center; color: #6b7280;">У вас пока нет записей</p>';
      return;
    }

    list.innerHTML = '';
    bookings.forEach((booking) => {
      const item = document.createElement('div');
      item.className = 'admin-list-item';
      item.style.padding = '16px';
      item.style.marginBottom = '12px';
      item.style.border = '1px solid #e5e7eb';
      item.style.borderRadius = '8px';
      
      const date = new Date(booking.date);
      const dateStr = date.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      
      item.innerHTML = `
        <div>
          <h4 style="margin: 0 0 8px 0;">${booking.name}</h4>
          <p style="margin: 4px 0; color: #6b7280;">
            <strong>Салон:</strong> ${booking.salon_name || 'Не указан'}<br/>
            <strong>Услуга:</strong> ${booking.service}<br/>
            <strong>Дата:</strong> ${dateStr}<br/>
            <strong>Время:</strong> ${booking.time}${booking.end_time ? ` - ${booking.end_time}` : ''}<br/>
            <strong>Телефон:</strong> ${booking.phone}
            ${booking.comment ? `<br/><strong>Комментарий:</strong> ${booking.comment}` : ''}
          </p>
        </div>
      `;
      
      list.appendChild(item);
    });
  }

  function loadProfile() {
    if (!currentUser) return;
    
    document.getElementById('profile-email').value = currentUser.email || '';
    document.getElementById('profile-phone').value = currentUser.salonPhone || '';
    loadMasterPhotos();
  }

  async function loadMasterPhotos() {
    const grid = document.getElementById('photos-grid');
    const loading = document.getElementById('photos-loading');
    if (!grid) return;

    loading.style.display = 'block';
    grid.innerHTML = '';

    try {
      const response = await fetch('/api/master/photos');
      const result = await response.json();

      loading.style.display = 'none';

      if (result.success && result.photos && result.photos.length > 0) {
        grid.innerHTML = '';
        result.photos.forEach(photo => {
          const photoDiv = document.createElement('div');
          photoDiv.style.position = 'relative';
          photoDiv.style.borderRadius = '8px';
          photoDiv.style.overflow = 'hidden';
          photoDiv.style.backgroundColor = '#f3f4f6';
          photoDiv.style.aspectRatio = '1';

          const img = document.createElement('img');
          img.src = photo.url;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.loading = 'lazy';

          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = '×';
          deleteBtn.style.position = 'absolute';
          deleteBtn.style.top = '8px';
          deleteBtn.style.right = '8px';
          deleteBtn.style.width = '32px';
          deleteBtn.style.height = '32px';
          deleteBtn.style.borderRadius = '50%';
          deleteBtn.style.border = 'none';
          deleteBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
          deleteBtn.style.color = 'white';
          deleteBtn.style.cursor = 'pointer';
          deleteBtn.style.fontSize = '24px';
          deleteBtn.style.lineHeight = '1';
          deleteBtn.style.display = 'flex';
          deleteBtn.style.alignItems = 'center';
          deleteBtn.style.justifyContent = 'center';
          deleteBtn.title = 'Удалить фото';
          deleteBtn.onclick = () => deleteMasterPhoto(photo.filename);

          photoDiv.appendChild(img);
          photoDiv.appendChild(deleteBtn);
          grid.appendChild(photoDiv);
        });
      } else {
        grid.innerHTML = '<p style="text-align: center; color: #6b7280; grid-column: 1 / -1;">Фото работ еще не загружены</p>';
      }
    } catch (error) {
      console.error('Ошибка загрузки фото:', error);
      loading.style.display = 'none';
      grid.innerHTML = '<p style="text-align: center; color: #dc2626; grid-column: 1 / -1;">Ошибка загрузки фото</p>';
    }
  }

  async function deleteMasterPhoto(filename) {
    if (!confirm('Удалить это фото?')) return;

    try {
      const response = await fetch(`/api/master/photos/${encodeURIComponent(filename)}`, {
        method: 'DELETE'
      });
      const result = await response.json();

      const alert = document.getElementById('photos-alert');
      if (result.success) {
        alert.className = 'alert alert-success';
        alert.textContent = 'Фото удалено';
        alert.style.display = 'block';
        setTimeout(() => {
          alert.style.display = 'none';
        }, 3000);
        loadMasterPhotos();
      } else {
        alert.className = 'alert alert-error';
        alert.textContent = result.message || 'Ошибка удаления фото';
        alert.style.display = 'block';
      }
    } catch (error) {
      console.error('Ошибка удаления фото:', error);
      const alert = document.getElementById('photos-alert');
      alert.className = 'alert alert-error';
      alert.textContent = 'Ошибка соединения';
      alert.style.display = 'block';
    }
  }

  // Обработка загрузки фото
  document.addEventListener('DOMContentLoaded', () => {
    const uploadInput = document.getElementById('photos-upload');
    if (uploadInput) {
      uploadInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        if (files.length > 10) {
          alert('Максимум 10 файлов за раз');
          return;
        }

        const formData = new FormData();
        files.forEach(file => {
          if (file.size > 10 * 1024 * 1024) {
            alert(`Файл ${file.name} слишком большой (максимум 10 МБ)`);
            return;
          }
          formData.append('photos', file);
        });

        const alert = document.getElementById('photos-alert');
        const loading = document.getElementById('photos-loading');
        alert.style.display = 'none';
        loading.style.display = 'block';

        try {
          const response = await fetch('/api/master/photos', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          loading.style.display = 'none';

          if (result.success) {
            alert.className = 'alert alert-success';
            alert.textContent = `Загружено ${result.photos.length} фото`;
            if (result.warning) {
              alert.textContent += '. ' + result.warning;
            }
            alert.style.display = 'block';
            setTimeout(() => {
              alert.style.display = 'none';
            }, 5000);
            loadMasterPhotos();
            uploadInput.value = '';
          } else {
            alert.className = 'alert alert-error';
            alert.textContent = result.message || 'Ошибка загрузки фото';
            alert.style.display = 'block';
          }
        } catch (error) {
          console.error('Ошибка загрузки фото:', error);
          loading.style.display = 'none';
          alert.className = 'alert alert-error';
          alert.textContent = 'Ошибка соединения';
          alert.style.display = 'block';
        }
      });
    }
  });

  // Обработка формы профиля
  document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const alert = document.getElementById('profile-alert');
    alert.style.display = 'none';

    const email = document.getElementById('profile-email').value;
    const phone = document.getElementById('profile-phone').value;

    try {
      const response = await fetch('/api/master/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, salonPhone: phone })
      });

      const result = await response.json();
      if (result.success) {
        alert.className = 'alert alert-success';
        alert.textContent = 'Профиль обновлен';
        alert.style.display = 'block';
        loadUserData();
      } else {
        alert.className = 'alert alert-error';
        alert.textContent = result.message || 'Ошибка обновления профиля';
        alert.style.display = 'block';
      }
    } catch (error) {
      alert.className = 'alert alert-error';
      alert.textContent = 'Ошибка соединения';
      alert.style.display = 'block';
    }
  });

  // Переключение вкладок
  document.querySelectorAll('.main-tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.dataset.mainTab;
      
      document.querySelectorAll('.main-tab-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      document.querySelectorAll('.main-tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
      });
      
      const targetTab = document.getElementById(`${tabName}-tab`);
      if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
      }
    });
  });

  // Выход
  const logoutLink = document.getElementById('logout-link');
  if (logoutLink) {
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/';
    });
  }

  // Подсветка активной страницы в навигации
  function highlightActivePage() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-links a');
    
    navLinks.forEach(link => {
      if (link.id === 'logout-link' || link.href === '#' || !link.href) {
        return;
      }
      
      try {
        const linkPath = new URL(link.href, window.location.origin).pathname;
        const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
        const normalizedLink = linkPath.replace(/\/$/, '') || '/';
        
        if (normalizedLink === normalizedCurrent) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      } catch (e) {
        const href = link.getAttribute('href');
        if (href && (href === currentPath || href.replace(/\/$/, '') === currentPath.replace(/\/$/, ''))) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      }
    });
  }

  // Загружаем данные при загрузке страницы
  loadUserData();
  
  // Подсвечиваем активную страницу
  highlightActivePage();
</script>
</body>
</html>


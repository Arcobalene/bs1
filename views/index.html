<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Studio ‚Äî –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <h1 id="salon-name-header">Beauty Studio</h1>
  <p id="salon-description">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞. –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –æ–Ω–ª–∞–π–Ω –∑–∞ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤.</p>
  <div class="nav-links">
    <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="/login">–í—Ö–æ–¥ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤</a>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —É—Å–ª—É–≥–∏ –∏ –º–∞—Å—Ç–µ—Ä–∞ -->
    <div class="card">
      <h2>–£—Å–ª—É–≥–∏</h2>
      <p class="description">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –∞ –∑–∞—Ç–µ–º –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–ø–∏—Å—å –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.</p>
      <div class="services-list" id="services-list"></div>
      <div class="divider"></div>
      <h2>–ú–∞—Å—Ç–µ—Ä–∞</h2>
      <div class="masters-list" id="masters-list"></div>
      <p class="note">
        –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.
      </p>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ -->
    <div class="card">
      <h2>–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</h2>
      <p class="description">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É, –º—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–º –∑–∞–ø–∏—Å—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>

      <form id="booking-form">
        <div>
          <label for="client-name">–ò–º—è *</label>
          <input id="client-name" type="text" name="name" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" required />
        </div>

        <div>
          <label for="client-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input id="client-phone" type="tel" name="phone" placeholder="+998XX XXX XX XX" required />
        </div>

        <div>
          <label for="service">–£—Å–ª—É–≥–∞ *</label>
          <select id="service" name="service" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
          </select>
        </div>

        <div>
          <label for="master">–ú–∞—Å—Ç–µ—Ä</label>
          <select id="master" name="master">
            <option value="">–õ—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π –º–∞—Å—Ç–µ—Ä</option>
          </select>
        </div>

        <div class="form-row">
          <div>
            <label for="date">–î–∞—Ç–∞ *</label>
            <input id="date" type="date" name="date" required />
          </div>
          <div>
            <label for="time-slot">–í—Ä–µ–º—è *</label>
            <select id="time-slot" name="time" required>
              <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É</option>
            </select>
            <p id="duration-hint" class="note"></p>
            <p id="slot-hint" class="note"></p>
          </div>
        </div>

        <div>
          <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="comment" name="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–æ—á—É –¥–∏–∑–∞–π–Ω –≤ –Ω—é–¥–æ–≤—ã—Ö –æ—Ç—Ç–µ–Ω–∫–∞—Ö."></textarea>
        </div>

        <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>

        <div id="alert-success" class="alert alert-success">
          –°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
        </div>
        <div id="alert-error" class="alert alert-error">
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
        </div>

        <p class="note">
          –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        </p>
      </form>
    </div>
  </div>
</div>

<div id="salon-map-section" style="display: none; margin-top: 24px;">
  <div class="container">
    <div class="card">
      <h2>–ö–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏</h2>
      <div id="salon-map" style="width: 100%; height: 300px; border-radius: 10px; margin-top: 8px;"></div>
      <p id="salon-address-text" style="margin-top: 12px; color: #6b7280; font-size: 0.9rem;"></p>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Beauty Studio. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</footer>

<script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_API_KEY&lang=ru_RU" type="text/javascript"></script>
<script src="/app.js"></script>
<script>
  // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  const urlParams = new URLSearchParams(window.location.search);
  let userId = urlParams.get('userId');

  let services = [];
  let masters = [];
  let serviceDurations = {};
  const busyIntervals = {};

  // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ –∏ –º–∞—Å—Ç–µ—Ä–æ–≤
  async function loadData() {
    if (!userId) {
      // –ï—Å–ª–∏ userId –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      const servicesListEl = document.getElementById("services-list");
      const mastersListEl = document.getElementById("masters-list");
      const form = document.getElementById("booking-form");
      
      if (servicesListEl) {
        servicesListEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç —Å–∞–ª–æ–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏.</p>';
      }
      if (mastersListEl) {
        mastersListEl.innerHTML = '';
      }
      if (form) {
        form.style.display = 'none';
        const card = form.closest('.card');
        if (card) {
          card.innerHTML = '<h2>–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</h2><p class="description">–î–ª—è –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –≤–∞—à–µ–≥–æ —Å–∞–ª–æ–Ω–∞.</p>';
        }
      }
      return;
    }

    try {
      const [servicesRes, mastersRes, salonRes] = await Promise.all([
        fetch(`/api/services/${userId}`),
        fetch(`/api/masters/${userId}`),
        fetch(`/api/salon/${userId}`)
      ]);

      const servicesData = await servicesRes.json();
      const mastersData = await mastersRes.json();
      const salonData = await salonRes.json();

      if (servicesData.success) {
        services = servicesData.services;
        rebuildServiceDurations();
        renderServicesAndMasters();
      }

      if (mastersData.success) {
        masters = mastersData.masters;
        renderServicesAndMasters();
      }

      if (salonData.success && salonData.salon) {
        const salon = salonData.salon;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const headerTitle = document.getElementById('salon-name-header');
        const headerDesc = document.getElementById('salon-description');
        if (headerTitle) headerTitle.textContent = salon.name || 'Beauty Studio';
        if (headerDesc && salon.address) {
          headerDesc.textContent = salon.address;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        if (salon.lat && salon.lng) {
          initSalonMap(salon);
        } else if (salon.address) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å, –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç
          const addressText = document.getElementById('salon-address-text');
          const mapSection = document.getElementById('salon-map-section');
          if (addressText) addressText.textContent = `üìç ${salon.address}`;
          if (mapSection) mapSection.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
  }

  function initSalonMap(salon) {
    if (typeof ymaps === 'undefined') {
      console.error('–Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
      return;
    }

    ymaps.ready(() => {
      const map = new ymaps.Map('salon-map', {
        center: [salon.lat, salon.lng],
        zoom: 15,
        controls: ['zoomControl', 'fullscreenControl']
      });

      const placemark = new ymaps.Placemark([salon.lat, salon.lng], {
        balloonContent: salon.address || salon.name || '–°–∞–ª–æ–Ω'
      }, {
        preset: 'islands#redDotIcon'
      });

      map.geoObjects.add(placemark);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–∞—Ä—Ç–æ–π
      const mapSection = document.getElementById('salon-map-section');
      const addressText = document.getElementById('salon-address-text');
      if (mapSection) mapSection.style.display = 'block';
      if (addressText && salon.address) {
        addressText.textContent = `üìç ${salon.address}`;
      }
    });
  }

  function rebuildServiceDurations() {
    serviceDurations = {};
    services.forEach((s) => {
      serviceDurations[s.name] = s.duration;
    });
  }

  function renderServicesAndMasters() {
    const servicesListEl = document.getElementById("services-list");
    const mastersListEl = document.getElementById("masters-list");
    const serviceSelect = document.getElementById("service");
    const masterSelect = document.getElementById("master");

    if (servicesListEl) {
      servicesListEl.innerHTML = "";
      services.forEach((s) => {
        const row = document.createElement("div");
        row.className = "service-item";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = s.name;
        const priceSpan = document.createElement("span");
        priceSpan.className = "price";
        priceSpan.textContent = `${s.price.toLocaleString("ru-RU")} —Å—É–º ¬∑ ${Math.round((s.duration / 60) * 10) / 10} —á`;
        row.appendChild(nameSpan);
        row.appendChild(priceSpan);
        servicesListEl.appendChild(row);
      });
    }

    if (serviceSelect) {
      const currentValue = serviceSelect.value;
      serviceSelect.innerHTML = "";
      const baseOpt = document.createElement("option");
      baseOpt.value = "";
      baseOpt.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É";
      serviceSelect.appendChild(baseOpt);
      services.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        serviceSelect.appendChild(opt);
      });
      if (currentValue && serviceDurations[currentValue]) {
        serviceSelect.value = currentValue;
      }
    }

    if (mastersListEl) {
      mastersListEl.innerHTML = "";
      masters.forEach((m) => {
        const row = document.createElement("div");
        row.className = "master-item";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = m.name;
        const roleSpan = document.createElement("span");
        roleSpan.className = "role";
        roleSpan.textContent = m.role;
        row.appendChild(nameSpan);
        row.appendChild(roleSpan);
        mastersListEl.appendChild(row);
      });
    }

    if (masterSelect) {
      const currentMaster = masterSelect.value;
      masterSelect.innerHTML = "";
      const anyOpt = document.createElement("option");
      anyOpt.value = "";
      anyOpt.textContent = "–õ—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π –º–∞—Å—Ç–µ—Ä";
      masterSelect.appendChild(anyOpt);
      masters.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        masterSelect.appendChild(opt);
      });
      masterSelect.value = currentMaster || "";
    }

    generateSlots();
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
  (function setMinDate() {
    const dateInput = document.getElementById("date");
    if (dateInput) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${yyyy}-${mm}-${dd}`;
    }
  })();

  // –§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (–∏–∑ app.js)
  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToTime(total) {
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  }

  function getEndTime(startTime, durationMinutes) {
    const start = timeToMinutes(startTime);
    if (start === null) return "";
    const end = start + durationMinutes;
    return minutesToTime(end);
  }

  function updateDurationHint() {
    const durationHint = document.getElementById("duration-hint");
    const serviceSelect = document.getElementById("service");
    const timeSelect = document.getElementById("time-slot");
    if (!durationHint || !serviceSelect) return;

    const service = serviceSelect.value;
    const duration = serviceDurations[service];
    const time = timeSelect ? timeSelect.value : "";

    if (!service || !duration) {
      durationHint.textContent = "";
      return;
    }

    if (!time) {
      durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
      return;
    }

    const endTime = getEndTime(time, duration);
    if (!endTime) {
      durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
      return;
    }

    durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω. –ë—É–¥–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ ${endTime}.`;
  }

  function generateSlots() {
    const serviceSelect = document.getElementById("service");
    const dateInput = document.getElementById("date");
    const timeSelect = document.getElementById("time-slot");
    const slotHint = document.getElementById("slot-hint");
    const durationHint = document.getElementById("duration-hint");

    if (timeSelect) {
      timeSelect.innerHTML = "";
      timeSelect.disabled = false;
    }
    if (slotHint) slotHint.textContent = "";
    if (durationHint) durationHint.textContent = "";

    const baseOption = document.createElement("option");

    if (!serviceSelect || !dateInput) return;

    const service = serviceSelect.value;
    const date = dateInput.value;

    if (!service || !date) {
      baseOption.value = "";
      baseOption.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const duration = serviceDurations[service];
    if (!duration) {
      baseOption.value = "";
      baseOption.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const startOfDay = 10 * 60;
    const endOfDay = 20 * 60;
    const step = 30;

    const busy = (busyIntervals[date] || []).map(([from, to]) => [
      timeToMinutes(from),
      timeToMinutes(to)
    ]);

    const freeSlots = [];

    for (let start = startOfDay; start + duration <= endOfDay; start += step) {
      const end = start + duration;
      const overlaps = busy.some(([bStart, bEnd]) => start < bEnd && end > bStart);
      if (!overlaps) freeSlots.push({ start, end });
    }

    if (!freeSlots.length) {
      baseOption.value = "";
      baseOption.textContent = "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      if (slotHint) slotHint.textContent = "–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∏–ª–∏ —É—Å–ª—É–≥—É.";
      return;
    }

    if (timeSelect) {
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è";
      timeSelect.appendChild(defaultOption);

      freeSlots.forEach((slot) => {
        const opt = document.createElement("option");
        const startStr = minutesToTime(slot.start);
        const endStr = minutesToTime(slot.end);
        opt.value = startStr;
        opt.textContent = `${startStr} ‚Äì ${endStr}`;
        timeSelect.appendChild(opt);
      });
    }

    if (slotHint) slotHint.textContent = "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.";
    if (durationHint) durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  const form = document.getElementById("booking-form");
  const successAlert = document.getElementById("alert-success");
  const errorAlert = document.getElementById("alert-error");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (successAlert) successAlert.style.display = "none";
      if (errorAlert) errorAlert.style.display = "none";

      const formData = new FormData(form);
      const data = {
        userId: parseInt(userId),
        name: (formData.get("name") || "").trim(),
        phone: (formData.get("phone") || "").trim(),
        service: formData.get("service"),
        master: formData.get("master"),
        date: formData.get("date"),
        time: formData.get("time"),
        comment: (formData.get("comment") || "").trim()
      };

      if (!data.name || !data.phone || !data.service || !data.date || !data.time) {
        if (errorAlert) errorAlert.style.display = "block";
        return;
      }

      const phoneDigits = data.phone.replace(/\D/g, "");
      if (phoneDigits.length < 9) {
        if (errorAlert) {
          errorAlert.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 9 —Ü–∏—Ñ—Ä).";
          errorAlert.style.display = "block";
        }
        return;
      }

      const duration = serviceDurations[data.service];
      if (duration) {
        const endTime = getEndTime(data.time, duration);
        if (endTime) {
          data.endTime = endTime;
        }
      }

      try {
        const response = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          if (successAlert) successAlert.style.display = "block";
          form.reset();
          generateSlots();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–Ω—è—Ç—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
          if (!busyIntervals[data.date]) busyIntervals[data.date] = [];
          busyIntervals[data.date].push([data.time, data.endTime]);
        } else {
          if (errorAlert) {
            errorAlert.textContent = result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏";
            errorAlert.style.display = "block";
          }
        }
      } catch (error) {
        if (errorAlert) {
          errorAlert.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
          errorAlert.style.display = "block";
        }
      }
    });
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
  const serviceSelect = document.getElementById("service");
  const dateInput = document.getElementById("date");
  const timeSelect = document.getElementById("time-slot");

  if (serviceSelect) serviceSelect.addEventListener("change", generateSlots);
  if (dateInput) dateInput.addEventListener("change", generateSlots);
  if (timeSelect) timeSelect.addEventListener("change", updateDurationHint);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadData();
</script>
</body>
</html>


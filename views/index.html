<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Studio ‚Äî –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<header>
  <div class="header-top-links" id="header-top-links" style="display: none;">
    <a href="/users" id="users-link" class="header-top-link" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
    </a>
    <a href="#" id="logout-link" class="logout-link" title="–í—ã—Ö–æ–¥">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 17v-3h-5v-4h5V7l5 5-5 5zM14 2a2 2 0 012 2v2h-2V4H5v16h11v-2h2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V4a2 2 0 012-2h9z"/>
      </svg>
    </a>
  </div>
  <h1 id="salon-name-header">Beauty Studio</h1>
  <p id="salon-description">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞. –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –æ–Ω–ª–∞–π–Ω –∑–∞ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤.</p>
  <div class="nav-links" id="nav-links">
    <a href="/login" id="login-link">–í—Ö–æ–¥ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤</a>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —É—Å–ª—É–≥–∏ –∏ –º–∞—Å—Ç–µ—Ä–∞ -->
    <div class="card">
      <h2>–£—Å–ª—É–≥–∏</h2>
      <p class="description">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –∞ –∑–∞—Ç–µ–º –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–ø–∏—Å—å –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.</p>
      <div class="services-list" id="services-list"></div>
      <div class="divider"></div>
      <h2>–ú–∞—Å—Ç–µ—Ä–∞</h2>
      <div class="masters-list" id="masters-list"></div>
      <p class="note">
        –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.
      </p>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ -->
    <div class="card">
      <p id="salon-phone" style="margin-bottom: 16px; font-size: 1.1rem; font-weight: 500; text-align: center; color: #6b7280; display: none;"></p>
      <h2>–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</h2>
      <p class="description">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É, –º—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–º –∑–∞–ø–∏—Å—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>

      <form id="booking-form">
        <div>
          <label for="client-name">–ò–º—è *</label>
          <input id="client-name" type="text" name="name" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" required />
        </div>

        <div>
          <label for="client-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input id="client-phone" type="tel" name="phone" placeholder="+998XX XXX XX XX" required />
        </div>

        <div>
          <label for="service">–£—Å–ª—É–≥–∞ *</label>
          <select id="service" name="service" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
          </select>
        </div>

        <div>
          <label for="master">–ú–∞—Å—Ç–µ—Ä</label>
          <select id="master" name="master">
            <option value="">–õ—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π –º–∞—Å—Ç–µ—Ä</option>
          </select>
        </div>

        <div class="form-row">
          <div>
            <label for="date">–î–∞—Ç–∞ *</label>
            <input id="date" type="date" name="date" required min="" />
          </div>
          <div>
            <label for="time-slot">–í—Ä–µ–º—è *</label>
            <select id="time-slot" name="time" required>
              <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É</option>
            </select>
            <p id="duration-hint" class="note"></p>
            <p id="slot-hint" class="note"></p>
          </div>
        </div>

        <div>
          <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="comment" name="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–æ—á—É –¥–∏–∑–∞–π–Ω –≤ –Ω—é–¥–æ–≤—ã—Ö –æ—Ç—Ç–µ–Ω–∫–∞—Ö."></textarea>
        </div>

        <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>

        <div id="alert-success" class="alert alert-success">
          –°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
        </div>
        <div id="alert-error" class="alert alert-error">
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
        </div>

        <p class="note">
          –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        </p>
      </form>
    </div>
  </div>
</div>

<div id="salon-map-section" style="display: none; margin-top: 24px;">
  <div class="container">
    <div class="card">
      <h2>–ö–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏</h2>
      <div id="salon-map" style="width: 100%; height: 300px; border-radius: 10px; margin-top: 8px;"></div>
      <p id="salon-address-text" style="margin-top: 12px; color: #6b7280; font-size: 0.9rem;"></p>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Beauty Studio. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</footer>

<script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_API_KEY&lang=ru_RU" type="text/javascript"></script>
<script src="/app.js"></script>
<script>
  // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  const urlParams = new URLSearchParams(window.location.search);
  let userId = urlParams.get('userId');

  let services = [];
  let masters = [];
  let serviceDurations = {};
  let busyIntervals = {};

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
  function setMinDate() {
    const dateInput = document.getElementById('date');
    if (dateInput) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      dateInput.setAttribute('min', todayStr);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ –∏ –º–∞—Å—Ç–µ—Ä–æ–≤
  async function loadData() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É
    setMinDate();
    
    if (!userId) {
      // –ï—Å–ª–∏ userId –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      const servicesListEl = document.getElementById("services-list");
      const mastersListEl = document.getElementById("masters-list");
      const form = document.getElementById("booking-form");
      
      if (servicesListEl) {
        servicesListEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç —Å–∞–ª–æ–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏.</p>';
      }
      if (mastersListEl) {
        mastersListEl.innerHTML = '';
      }
      if (form) {
        form.style.display = 'none';
        const card = form.closest('.card');
        if (card) {
          card.innerHTML = '<h2>–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</h2><p class="description">–î–ª—è –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç –≤–∞—à–µ–≥–æ —Å–∞–ª–æ–Ω–∞.</p>';
        }
      }
      return;
    }

    try {
      const [servicesRes, mastersRes, salonRes] = await Promise.all([
        fetch(`/api/services/${userId}`),
        fetch(`/api/masters/${userId}`),
        fetch(`/api/salon/${userId}`)
      ]);

      const servicesData = await servicesRes.json();
      const mastersData = await mastersRes.json();
      const salonData = await salonRes.json();

      if (servicesData.success) {
        services = servicesData.services || [];
        rebuildServiceDurations();
        renderServicesAndMasters();
      } else {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥:', servicesData);
        const servicesListEl = document.getElementById("services-list");
        if (servicesListEl) {
          servicesListEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥</p>';
        }
      }

      if (mastersData.success) {
        masters = mastersData.masters || [];
        renderServicesAndMasters();
      } else {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤:', mastersData);
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –±–∞–∑—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è busyIntervals
      try {
        const bookingsRes = await fetch(`/api/bookings/${userId}`);
        const bookingsData = await bookingsRes.json();
        if (bookingsData.success && bookingsData.bookings) {
          // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
          busyIntervals = {};
          // –ó–∞–ø–æ–ª–Ω—è–µ–º busyIntervals –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
          bookingsData.bookings.forEach(booking => {
            if (booking.date && booking.time) {
              if (!busyIntervals[booking.date]) {
                busyIntervals[booking.date] = [];
              }
              const endTime = booking.endTime || getEndTime(booking.time, 60); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å
              busyIntervals[booking.date].push([booking.time, endTime]);
            }
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', error);
      }

      if (salonData.success && salonData.salon) {
        const salon = salonData.salon;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const headerTitle = document.getElementById('salon-name-header');
        const headerDesc = document.getElementById('salon-description');
        const salonPhone = document.getElementById('salon-phone');
        if (headerTitle) headerTitle.textContent = salon.name || 'Beauty Studio';
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∑–∞–π–Ω–∞
        if (salon.design) {
          applyDesign(salon.design);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –¥–∏–∑–∞–π–Ω–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å
        if (headerDesc) {
          if (salon.design && salon.design.headerDescription) {
            headerDesc.textContent = salon.design.headerDescription;
          } else if (salon.design && salon.design.headerTitle) {
            headerDesc.textContent = salon.design.headerTitle;
          } else if (salon.address) {
            headerDesc.textContent = salon.address;
          }
        }
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (salonPhone) {
          if (salon.phone && salon.phone.trim()) {
            salonPhone.textContent = `üìû ${salon.phone}`;
            salonPhone.style.display = 'block';
          } else {
            salonPhone.style.display = 'none';
          }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        if (salon.lat && salon.lng) {
          initSalonMap(salon);
        } else if (salon.address) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å, –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç
          const addressText = document.getElementById('salon-address-text');
          const mapSection = document.getElementById('salon-map-section');
          if (addressText) addressText.textContent = `üìç ${salon.address}`;
          if (mapSection) mapSection.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
  }

  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∏–∑–∞–π–Ω–∞
  function applyDesign(design) {
    if (!design) return;

    const style = document.createElement('style');
    style.id = 'salon-custom-design';

    const primaryColor = design.primaryColor || '#f973b6';
    const secondaryColor = design.secondaryColor || '#a855f7';
    const headerBg = design.headerBg || '#f973b6';
    const cardBg = design.cardBg || '#ffffff';
    const textColor = design.textColor || '#222222';
    const buttonTextColor = design.buttonTextColor || '#ffffff';
    const pageBg = design.pageBg || '#f7f7fb';
    const pageBgType = design.pageBgType || 'color';
    const pageBgSecondary = design.pageBgSecondary || '#ffffff';
    const pageBgImage = design.pageBgImage || '';

    // –í—ã—á–∏—Å–ª—è–µ–º, —Å–≤–µ—Ç–ª—ã–π –∏–ª–∏ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞
    const isLightBg = isLightColor(cardBg);
    const finalTextColor = isLightBg ? textColor : '#ffffff';

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    let bodyBg = pageBg;
    if (pageBgType === 'gradient') {
      bodyBg = `linear-gradient(135deg, ${pageBg}, ${pageBgSecondary})`;
    } else if (pageBgType === 'image' && pageBgImage) {
      bodyBg = `url(${pageBgImage}) center/cover no-repeat`;
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ header, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (design.logo) {
      const header = document.querySelector('header');
      const headerTitle = document.getElementById('salon-name-header');
      let logoImg = header ? header.querySelector('img.logo-img') : null;
      
      if (!logoImg && header && headerTitle) {
        logoImg = document.createElement('img');
        logoImg.src = design.logo;
        logoImg.className = 'logo-img';
        logoImg.alt = '–õ–æ–≥–æ—Ç–∏–ø —Å–∞–ª–æ–Ω–∞';
        logoImg.style.cssText = 'max-height: 80px; max-width: 200px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; object-fit: contain;';
        header.insertBefore(logoImg, headerTitle);
      } else if (logoImg) {
        logoImg.src = design.logo;
        logoImg.style.display = 'block';
      }
    } else {
      // –£–¥–∞–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      const logoImg = document.querySelector('header img.logo-img');
      if (logoImg) logoImg.remove();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ style —ç–ª–µ–º–µ–Ω—Ç
    style.textContent = `
      body {
        background: ${bodyBg} !important;
      }
      header {
        background: linear-gradient(135deg, ${headerBg}, ${secondaryColor}) !important;
        position: relative !important;
      }
      .card {
        background: ${cardBg} !important;
        color: ${finalTextColor} !important;
      }
      .card * {
        color: inherit !important;
      }
      .card h2,
      .card h3,
      .card h4,
      .card h5,
      .card h6 {
        color: ${finalTextColor} !important;
      }
      .card p,
      .card .description,
      .card .note,
      .card div,
      .card span:not(.price) {
        color: ${finalTextColor} !important;
      }
      .card label {
        color: ${finalTextColor} !important;
      }
      .card .service-item,
      .card .master-item {
        color: ${finalTextColor} !important;
      }
      .btn-primary {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        color: ${buttonTextColor} !important;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor}) !important;
        filter: brightness(1.1);
        color: ${buttonTextColor} !important;
      }
      .service-item span.price {
        color: ${primaryColor} !important;
      }
      .service-item span:first-child {
        color: ${finalTextColor} !important;
      }
      .master-item span {
        color: ${finalTextColor} !important;
      }
      .master-item span.role {
        color: ${finalTextColor} !important;
        opacity: 0.7;
      }
      input:focus, select:focus, textarea:focus {
        border-color: ${primaryColor} !important;
        box-shadow: 0 0 0 1px rgba(${hexToRgb(primaryColor)}, 0.35) !important;
      }
      input, select, textarea {
        color: ${finalTextColor} !important;
        background: ${isLightBg ? '#f9fafb' : 'rgba(255, 255, 255, 0.1)'} !important;
      }
      input::placeholder, textarea::placeholder {
        color: ${isLightBg ? '#9ca3af' : 'rgba(255, 255, 255, 0.6)'} !important;
      }
      .alert-success {
        background: #dcfce7 !important;
        color: #166534 !important;
      }
      .alert-error {
        background: #fee2e2 !important;
        color: #b91c1c !important;
      }
    `;

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å, –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldStyle = document.getElementById('salon-custom-design');
    if (oldStyle) oldStyle.remove();

    document.head.appendChild(style);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —Å–≤–µ—Ç–ª—ã–π –ª–∏ —Ü–≤–µ—Ç
  function isLightColor(hex) {
    const rgb = hexToRgbArray(hex);
    if (!rgb) return true;
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º—É–ª—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏
    const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
    return brightness > 128;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ hex –≤ –º–∞—Å—Å–∏–≤ RGB
  function hexToRgbArray(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
      parseInt(result[1], 16),
      parseInt(result[2], 16),
      parseInt(result[3], 16)
    ] : null;
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ hex –≤ rgb
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
      `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
      : '249, 115, 182';
  }

  function initSalonMap(salon) {
    if (typeof ymaps === 'undefined') {
      console.error('–Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
      return;
    }

    ymaps.ready(() => {
      const map = new ymaps.Map('salon-map', {
        center: [salon.lat, salon.lng],
        zoom: 15,
        controls: ['zoomControl', 'fullscreenControl']
      });

      const placemark = new ymaps.Placemark([salon.lat, salon.lng], {
        balloonContent: salon.address || salon.name || '–°–∞–ª–æ–Ω'
      }, {
        preset: 'islands#redDotIcon'
      });

      map.geoObjects.add(placemark);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–∞—Ä—Ç–æ–π
      const mapSection = document.getElementById('salon-map-section');
      const addressText = document.getElementById('salon-address-text');
      if (mapSection) mapSection.style.display = 'block';
      if (addressText && salon.address) {
        addressText.textContent = `üìç ${salon.address}`;
      }
    });
  }

  function rebuildServiceDurations() {
    serviceDurations = {};
    services.forEach((s) => {
      serviceDurations[s.name] = s.duration;
    });
  }

  function renderServicesAndMasters() {
    const servicesListEl = document.getElementById("services-list");
    const mastersListEl = document.getElementById("masters-list");
    const serviceSelect = document.getElementById("service");
    const masterSelect = document.getElementById("master");

    if (servicesListEl) {
      servicesListEl.innerHTML = "";
      if (services && services.length > 0) {
        services.forEach((s) => {
          const row = document.createElement("div");
          row.className = "service-item";
          const nameSpan = document.createElement("span");
          nameSpan.textContent = s.name;
          const priceSpan = document.createElement("span");
          priceSpan.className = "price";
          priceSpan.textContent = `${s.price.toLocaleString("ru-RU")} —Å—É–º ¬∑ ${Math.round((s.duration / 60) * 10) / 10} —á`;
          row.appendChild(nameSpan);
          row.appendChild(priceSpan);
          servicesListEl.appendChild(row);
        });
      } else {
        servicesListEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">–£—Å–ª—É–≥–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
      }
    }

    if (serviceSelect) {
      const currentValue = serviceSelect.value;
      serviceSelect.innerHTML = "";
      const baseOpt = document.createElement("option");
      baseOpt.value = "";
      baseOpt.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É";
      serviceSelect.appendChild(baseOpt);
      services.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        serviceSelect.appendChild(opt);
      });
      if (currentValue && serviceDurations[currentValue]) {
        serviceSelect.value = currentValue;
      }
    }

    if (mastersListEl) {
      mastersListEl.innerHTML = "";
      masters.forEach((m) => {
        const row = document.createElement("div");
        row.className = "master-item";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = m.name;
        const roleSpan = document.createElement("span");
        roleSpan.className = "role";
        roleSpan.textContent = m.role;
        row.appendChild(nameSpan);
        row.appendChild(roleSpan);
        mastersListEl.appendChild(row);
      });
    }

    if (masterSelect) {
      const currentMaster = masterSelect.value;
      masterSelect.innerHTML = "";
      const anyOpt = document.createElement("option");
      anyOpt.value = "";
      anyOpt.textContent = "–õ—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π –º–∞—Å—Ç–µ—Ä";
      masterSelect.appendChild(anyOpt);
      masters.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        masterSelect.appendChild(opt);
      });
      masterSelect.value = currentMaster || "";
    }

    generateSlots();
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
  (function setMinDate() {
    const dateInput = document.getElementById("date");
    if (dateInput) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${yyyy}-${mm}-${dd}`;
    }
  })();

  // –§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (–∏–∑ app.js)
  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToTime(total) {
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  }

  function getEndTime(startTime, durationMinutes) {
    const start = timeToMinutes(startTime);
    if (start === null) return "";
    const end = start + durationMinutes;
    return minutesToTime(end);
  }

  function updateDurationHint() {
    const durationHint = document.getElementById("duration-hint");
    const serviceSelect = document.getElementById("service");
    const timeSelect = document.getElementById("time-slot");
    if (!durationHint || !serviceSelect) return;

    const service = serviceSelect.value;
    const duration = serviceDurations[service];
    const time = timeSelect ? timeSelect.value : "";

    if (!service || !duration) {
      durationHint.textContent = "";
      return;
    }

    if (!time) {
      durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
      return;
    }

    const endTime = getEndTime(time, duration);
    if (!endTime) {
      durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
      return;
    }

    durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω. –ë—É–¥–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ ${endTime}.`;
  }

  async function generateSlots() {
    const serviceSelect = document.getElementById("service");
    const dateInput = document.getElementById("date");
    const timeSelect = document.getElementById("time-slot");
    const slotHint = document.getElementById("slot-hint");
    const durationHint = document.getElementById("duration-hint");

    if (timeSelect) {
      timeSelect.innerHTML = "";
      timeSelect.disabled = false;
    }
    if (slotHint) slotHint.textContent = "";
    if (durationHint) durationHint.textContent = "";

    const baseOption = document.createElement("option");

    if (!serviceSelect || !dateInput) return;

    const service = serviceSelect.value;
    const date = dateInput.value;

    if (!service || !date) {
      baseOption.value = "";
      baseOption.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const duration = serviceDurations[service];
    if (!duration) {
      baseOption.value = "";
      baseOption.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
    const masterSelect = document.getElementById("master");
    const selectedMaster = masterSelect ? masterSelect.value : '';

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
    let busy = [];
    if (userId) {
      try {
        const bookingsRes = await fetch(`/api/bookings/${userId}?date=${date}`);
        const bookingsResult = await bookingsRes.json();
        if (bookingsResult.success && bookingsResult.bookings) {
          // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –º–∞—Å—Ç–µ—Ä—É: –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –∑–∞–ø–∏—Å–∏
          // –ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–¥–ª—è "–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä")
          const filteredBookings = selectedMaster && selectedMaster.trim() !== ''
            ? bookingsResult.bookings.filter(booking => {
                // –£—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–ø–∏—Å–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –∏–ª–∏ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –º–∞—Å—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω)
                return booking.master === selectedMaster || !booking.master || booking.master.trim() === '';
              })
            : bookingsResult.bookings;
          
          busy = filteredBookings.map(booking => {
            const start = timeToMinutes(booking.time);
            const end = booking.endTime ? timeToMinutes(booking.endTime) : (start + 60);
            return [start, end].filter(v => v !== null);
          }).filter(interval => interval.length === 2);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', error);
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        busy = (busyIntervals[date] || []).map(([from, to]) => [
          timeToMinutes(from),
          timeToMinutes(to)
        ]).filter(interval => interval.every(v => v !== null));
      }
    } else {
      // –ï—Å–ª–∏ userId –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      busy = (busyIntervals[date] || []).map(([from, to]) => [
        timeToMinutes(from),
        timeToMinutes(to)
      ]).filter(interval => interval.every(v => v !== null));
    }

    const startOfDay = 10 * 60;
    const endOfDay = 20 * 60;
    const step = 30;

    const freeSlots = [];

    for (let start = startOfDay; start + duration <= endOfDay; start += step) {
      const end = start + duration;
      const overlaps = busy.some(([bStart, bEnd]) => start < bEnd && end > bStart);
      if (!overlaps) freeSlots.push({ start, end });
    }

    if (!freeSlots.length) {
      baseOption.value = "";
      baseOption.textContent = "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      if (slotHint) slotHint.textContent = "–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∏–ª–∏ —É—Å–ª—É–≥—É.";
      return;
    }

    if (timeSelect) {
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è";
      timeSelect.appendChild(defaultOption);

      freeSlots.forEach((slot) => {
        const opt = document.createElement("option");
        const startStr = minutesToTime(slot.start);
        const endStr = minutesToTime(slot.end);
        opt.value = startStr;
        opt.textContent = `${startStr} ‚Äì ${endStr}`;
        timeSelect.appendChild(opt);
      });
    }

    if (slotHint) slotHint.textContent = "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.";
    if (durationHint) durationHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${duration} –º–∏–Ω.`;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  const form = document.getElementById("booking-form");
  const successAlert = document.getElementById("alert-success");
  const errorAlert = document.getElementById("alert-error");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (successAlert) successAlert.style.display = "none";
      if (errorAlert) errorAlert.style.display = "none";

      const formData = new FormData(form);
      const data = {
        userId: parseInt(userId),
        name: (formData.get("name") || "").trim(),
        phone: (formData.get("phone") || "").trim(),
        service: formData.get("service"),
        master: formData.get("master"),
        date: formData.get("date"),
        time: formData.get("time"),
        comment: (formData.get("comment") || "").trim()
      };

      if (!data.name || !data.phone || !data.service || !data.date || !data.time) {
        if (errorAlert) errorAlert.style.display = "block";
        return;
      }

      const phoneDigits = data.phone.replace(/\D/g, "");
      if (phoneDigits.length < 9) {
        if (errorAlert) {
          errorAlert.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 9 —Ü–∏—Ñ—Ä).";
          errorAlert.style.display = "block";
        }
        return;
      }

      const duration = serviceDurations[data.service];
      if (duration) {
        const endTime = getEndTime(data.time, duration);
        if (endTime) {
          data.endTime = endTime;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      try {
        const availabilityCheck = await fetch('/api/bookings/check-availability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: data.userId,
            date: data.date,
            time: data.time,
            endTime: data.endTime,
            master: data.master
          })
        });

        const availabilityResult = await availabilityCheck.json();
        if (!availabilityResult.available) {
          if (errorAlert) {
            errorAlert.textContent = availabilityResult.message || '–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.';
            errorAlert.style.display = 'block';
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            generateSlots();
          }
          return;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:', error);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
      }

      try {
        const response = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          if (successAlert) successAlert.style.display = "block";
          form.reset();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–Ω—è—Ç—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
          if (!busyIntervals[data.date]) busyIntervals[data.date] = [];
          busyIntervals[data.date].push([data.time, data.endTime]);
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
          await generateSlots();
          
          // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —É—Å–ø–µ—à–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
          if (successAlert) {
            successAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        } else {
          if (errorAlert) {
            errorAlert.textContent = result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏";
            errorAlert.style.display = "block";
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:', error);
        if (errorAlert) {
          errorAlert.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
          errorAlert.style.display = "block";
          errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
    });
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
  const serviceSelect = document.getElementById("service");
  const dateInput = document.getElementById("date");
  const timeSelect = document.getElementById("time-slot");

  if (serviceSelect) serviceSelect.addEventListener("change", generateSlots);
  if (dateInput) dateInput.addEventListener("change", generateSlots);
  const masterSelect = document.getElementById("master");
  if (masterSelect) masterSelect.addEventListener("change", generateSlots);
  if (timeSelect) timeSelect.addEventListener("change", updateDurationHint);

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  function highlightActivePage() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-links a, .header-top-links a');
    
    navLinks.forEach(link => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤—ã—Ö–æ–¥
      if (link.id === 'logout-link' || link.href === '#' || !link.href) {
        return;
      }
      
      try {
        const linkPath = new URL(link.href, window.location.origin).pathname;
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç–∏ (—É–±–∏—Ä–∞–µ–º trailing slash)
        const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
        const normalizedLink = linkPath.replace(/\/$/, '') || '/';
        
        if (normalizedLink === normalizedCurrent) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å URL, –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º href
        const href = link.getAttribute('href');
        if (href && (href === currentPath || href.replace(/\/$/, '') === currentPath.replace(/\/$/, ''))) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      }
    });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
  async function checkAuthAndShowMenu() {
    // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è .then()
    try {
      const response = await fetch('/api/user');
      const result = await response.json();
      
      if (result.success && result.user) {
        const currentUser = result.user;
        const headerTopLinks = document.getElementById('header-top-links');
        const navLinks = document.getElementById('nav-links');
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –Ω–æ –≤ URL –Ω–µ—Ç userId, –æ–±–Ω–æ–≤–ª—è–µ–º URL
        if (currentUser.id && !userId && window.location.pathname === '/') {
          const newUrl = `/?userId=${currentUser.id}`;
          window.history.replaceState({}, '', newUrl);
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é userId –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          userId = currentUser.id;
          // loadData() –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è checkAuthAndShowMenu()
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–µ —Å—Å—ã–ª–∫–∏ (–∏–∫–æ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã—Ö–æ–¥–∞)
        if (headerTopLinks) {
          headerTopLinks.style.display = 'block';
        }
        
        // –ó–∞–º–µ–Ω—è–µ–º –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if (navLinks) {
          // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º userId
          const salonPageUrl = currentUser.id ? `/?userId=${currentUser.id}` : '/';
          navLinks.innerHTML = `
            <a href="${salonPageUrl}" id="salon-page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–ª–æ–Ω–∞</a>
            <a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            <a href="/calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
            <a href="/services">–£—Å–ª—É–≥–∏ –∏ –º–∞—Å—Ç–µ—Ä–∞</a>
            <a href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
          `;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        const usersLink = document.getElementById('users-link');
        const isAdmin = currentUser.role === 'admin' || currentUser.username === 'admin';
        if (usersLink) {
          if (isAdmin) {
            usersLink.classList.add('show');
          } else {
            usersLink.classList.remove('show');
          }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å, –∑–∞–º–µ–Ω—è—è —ç–ª–µ–º–µ–Ω—Ç
          const newLogoutLink = logoutLink.cloneNode(true);
          logoutLink.parentNode.replaceChild(newLogoutLink, logoutLink);
          
          newLogoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/api/logout', { method: 'POST' });
            window.location.reload();
          });
        }
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é
        setTimeout(() => {
          highlightActivePage();
        }, 0);
      } else {
        // –ï—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        const headerTopLinks = document.getElementById('header-top-links');
        if (headerTopLinks) {
          headerTopLinks.style.display = 'none';
        }
        // –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–∂–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        highlightActivePage();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
      const headerTopLinks = document.getElementById('header-top-links');
      if (headerTopLinks) {
        headerTopLinks.style.display = 'none';
      }
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      highlightActivePage();
      // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã .catch() –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –µ—ë
      throw error;
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
  // –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π userId)
  checkAuthAndShowMenu().then(() => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    loadData();
  }).catch(() => {
    // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadData();
  });
</script>
</body>
</html>


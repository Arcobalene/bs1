<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Beauty Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0;
    }
    
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      color: #6b7280;
      transition: all 0.2s;
      position: relative;
      bottom: -2px;
    }
    
    .tab:hover {
      color: #a855f7;
      background: rgba(168, 85, 247, 0.05);
    }
    
    .tab.active {
      color: #a855f7;
      border-bottom-color: #a855f7;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .booking-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    
    .booking-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .booking-service {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .booking-date-time {
      color: #6b7280;
      font-size: 0.95rem;
    }
    
    .booking-salon {
      color: #a855f7;
      font-weight: 500;
      margin-top: 8px;
    }
    
    .booking-master {
      color: #6b7280;
      font-size: 0.9rem;
      margin-top: 4px;
    }
    
    .booking-status {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .booking-status.active {
      background: #dcfce7;
      color: #166534;
    }
    
    .booking-status.past {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .salon-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .salon-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
      border-color: #a855f7;
    }
    
    .salon-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .salon-address {
      color: #6b7280;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }
    
    .salon-phone {
      color: #a855f7;
      font-size: 0.9rem;
      margin-top: 8px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .phone-input-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #e5e7eb;
    }
    
    .phone-input-section h3 {
      margin-bottom: 16px;
      color: #1f2937;
    }
    
    .phone-input-group {
      display: flex;
      gap: 12px;
    }
    
    .phone-input-group input {
      flex: 1;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .phone-input-group button {
      padding: 12px 24px;
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      .booking-header {
        flex-direction: column;
        gap: 8px;
      }
      
      .phone-input-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
  <p id="client-greeting">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏</p>
  <div class="nav-links">
    <a href="/" id="home-link">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <a href="#" id="logout-link" style="display: none;">–í—ã—Ö–æ–¥</a>
  </div>
</header>

<div class="container">
  <!-- –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) -->
  <div class="phone-input-section" id="phone-input-section">
    <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
    <div class="phone-input-group">
      <input type="tel" id="client-phone-input" placeholder="+998XX XXX XX XX" />
      <button type="button" class="btn-primary" id="load-bookings-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏</button>
    </div>
    <div id="phone-error" class="alert alert-error" style="display: none; margin-top: 12px;"></div>
    <p class="note" style="margin-top: 12px; text-align: center;">
      –ò–ª–∏ <a href="/login-client" style="color: #a855f7;">–≤–æ–π–¥–∏—Ç–µ</a> / <a href="/register-client" style="color: #a855f7;">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a> –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π
    </p>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button class="tab active" data-tab="bookings">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
    <button class="tab" data-tab="salons">–í—ã–±–æ—Ä —Å–∞–ª–æ–Ω–∞</button>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ -->
  <div class="tab-content active" id="tab-bookings">
    <div class="card">
      <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏</h2>
      <p class="description">–í–∞—à–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Å–∞–ª–æ–Ω–∞—Ö –∫—Ä–∞—Å–æ—Ç—ã.</p>
      <div id="bookings-list">
        <div class="empty-state">
          <div class="empty-state-icon">üìÖ</div>
          <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏</p>
        </div>
      </div>
    </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ —Å –≤—ã–±–æ—Ä–æ–º —Å–∞–ª–æ–Ω–æ–≤ -->
  <div class="tab-content" id="tab-salons">
    <div class="card">
      <h2>–í—ã–±–æ—Ä —Å–∞–ª–æ–Ω–∞</h2>
      <p class="description">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏.</p>
      <div id="salons-list">
        <div class="empty-state">
          <div class="empty-state-icon">üíá</div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∞–ª–æ–Ω–æ–≤...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Beauty Studio. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</footer>

<script>
  let currentPhone = '';
  let allBookings = [];
  let allSalons = [];
  let currentClient = null;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
  async function checkClientAuth() {
    try {
      const response = await fetch('/api/client');
      const result = await response.json();
      
      if (result.success && result.client) {
        currentClient = result.client;
        currentPhone = result.client.phone;
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneSection = document.getElementById('phone-input-section');
        if (phoneSection) phoneSection.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
          logoutLink.style.display = 'block';
          logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/api/logout-client', { method: 'POST' });
            window.location.reload();
          });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        const greeting = document.getElementById('client-greeting');
        if (greeting) {
          greeting.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${result.client.name}!`;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏
        await loadBookings(result.client.phone);
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneSection = document.getElementById('phone-input-section');
        if (phoneSection) phoneSection.style.display = 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) logoutLink.style.display = 'none';
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  checkClientAuth();

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
      tab.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —Å–∞–ª–æ–Ω—ã –∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
      if (tabName === 'salons' && allSalons.length === 0) {
        loadSalons();
      }
    });
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
  document.getElementById('load-bookings-btn').addEventListener('click', async () => {
    const phoneInput = document.getElementById('client-phone-input');
    const phone = phoneInput.value.trim();
    const errorDiv = document.getElementById('phone-error');
    
    errorDiv.style.display = 'none';
    
    if (!phone) {
      errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
      errorDiv.style.display = 'block';
      return;
    }
    
    const phoneDigits = phone.replace(/\D/g, '');
    if (phoneDigits.length < 9) {
      errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 9 —Ü–∏—Ñ—Ä)';
      errorDiv.style.display = 'block';
      return;
    }
    
    currentPhone = phone;
    await loadBookings(phone);
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞
  async function loadBookings(phone) {
    const bookingsList = document.getElementById('bookings-list');
    bookingsList.innerHTML = '<p style="text-align: center; color: #6b7280;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    try {
      const response = await fetch(`/api/client/bookings?phone=${encodeURIComponent(phone)}`);
      const result = await response.json();
      
      if (result.success) {
        allBookings = result.bookings || [];
        renderBookings();
      } else {
        bookingsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>${result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π'}</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:', error);
      bookingsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <p>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
        </div>
      `;
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
  function renderBookings() {
    const bookingsList = document.getElementById('bookings-list');
    
    if (allBookings.length === 0) {
      bookingsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìÖ</div>
          <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
        </div>
      `;
      return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏: —Å–Ω–∞—á–∞–ª–∞ –±—É–¥—É—â–∏–µ, –ø–æ—Ç–æ–º –ø—Ä–æ—à–µ–¥—à–∏–µ
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    const sortedBookings = allBookings.sort((a, b) => {
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      
      if (dateA.getTime() !== dateB.getTime()) {
        return dateA - dateB;
      }
      
      return a.time.localeCompare(b.time);
    });
    
    bookingsList.innerHTML = sortedBookings.map(booking => {
      const bookingDate = new Date(booking.date);
      const isPast = bookingDate < today || (bookingDate.getTime() === today.getTime() && booking.time < now.toTimeString().slice(0, 5));
      const statusClass = isPast ? 'past' : 'active';
      const statusText = isPast ? '–ü—Ä–æ—à–µ–¥—à–∞—è' : '–ê–∫—Ç–∏–≤–Ω–∞—è';
      
      const dateStr = formatDate(booking.date);
      const timeStr = formatTime(booking.time);
      
      return `
        <div class="booking-card">
          <div class="booking-header">
            <div>
              <div class="booking-service">${escapeHtml(booking.service)}</div>
              <div class="booking-date-time">üìÖ ${dateStr} –≤ ${timeStr}</div>
              ${booking.salonName ? `<div class="booking-salon">üè¢ ${escapeHtml(booking.salonName)}</div>` : ''}
              ${booking.master ? `<div class="booking-master">üë§ –ú–∞—Å—Ç–µ—Ä: ${escapeHtml(booking.master)}</div>` : ''}
              ${booking.comment ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.9rem;">üí¨ ${escapeHtml(booking.comment)}</div>` : ''}
            </div>
            <span class="booking-status ${statusClass}">${statusText}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∞–ª–æ–Ω–æ–≤
  async function loadSalons() {
    const salonsList = document.getElementById('salons-list');
    salonsList.innerHTML = '<p style="text-align: center; color: #6b7280;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    try {
      const response = await fetch('/api/salons');
      const result = await response.json();
      
      if (result.success) {
        allSalons = result.salons || [];
        renderSalons();
      } else {
        salonsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>${result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∞–ª–æ–Ω–æ–≤'}</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∞–ª–æ–Ω–æ–≤:', error);
      salonsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <p>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
        </div>
      `;
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∞–ª–æ–Ω–æ–≤
  function renderSalons() {
    const salonsList = document.getElementById('salons-list');
    
    if (allSalons.length === 0) {
      salonsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üíá</div>
          <p>–°–∞–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ</p>
        </div>
      `;
      return;
    }
    
    salonsList.innerHTML = allSalons.map(salon => {
      const salonUrl = `/booking?userId=${salon.id}`;
      return `
        <div class="salon-card" onclick="window.location.href='${salonUrl}'">
          <div class="salon-name">${escapeHtml(salon.name || '–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã')}</div>
          ${salon.address ? `<div class="salon-address">üìç ${escapeHtml(salon.address)}</div>` : ''}
          ${salon.phone ? `<div class="salon-phone">üìû ${escapeHtml(salon.phone)}</div>` : ''}
        </div>
      `;
    }).join('');
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const days = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
    const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
    
    const day = date.getDate();
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    const dayOfWeek = days[date.getDay()];
    
    return `${day} ${month} ${year}, ${dayOfWeek}`;
  }

  function formatTime(timeStr) {
    return timeStr.slice(0, 5);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∞–ª–æ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadSalons();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Studio — Онлайн запись</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f7f7fb;
      color: #222;
      line-height: 1.5;
    }

    header {
      background: linear-gradient(135deg, #f973b6, #a855f7);
      color: white;
      padding: 24px 16px 48px;
      text-align: center;
    }

    header h1 {
      font-size: 2.4rem;
      margin-bottom: 8px;
    }

    header p {
      opacity: 0.9;
      max-width: 480px;
      margin: 0 auto;
    }

    .container {
      max-width: 1100px;
      margin: -30px auto 40px;
      padding: 0 16px 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 20px 20px 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    .card h2 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }

    .card p.description {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 16px;
    }

    .services-list,
    .masters-list {
      display: grid;
      gap: 10px;
      margin-bottom: 8px;
    }

    .service-item,
    .master-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.95rem;
    }

    .service-item span:first-child {
      font-weight: 500;
    }

    .service-item span.price {
      font-weight: 600;
      color: #16a34a;
    }

    .master-item span.role {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 12px 0 16px;
    }

    form {
      display: grid;
      gap: 12px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 4px;
      display: inline-block;
    }

    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.35);
      background: #ffffff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .btn-primary,
    .btn-secondary {
      border: none;
      outline: none;
      background: linear-gradient(135deg, #f973b6, #a855f7);
      color: white;
      padding: 9px 14px;
      font-size: 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.2s;
      box-shadow: 0 10px 25px rgba(168, 85, 247, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-secondary {
      background: #111827;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
    }

    .btn-primary:hover,
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 15px 30px rgba(15, 23, 42, 0.55);
    }

    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.4);
    }

    .note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .alert {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 0.85rem;
      display: none;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .hidden {
      display: none !important;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tab-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #4b5563;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #f973b6, #a855f7);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
    }

    .tab-content {
      width: 100%;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: #6b7280;
      padding: 8px 16px 16px;
    }

    .admin-calendar-card {
      margin-top: 16px;
    }

    .week-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .week-controls button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .week-controls button:hover {
      background: #f3f4f6;
    }

    #week-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #4b5563;
    }

    .calendar-grid {
      margin-top: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      background: #f9fafb;
      display: grid;
    }

    .cal-cell {
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      padding: 4px 6px;
      font-size: 0.78rem;
      min-height: 26px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .cal-header {
      background: #f3e8ff;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .cal-day-header {
      text-align: center;
    }

    .cal-hour-label {
      background: #eef2ff;
      font-weight: 500;
      font-size: 0.8rem;
      text-align: right;
    }

    .cal-slot {
      background: #f9fafb;
    }

    .cal-slot-busy {
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 500;
    }

    .cal-corner {
      background: #f9fafb;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px 18px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.4);
      font-size: 0.9rem;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
      color: #6b7280;
    }

    .modal-body p {
      margin-bottom: 4px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #4f46e5;
      margin-right: 4px;
    }

    .badge-master {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-service {
      background: #e0f2fe;
      color: #0369a1;
    }

    .login-error {
      color: #b91c1c;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .admin-list {
      margin-top: 8px;
      font-size: 0.85rem;
      border-top: 1px solid #e5e7eb;
      padding-top: 6px;
    }

    .admin-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .admin-list-main {
      display: flex;
      flex-direction: column;
    }

    .admin-list-main span:first-child {
      font-weight: 500;
    }

    .admin-list-main span:last-child {
      color: #6b7280;
    }

    .admin-list-actions {
      display: flex;
      gap: 4px;
    }

    .admin-list-actions button {
      border: none;
      background: transparent;
      font-size: 0.78rem;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 6px;
    }

    .admin-list-actions button[data-action="edit"] {
      color: #2563eb;
    }

    .admin-list-actions button[data-action="edit"]:hover {
      background: #dbeafe;
    }

    .admin-list-actions button[data-action="delete"] {
      color: #b91c1c;
    }

    .admin-list-actions button[data-action="delete"]:hover {
      background: #fee2e2;
    }
  </style>
</head>
<body>
<header>
  <h1>Beauty Studio</h1>
  <p>Современный салон красоты в центре города. Запишитесь онлайн за пару кликов.</p>
</header>

<div class="container">
  <div class="tabs">
    <button type="button" class="tab-button active" data-tab="booking-tab">Онлайн запись</button>
    <button type="button" class="tab-button" data-tab="calendar-tab">Календарь / Сотрудники</button>
  </div>

  <div id="booking-tab" class="tab-content">
    <div class="grid">
      <!-- Левая колонка: услуги и мастера -->
      <div class="card">
        <h2>Услуги</h2>
        <p class="description">Выберите услугу, а затем оформите запись в удобное время.</p>

        <div class="services-list" id="services-list"></div>

        <div class="divider"></div>

        <h2>Мастера</h2>
        <div class="masters-list" id="masters-list"></div>

        <p class="note">
          После отправки заявки администратор свяжется с вами в мессенджере или по телефону для подтверждения времени.
        </p>
      </div>

      <!-- Правая колонка: форма записи -->
      <div class="card">
        <h2>Онлайн запись</h2>
        <p class="description">Заполните форму, мы подтвердим запись в ближайшее время.</p>

        <form id="booking-form">
          <div>
            <label for="client-name">Имя *</label>
            <input id="client-name" type="text" name="name" placeholder="Как к вам обращаться?" required />
          </div>

          <div>
            <label for="client-phone">Телефон *</label>
            <input id="client-phone" type="tel" name="phone" placeholder="+998XX XXX XX XX" required />
          </div>

          <div>
            <label for="service">Услуга *</label>
            <select id="service" name="service" required>
              <option value="">Выберите услугу</option>
            </select>
          </div>

          <div>
            <label for="master">Мастер</label>
            <select id="master" name="master">
              <option value="">Любой свободный мастер</option>
            </select>
          </div>

          <div class="form-row">
            <div>
              <label for="date">Дата *</label>
              <input id="date" type="date" name="date" required />
            </div>
            <div>
              <label for="time-slot">Время *</label>
              <select id="time-slot" name="time" required>
                <option value="">Сначала выберите услугу и дату</option>
              </select>
              <p id="duration-hint" class="note"></p>
              <p id="slot-hint" class="note"></p>
            </div>
          </div>

          <div>
            <label for="comment">Комментарий</label>
            <textarea id="comment" name="comment" placeholder="Например: хочу дизайн в нюдовых оттенках."></textarea>
          </div>

          <button type="submit" class="btn-primary">Отправить заявку</button>

          <div id="alert-success" class="alert alert-success">
            Спасибо! Заявка отправлена. Мы свяжемся с вами для подтверждения записи.
          </div>
          <div id="alert-error" class="alert alert-error">
            Пожалуйста, заполните все обязательные поля корректно.
          </div>

          <p class="note">
            Нажимая кнопку, вы соглашаетесь с обработкой персональных данных.
          </p>
        </form>
      </div>
    </div>
  </div>

  <div id="calendar-tab" class="tab-content hidden">
    <!-- Карточка логина для сотрудников -->
    <div id="staff-login-card" class="card admin-calendar-card">
      <h2>Вход для сотрудников</h2>
      <p class="description">Введите логин и пароль, чтобы открыть календарь и админ-панель.</p>
      <form id="staff-login-form">
        <div>
          <label for="staff-login">Логин</label>
          <input type="text" id="staff-login" autocomplete="off" />
        </div>
        <div>
          <label for="staff-password">Пароль</label>
          <input type="password" id="staff-password" />
        </div>
        <button type="submit" class="btn-secondary">Войти</button>
        <div id="staff-login-error" class="login-error hidden">Неверный логин или пароль.</div>
        <p class="note">Демо-доступ: <strong>admin / beauty123</strong></p>
      </form>
    </div>

    <!-- Контент сотрудников (календарь + админка) -->
    <div id="staff-content" class="hidden">
      <div class="card admin-calendar-card">
        <h2>Календарь записей</h2>
        <p class="description">Недельный вид расписания по часам. Можно перелистывать недели и фильтровать по мастеру.</p>

        <div class="form-row" style="margin-bottom: 8px;">
          <div>
            <label for="calendar-master-filter">Календарь мастера</label>
            <select id="calendar-master-filter">
              <option value="">Общий календарь (все мастера)</option>
            </select>
            <p class="note">Выберите конкретного мастера, чтобы посмотреть его личное расписание.</p>
          </div>
          <div>
            <label>Неделя</label>
            <div class="week-controls">
              <button type="button" id="prev-week">‹ Предыдущая неделя</button>
              <div id="week-label"></div>
              <button type="button" id="next-week">Следующая неделя ›</button>
            </div>
          </div>
        </div>

        <div id="calendar-grid" class="calendar-grid"></div>
      </div>

      <div class="card admin-calendar-card">
        <h2>Админ-панель</h2>
        <p class="description">Настройка услуг, стоимости и мастеров. Изменения применяются только в рамках текущей страницы (демо-режим).</p>

        <div class="form-row">
          <div>
            <h3 style="font-size:1rem; margin-bottom:6px;">Добавить / изменить услугу</h3>
            <form id="admin-service-form">
              <label for="admin-service-name">Название услуги</label>
              <input type="text" id="admin-service-name" placeholder="Например: Ботокс волос" />
              <label for="admin-service-price">Стоимость, сум</label>
              <input type="text" id="admin-service-price" placeholder="Например: 350000" />
              <label for="admin-service-duration">Длительность, минут</label>
              <input type="text" id="admin-service-duration" placeholder="Например: 90" />
              <button type="submit" class="btn-primary" id="admin-service-submit">Сохранить услугу</button>
              <p class="note">Новая услуга появится в списке и в форме записи.</p>
            </form>
            <h4 style="font-size:0.9rem; margin-top:10px;">Текущие услуги</h4>
            <div id="admin-services-list" class="admin-list"></div>
          </div>

          <div>
            <h3 style="font-size:1rem; margin-bottom:6px;">Добавить мастера</h3>
            <form id="admin-master-form">
              <label for="admin-master-name">Имя мастера</label>
              <input type="text" id="admin-master-name" placeholder="Например: Лейла" />
              <label for="admin-master-role">Специализация</label>
              <input type="text" id="admin-master-role" placeholder="Например: бровист" />
              <button type="submit" class="btn-primary" id="admin-master-submit">Сохранить мастера</button>
              <p class="note">Мастер появится в списке, в форме записи и в фильтре календаря.</p>
            </form>
            <h4 style="font-size:0.9rem; margin-top:10px;">Текущие мастера</h4>
            <div id="admin-masters-list" class="admin-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  © 2025 Beauty Studio. Все права защищены.
</footer>

<div id="booking-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Запись клиента</div>
      <button type="button" id="modal-close" class="modal-close">×</button>
    </div>
    <div class="modal-body">
      <p><strong>Клиент:</strong> <span id="modal-client-name"></span></p>
      <p><strong>Телефон:</strong> <span id="modal-client-phone"></span></p>
      <p>
        <span class="badge badge-service" id="modal-service"></span>
        <span class="badge badge-master" id="modal-master"></span>
      </p>
      <p><strong>Дата:</strong> <span id="modal-date"></span></p>
      <p><strong>Время:</strong> <span id="modal-time"></span></p>
      <p><strong>Комментарий:</strong></p>
      <p id="modal-comment"></p>
    </div>
  </div>
</div>

<script>
  // --- Минимальная установка min даты ---
  (function setMinDate() {
    const dateInput = document.getElementById("date");
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    dateInput.min = `${yyyy}-${mm}-${dd}`;
  })();

  // --- Helpers времени ---
  function timeToMinutes(t) {
    if (!t) return null;
    const parts = t.split(":");
    if (parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToTime(total) {
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  }

  function getEndTime(startTime, durationMinutes) {
    const start = timeToMinutes(startTime);
    if (start === null) return "";
    const end = start + durationMinutes;
    return minutesToTime(end);
  }

  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  // --- DOM ссылки ---
  const form = document.getElementById("booking-form");
  const successAlert = document.getElementById("alert-success");
  const errorAlert = document.getElementById("alert-error");

  const serviceSelect = document.getElementById("service");
  const masterSelect = document.getElementById("master");
  const dateInput = document.getElementById("date");
  const timeSelect = document.getElementById("time-slot");
  const durationHint = document.getElementById("duration-hint");
  const slotHint = document.getElementById("slot-hint");

  const servicesListEl = document.getElementById("services-list");
  const mastersListEl = document.getElementById("masters-list");

  const calendarGrid = document.getElementById("calendar-grid");
  const weekLabel = document.getElementById("week-label");
  const prevWeekBtn = document.getElementById("prev-week");
  const nextWeekBtn = document.getElementById("next-week");
  const calendarMasterFilter = document.getElementById("calendar-master-filter");

  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");

  const modalOverlay = document.getElementById("booking-modal");
  const modalClientName = document.getElementById("modal-client-name");
  const modalClientPhone = document.getElementById("modal-client-phone");
  const modalService = document.getElementById("modal-service");
  const modalMaster = document.getElementById("modal-master");
  const modalDate = document.getElementById("modal-date");
  const modalTime = document.getElementById("modal-time");
  const modalComment = document.getElementById("modal-comment");
  const modalCloseBtn = document.getElementById("modal-close");

  const staffLoginCard = document.getElementById("staff-login-card");
  const staffContent = document.getElementById("staff-content");
  const staffLoginForm = document.getElementById("staff-login-form");
  const staffLoginError = document.getElementById("staff-login-error");
  const staffLoginInput = document.getElementById("staff-login");
  const staffPasswordInput = document.getElementById("staff-password");

  const adminServiceForm = document.getElementById("admin-service-form");
  const adminServiceName = document.getElementById("admin-service-name");
  const adminServicePrice = document.getElementById("admin-service-price");
  const adminServiceDuration = document.getElementById("admin-service-duration");
  const adminServiceSubmitBtn = document.getElementById("admin-service-submit");
  const adminServicesList = document.getElementById("admin-services-list");

  const adminMasterForm = document.getElementById("admin-master-form");
  const adminMasterName = document.getElementById("admin-master-name");
  const adminMasterRole = document.getElementById("admin-master-role");
  const adminMasterSubmitBtn = document.getElementById("admin-master-submit");
  const adminMastersList = document.getElementById("admin-masters-list");

  // --- Состояние ---
  const STAFF_USER = "admin";
  const STAFF_PASS = "beauty123";
  let isStaffLoggedIn = false;

  let services = [
    { id: 1, name: "Стрижка простая", price: 180000, duration: 60 },
    { id: 2, name: "Стрижка + укладка", price: 260000, duration: 120 },
    { id: 3, name: "Маникюр классический", price: 160000, duration: 90 },
    { id: 4, name: "Маникюр + покрытие гель-лак", price: 220000, duration: 120 },
    { id: 5, name: "Педикюр", price: 250000, duration: 120 }
  ];

  let masters = [
    { id: 1, name: "Алина", role: "маникюр, педикюр" },
    { id: 2, name: "Диана", role: "маникюр, дизайн" },
    { id: 3, name: "София", role: "парикмахер-стилист" }
  ];

  let serviceDurations = {};
  const allBookings = [];
  const busyIntervals = {}; // "YYYY-MM-DD": [["HH:MM", "HH:MM"], ...]
  const WEEK_DAYS = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
  let currentWeekStart = getWeekStart(new Date());
  let editingServiceId = null;
  let editingMasterId = null;

  // --- Рендер справочников ---
  function rebuildServiceDurations() {
    serviceDurations = {};
    services.forEach((s) => {
      serviceDurations[s.name] = s.duration;
    });
  }

  function renderServicesAndMasters() {
    rebuildServiceDurations();

    if (servicesListEl) {
      servicesListEl.innerHTML = "";
      services.forEach((s) => {
        const row = document.createElement("div");
        row.className = "service-item";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = s.name;
        const priceSpan = document.createElement("span");
        priceSpan.className = "price";
        priceSpan.textContent = `${s.price.toLocaleString("ru-RU")} сум · ${Math.round((s.duration / 60) * 10) / 10} ч`;
        row.appendChild(nameSpan);
        row.appendChild(priceSpan);
        servicesListEl.appendChild(row);
      });
    }

    if (serviceSelect) {
      const currentValue = serviceSelect.value;
      serviceSelect.innerHTML = "";
      const baseOpt = document.createElement("option");
      baseOpt.value = "";
      baseOpt.textContent = "Выберите услугу";
      serviceSelect.appendChild(baseOpt);
      services.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        serviceSelect.appendChild(opt);
      });
      if (currentValue && serviceDurations[currentValue]) {
        serviceSelect.value = currentValue;
      }
    }

    if (mastersListEl) {
      mastersListEl.innerHTML = "";
      masters.forEach((m) => {
        const row = document.createElement("div");
        row.className = "master-item";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = m.name;
        const roleSpan = document.createElement("span");
        roleSpan.className = "role";
        roleSpan.textContent = m.role;
        row.appendChild(nameSpan);
        row.appendChild(roleSpan);
        mastersListEl.appendChild(row);
      });
    }

    if (masterSelect) {
      const currentMaster = masterSelect.value;
      masterSelect.innerHTML = "";
      const anyOpt = document.createElement("option");
      anyOpt.value = "";
      anyOpt.textContent = "Любой свободный мастер";
      masterSelect.appendChild(anyOpt);
      masters.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        masterSelect.appendChild(opt);
      });
      masterSelect.value = currentMaster || "";
    }

    if (calendarMasterFilter) {
      const currentFilter = calendarMasterFilter.value;
      calendarMasterFilter.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "Общий календарь (все мастера)";
      calendarMasterFilter.appendChild(allOpt);
      masters.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        calendarMasterFilter.appendChild(opt);
      });
      calendarMasterFilter.value = currentFilter || "";
    }

    if (adminServicesList) {
      adminServicesList.innerHTML = "";
      services.forEach((s) => {
        const row = document.createElement("div");
        row.className = "admin-list-item";
        const main = document.createElement("div");
        main.className = "admin-list-main";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = s.name;
        const metaSpan = document.createElement("span");
        metaSpan.textContent = `${s.price.toLocaleString("ru-RU")} сум · ${s.duration} мин`;
        main.appendChild(nameSpan);
        main.appendChild(metaSpan);

        const actions = document.createElement("div");
        actions.className = "admin-list-actions";
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "Редактировать";
        editBtn.dataset.action = "edit";
        editBtn.dataset.id = String(s.id);
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Удалить";
        deleteBtn.dataset.action = "delete";
        deleteBtn.dataset.id = String(s.id);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        row.appendChild(main);
        row.appendChild(actions);
        adminServicesList.appendChild(row);
      });
    }

    if (adminMastersList) {
      adminMastersList.innerHTML = "";
      masters.forEach((m) => {
        const row = document.createElement("div");
        row.className = "admin-list-item";
        const main = document.createElement("div");
        main.className = "admin-list-main";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = m.name;
        const roleSpan = document.createElement("span");
        roleSpan.textContent = m.role || "без специализации";
        main.appendChild(nameSpan);
        main.appendChild(roleSpan);

        const actions = document.createElement("div");
        actions.className = "admin-list-actions";
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "Редактировать";
        editBtn.dataset.action = "edit";
        editBtn.dataset.id = String(m.id);
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Удалить";
        deleteBtn.dataset.action = "delete";
        deleteBtn.dataset.id = String(m.id);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        row.appendChild(main);
        row.appendChild(actions);
        adminMastersList.appendChild(row);
      });
    }
  }

  // --- Календарь ---
  function openBookingModal(index) {
    if (!modalOverlay) return;
    const booking = allBookings[index];
    if (!booking) return;

    modalClientName.textContent = booking.name || "—";
    modalClientPhone.textContent = booking.phone || "—";
    modalService.textContent = booking.service || "—";
    modalMaster.textContent = booking.master || "Любой мастер";
    modalDate.textContent = booking.date || "—";
    if (booking.time && booking.endTime) {
      modalTime.textContent = `${booking.time}–${booking.endTime}`;
    } else {
      modalTime.textContent = booking.time || "—";
    }
    modalComment.textContent = booking.comment || "Нет комментария";

    modalOverlay.classList.remove("hidden");
  }

  function closeBookingModal() {
    if (!modalOverlay) return;
    modalOverlay.classList.add("hidden");
  }

  function setActiveTab(tabId) {
    tabButtons.forEach((btn) => {
      const target = btn.getAttribute("data-tab");
      if (target === tabId) btn.classList.add("active");
      else btn.classList.remove("active");
    });

    tabContents.forEach((tab) => {
      if (tab.id === tabId) tab.classList.remove("hidden");
      else tab.classList.add("hidden");
    });
  }

  function renderCalendar() {
    if (!calendarGrid) return;
    const startHour = 10;
    const endHour = 20;

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(currentWeekStart);
      d.setDate(d.getDate() + i);
      weekDates.push(d);
    }

    if (weekLabel) {
      const fmt = (d) => {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      };
      weekLabel.textContent = `${fmt(weekDates[0])} – ${fmt(weekDates[6])}`;
    }

    calendarGrid.style.gridTemplateColumns = "80px repeat(7, 1fr)";
    calendarGrid.innerHTML = "";

    const emptyHeader = document.createElement("div");
    emptyHeader.className = "cal-cell cal-header cal-corner";
    calendarGrid.appendChild(emptyHeader);

    weekDates.forEach((d, idx) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-header cal-day-header";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      cell.textContent = `${WEEK_DAYS[idx]} ${dd}.${mm}`;
      calendarGrid.appendChild(cell);
    });

    function dateToISO(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    const selectedMaster = calendarMasterFilter ? calendarMasterFilter.value : "";

    for (let hour = startHour; hour < endHour; hour++) {
      const hourCell = document.createElement("div");
      hourCell.className = "cal-cell cal-hour-label";
      hourCell.textContent = `${String(hour).padStart(2, "0")}:00`;
      calendarGrid.appendChild(hourCell);

      weekDates.forEach((d) => {
        const cell = document.createElement("div");
        cell.className = "cal-cell cal-slot";
        const iso = dateToISO(d);

        const bookingsForCell = allBookings.filter((b) => {
          if (b.date !== iso) return false;
          if (selectedMaster && b.master !== selectedMaster) return false;
          const startM = timeToMinutes(b.time);
          const endM = timeToMinutes(b.endTime);
          const cellStart = hour * 60;
          const cellEnd = (hour + 1) * 60;
          return startM < cellEnd && endM > cellStart;
        });

        if (bookingsForCell.length) {
          cell.classList.add("cal-slot-busy");
          const b = bookingsForCell[0];
          const parts = [];
          if (b.time && b.endTime) parts.push(`${b.time}-${b.endTime}`);
          if (b.service) parts.push(b.service);
          if (b.master) parts.push(b.master);
          cell.textContent = parts.join(" · ");
          const bookingIndex = allBookings.indexOf(b);
          if (bookingIndex !== -1) {
            cell.dataset.bookingIndex = String(bookingIndex);
            cell.style.cursor = "pointer";
          }
        }

        calendarGrid.appendChild(cell);
      });
    }
  }

  // --- Подсказка длительности ---
  function updateDurationHint() {
    if (!durationHint) return;
    const service = serviceSelect.value;
    const duration = serviceDurations[service];
    const time = timeSelect ? timeSelect.value : "";

    if (!service || !duration) {
      durationHint.textContent = "";
      return;
    }

    if (!time) {
      durationHint.textContent = `Длительность услуги: ${duration} мин.`;
      return;
    }

    const endTime = getEndTime(time, duration);
    if (!endTime) {
      durationHint.textContent = `Длительность услуги: ${duration} мин.`;
      return;
    }

    durationHint.textContent = `Длительность услуги: ${duration} мин. Будете свободны примерно в ${endTime}.`;
  }

  // --- Генерация свободных слотов ---
  function generateSlots() {
    const service = serviceSelect.value;
    const date = dateInput.value;

    if (timeSelect) {
      timeSelect.innerHTML = "";
      timeSelect.disabled = false;
    }
    if (slotHint) slotHint.textContent = "";
    if (durationHint) durationHint.textContent = "";

    const baseOption = document.createElement("option");

    if (!service || !date) {
      baseOption.value = "";
      baseOption.textContent = "Сначала выберите услугу и дату";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const duration = serviceDurations[service];
    if (!duration) {
      baseOption.value = "";
      baseOption.textContent = "Сначала выберите услугу";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      return;
    }

    const startOfDay = 10 * 60;
    const endOfDay = 20 * 60;
    const step = 30;

    const busy = (busyIntervals[date] || []).map(([from, to]) => [
      timeToMinutes(from),
      timeToMinutes(to)
    ]);

    const freeSlots = [];

    for (let start = startOfDay; start + duration <= endOfDay; start += step) {
      const end = start + duration;
      const overlaps = busy.some(([bStart, bEnd]) => start < bEnd && end > bStart);
      if (!overlaps) freeSlots.push({ start, end });
    }

    if (!freeSlots.length) {
      baseOption.value = "";
      baseOption.textContent = "Нет свободных окон на этот день";
      if (timeSelect) {
        timeSelect.appendChild(baseOption);
        timeSelect.disabled = true;
      }
      if (slotHint) slotHint.textContent = "На выбранную дату нет свободного времени. Попробуйте другой день или услугу.";
      return;
    }

    if (timeSelect) {
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "Выберите время";
      timeSelect.appendChild(defaultOption);

      freeSlots.forEach((slot) => {
        const opt = document.createElement("option");
        const startStr = minutesToTime(slot.start);
        const endStr = minutesToTime(slot.end);
        opt.value = startStr;
        opt.textContent = `${startStr} – ${endStr}`;
        timeSelect.appendChild(opt);
      });
    }

    if (slotHint) slotHint.textContent = "Доступные свободные окна на выбранную дату.";
    if (durationHint) durationHint.textContent = `Длительность услуги: ${duration} мин.`;
  }

  // --- Инициализация UI ---
  renderServicesAndMasters();
  renderCalendar();

  if (serviceSelect) serviceSelect.addEventListener("change", generateSlots);
  if (dateInput) dateInput.addEventListener("change", generateSlots);
  if (timeSelect) timeSelect.addEventListener("change", updateDurationHint);
  if (calendarMasterFilter) calendarMasterFilter.addEventListener("change", renderCalendar);

  if (tabButtons && tabButtons.length) {
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");
        if (!target) return;
        setActiveTab(target);
      });
    });
  }

  if (modalOverlay) {
    modalOverlay.addEventListener("click", (e) => {
      if (e.target === modalOverlay) closeBookingModal();
    });
  }

  if (modalCloseBtn) modalCloseBtn.addEventListener("click", closeBookingModal);

  if (prevWeekBtn) {
    prevWeekBtn.addEventListener("click", () => {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      renderCalendar();
    });
  }

  if (nextWeekBtn) {
    nextWeekBtn.addEventListener("click", () => {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      renderCalendar();
    });
  }

  if (calendarGrid) {
    calendarGrid.addEventListener("click", (e) => {
      const target = e.target.closest(".cal-slot-busy");
      if (!target) return;
      const idx = target.dataset.bookingIndex;
      if (idx === undefined) return;
      openBookingModal(Number(idx));
    });
  }

  // --- Логин сотрудников ---
  if (staffLoginForm) {
    staffLoginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const login = staffLoginInput.value.trim();
      const pass = staffPasswordInput.value.trim();
      if (login === STAFF_USER && pass === STAFF_PASS) {
        isStaffLoggedIn = true;
        staffLoginError.classList.add("hidden");
        staffLoginCard.classList.add("hidden");
        staffContent.classList.remove("hidden");
      } else {
        isStaffLoggedIn = false;
        staffLoginError.classList.remove("hidden");
      }
    });
  }

  // --- Админка: клик по услугам (редактировать / удалить) ---
  if (adminServicesList) {
    adminServicesList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;
      const service = services.find((s) => s.id === id);
      if (!service) return;

      if (action === "edit") {
        adminServiceName.value = service.name;
        adminServicePrice.value = String(service.price);
        adminServiceDuration.value = String(service.duration);
        editingServiceId = service.id;
        if (adminServiceSubmitBtn) adminServiceSubmitBtn.textContent = "Обновить услугу";
      } else if (action === "delete") {
        if (!confirm(`Удалить услугу "${service.name}"?`)) return;
        services = services.filter((s) => s.id !== id);
        if (editingServiceId === id) {
          editingServiceId = null;
          adminServiceName.value = "";
          adminServicePrice.value = "";
          adminServiceDuration.value = "";
          if (adminServiceSubmitBtn) adminServiceSubmitBtn.textContent = "Сохранить услугу";
        }
        renderServicesAndMasters();
        generateSlots();
        updateDurationHint();
      }
    });
  }

  // --- Админка: клик по мастерам (редактировать / удалить) ---
  if (adminMastersList) {
    adminMastersList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;
      const master = masters.find((m) => m.id === id);
      if (!master) return;

      if (action === "edit") {
        adminMasterName.value = master.name;
        adminMasterRole.value = master.role || "";
        editingMasterId = master.id;
        if (adminMasterSubmitBtn) adminMasterSubmitBtn.textContent = "Обновить мастера";
      } else if (action === "delete") {
        if (!confirm(`Удалить мастера "${master.name}"?`)) return;
        masters = masters.filter((m) => m.id !== id);
        if (editingMasterId === id) {
          editingMasterId = null;
          adminMasterName.value = "";
          adminMasterRole.value = "";
          if (adminMasterSubmitBtn) adminMasterSubmitBtn.textContent = "Сохранить мастера";
        }
        renderServicesAndMasters();
        renderCalendar();
      }
    });
  }

  // --- Админка: сохранить услугу ---
  if (adminServiceForm) {
    adminServiceForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = adminServiceName.value.trim();
      const priceRaw = adminServicePrice.value.trim();
      const durationRaw = adminServiceDuration.value.trim();

      if (!name || !priceRaw || !durationRaw) {
        alert("Заполните название, стоимость и длительность услуги.");
        return;
      }

      const price = Number(priceRaw.replace(/\s+/g, ""));
      const duration = Number(durationRaw.replace(/\s+/g, ""));
      if (Number.isNaN(price) || Number.isNaN(duration)) {
        alert("Стоимость и длительность должны быть числами.");
        return;
      }
      if (price <= 0 || duration <= 0) {
        alert("Стоимость и длительность должны быть положительными числами.");
        return;
      }

      if (editingServiceId !== null) {
        const svc = services.find((s) => s.id === editingServiceId);
        if (svc) {
          svc.name = name;
          svc.price = price;
          svc.duration = duration;
        }
        editingServiceId = null;
        if (adminServiceSubmitBtn) adminServiceSubmitBtn.textContent = "Сохранить услугу";
      } else {
        const existing = services.find((s) => s.name === name);
        if (existing) {
          existing.price = price;
          existing.duration = duration;
        } else {
          services.push({
            id: services.length ? services[services.length - 1].id + 1 : 1,
            name,
            price,
            duration
          });
        }
      }

      adminServiceName.value = "";
      adminServicePrice.value = "";
      adminServiceDuration.value = "";

      renderServicesAndMasters();
      generateSlots();
      updateDurationHint();
    });
  }

  // --- Админка: сохранить мастера ---
  if (adminMasterForm) {
    adminMasterForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = adminMasterName.value.trim();
      const role = adminMasterRole.value.trim();

      if (!name) {
        alert("Введите имя мастера.");
        return;
      }

      if (editingMasterId !== null) {
        const m = masters.find((mm) => mm.id === editingMasterId);
        if (m) {
          m.name = name;
          m.role = role || m.role;
        }
        editingMasterId = null;
        if (adminMasterSubmitBtn) adminMasterSubmitBtn.textContent = "Сохранить мастера";
      } else {
        const existing = masters.find((m) => m.name === name);
        if (existing) {
          existing.role = role || existing.role;
        } else {
          masters.push({
            id: masters.length ? masters[masters.length - 1].id + 1 : 1,
            name,
            role
          });
        }
      }

      adminMasterName.value = "";
      adminMasterRole.value = "";

      renderServicesAndMasters();
      renderCalendar();
    });
  }

  // --- Отправка формы записи ---
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (successAlert) successAlert.style.display = "none";
      if (errorAlert) errorAlert.style.display = "none";

      const formData = new FormData(form);
      const data = {
        name: (formData.get("name") || "").trim(),
        phone: (formData.get("phone") || "").trim(),
        service: formData.get("service"),
        master: formData.get("master"),
        date: formData.get("date"),
        time: formData.get("time"),
        comment: (formData.get("comment") || "").trim()
      };

      if (!data.name || !data.phone || !data.service || !data.date || !data.time) {
        if (errorAlert) errorAlert.style.display = "block";
        return;
      }

      // Простая валидация телефона (минимум 9 цифр)
      const phoneDigits = data.phone.replace(/\D/g, "");
      if (phoneDigits.length < 9) {
        if (errorAlert) {
          errorAlert.textContent = "Пожалуйста, введите корректный номер телефона (минимум 9 цифр).";
          errorAlert.style.display = "block";
        }
        return;
      }

      const duration = serviceDurations[data.service];
      if (duration) {
        const endTime = getEndTime(data.time, duration);
        if (endTime) {
          if (!busyIntervals[data.date]) busyIntervals[data.date] = [];
          busyIntervals[data.date].push([data.time, endTime]);
          allBookings.push({ ...data, endTime });

          const bookingDate = new Date(data.date);
          currentWeekStart = getWeekStart(bookingDate);
        }
      }

      // Заявка сохранена в allBookings
      if (successAlert) successAlert.style.display = "block";
      form.reset();

      generateSlots();
      renderCalendar();

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${yyyy}-${mm}-${dd}`;
    });
  }
</script>

</html>

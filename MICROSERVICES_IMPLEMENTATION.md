# Руководство по реализации микросервисов

Этот документ описывает, как был выполнен рефакторинг монолитного приложения в микросервисную архитектуру.

## Структура проекта

```
bs/
├── services/              # Микросервисы
│   ├── auth-service/      # Аутентификация (порт 3001)
│   ├── user-service/      # Пользователи (порт 3002)
│   ├── booking-service/   # Записи (порт 3003)
│   ├── catalog-service/   # Услуги и мастера (порт 3004)
│   ├── file-service/      # Файлы (порт 3005)
│   ├── notification-service/  # Уведомления (порт 3006)
│   └── telegram-service/  # Telegram (порт 3007)
├── shared/                # Общие модули
│   ├── database.js        # Подключение к БД
│   ├── utils.js           # Утилиты
│   └── cache.js           # Кэширование
├── gateway/               # API Gateway (порт 3000)
├── views/                 # HTML страницы
├── public/                # Статические файлы
└── docker-compose.microservices.yml
```

## Важные замечания

### Пути к shared модулям

В реальной реализации нужно настроить пути к общим модулям. Есть несколько вариантов:

1. **Использовать npm link** (для разработки)
2. **Создать npm пакет** для shared модулей
3. **Использовать относительные пути** (как в примерах)
4. **Скопировать shared модули** в каждый сервис

В текущей реализации используются относительные пути `../../shared/`, что работает, если сервисы запускаются из корня проекта.

### Сессии

Для production рекомендуется использовать Redis для хранения сессий вместо памяти. Пример:

```javascript
const RedisStore = require('connect-redis')(session);
const redisClient = require('redis').createClient();

app.use(session({
  store: new RedisStore({ client: redisClient }),
  // ... остальные настройки
}));
```

### Взаимодействие между сервисами

Сервисы взаимодействуют через HTTP REST API. Для внутренних запросов в Docker сети используется HTTP.

Пример вызова другого сервиса:

```javascript
const http = require('http');

async function callService(serviceName, path, options = {}) {
  const serviceUrl = `http://${serviceName}:${PORT}/${path}`;
  // ... HTTP запрос
}
```

### База данных

Все сервисы используют общую PostgreSQL базу данных. Каждый сервис работает со своими таблицами, но имеет доступ ко всем необходимым данным через shared/database.js.

## Миграция данных

Данные остаются в той же базе данных PostgreSQL. Миграция данных не требуется.

## Развертывание

1. Убедитесь, что все зависимости установлены в каждом сервисе
2. Запустите `docker-compose -f docker-compose.microservices.yml up`
3. API Gateway будет доступен на порту 3000

## Следующие шаги

1. Доработать обработку ошибок в каждом сервисе
2. Добавить логирование (например, Winston)
3. Настроить мониторинг (Prometheus, Grafana)
4. Добавить тесты для каждого сервиса
5. Настроить CI/CD для автоматического развертывания


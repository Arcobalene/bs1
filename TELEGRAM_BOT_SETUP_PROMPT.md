# Промпт для настройки Telegram-бота с привязкой к страницам салонов

## Задача

Настроить Telegram-бота так, чтобы:

1. **При регистрации владельца салона** на сайте его номер телефона сохраняется в БД в поле `salon_phone` таблицы `users`
2. **При запуске бота** владелец отправляет свой номер телефона через кнопку "Отправить контакт"
3. **Бот находит владельца** по номеру телефона в БД и привязывает `telegram_id` к записи владельца
4. **Уведомления отправляются** только о записях, которые относятся к странице этого владельца (например, `/booking?userId=5`)

## Архитектура системы

### Структура БД:
- **Таблица `users`:**
  - `id` - ID владельца салона (используется в URL `/booking?userId=5`)
  - `salon_phone` - номер телефона владельца (например, `+998903175512`)
  - `telegram_id` - привязанный Telegram ID (заполняется после подключения бота)
  
- **Таблица `bookings`:**
  - `user_id` - ID владельца салона (ссылается на `users.id`)
  - Все записи привязаны к конкретному владельцу через `user_id`

### Поток работы:

#### 1. Регистрация владельца салона:
```
Владелец регистрируется на сайте
    ↓
Номер телефона сохраняется в users.salon_phone
    ↓
Номер нормализуется в формат E.164 (например, +998903175512)
```

#### 2. Подключение Telegram-бота:
```
Владелец открывает бота в Telegram
    ↓
Отправляет команду /start connect
    ↓
Бот запрашивает контакт через кнопку "Отправить контакт"
    ↓
Владелец отправляет свой номер телефона
    ↓
Бот нормализует номер в E.164
    ↓
Бот ищет владельца через dbUsers.getByPhone(normalizedPhone)
    ↓
Находит запись владельца (например, userId=5)
    ↓
Сохраняет telegram_id в запись владельца
    ↓
Отправляет подтверждение с URL страницы: http://155.212.184.10/booking?userId=5
```

#### 3. Создание записи клиентом:
```
Клиент создает запись на странице /booking?userId=5
    ↓
Запись сохраняется с user_id = 5
    ↓
Вызывается sendTelegramNotificationToOwner(5, booking, 'new')
    ↓
Функция получает владельца с id=5 из БД
    ↓
Проверяет наличие telegram_id у владельца
    ↓
Отправляет уведомление через микросервис Telegram-бота
    ↓
Владелец получает уведомление в Telegram
```

## Что уже реализовано

### ✅ 1. Сохранение номера телефона
**Файл:** `server.js` (строка ~607)
- При обновлении информации о салоне через `/api/salon` (POST) номер нормализуется в формат E.164
- Добавлено логирование сохранения номера

### ✅ 2. Поиск владельца по номеру
**Файл:** `telegram-bot.js` (строка ~417)
- Бот нормализует номер из Telegram в формат E.164
- Использует `dbUsers.getByPhone()` для поиска
- Добавлено детальное логирование процесса поиска

### ✅ 3. Привязка telegram_id
**Файл:** `telegram-bot.js` (строка ~450)
- После нахождения владельца сохраняется `telegram_id`
- Проверяется уникальность (один telegram_id - один владелец)
- Добавлено логирование привязки

### ✅ 4. Отправка уведомлений
**Файл:** `server.js` (строка ~1898)
- Уведомления отправляются только владельцу, которому принадлежит запись
- Используется `salonOwnerId` из `booking.user_id`
- Проверяется наличие `telegram_id` перед отправкой
- Учитываются настройки уведомлений владельца

### ✅ 5. Изоляция данных
- Каждый владелец получает уведомления только о своих записях
- `booking.user_id` всегда равен `salonOwnerId`
- Нет возможности получить уведомления о чужих записях

## Улучшения, которые были добавлены

1. **Нормализация номеров телефонов:**
   - Все номера сохраняются в формате E.164
   - Единообразный формат для поиска

2. **Логирование:**
   - Логи при сохранении номера телефона
   - Логи при поиске владельца
   - Логи при привязке telegram_id
   - Логи при отправке уведомлений

3. **Сообщения в боте:**
   - В сообщении о подключении указан URL страницы салона
   - Четкое объяснение, что уведомления приходят только для записей на этой странице

4. **Переменная окружения:**
   - `SALON_BASE_URL` для настройки базового URL салона
   - По умолчанию: `http://155.212.184.10`

## Тестовые сценарии

### Сценарий 1: Регистрация и подключение
1. Зарегистрировать владельца с номером `+998903175512`
2. Сохранить номер в настройках салона через `/api/salon` (POST)
3. Проверить в БД: `users.salon_phone = '+998903175512'`
4. Открыть бота, отправить `/start connect`
5. Отправить контакт с номером `+998903175512`
6. Проверить в БД: `users.telegram_id` заполнен
7. Получить сообщение с URL: `http://155.212.184.10/booking?userId=5`

### Сценарий 2: Создание записи и уведомление
1. Создать запись на странице `/booking?userId=5`
2. Проверить в БД: `bookings.user_id = 5`
3. Проверить логи: отправка уведомления для `salonOwnerId=5`
4. Проверить Telegram: уведомление пришло владельцу с `id=5`

### Сценарий 3: Изоляция данных
1. Владелец с `id=5` подключен к боту
2. Владелец с `id=6` подключен к боту
3. Создать запись для `/booking?userId=5`
4. Проверить: уведомление пришло только владельцу с `id=5`
5. Создать запись для `/booking?userId=6`
6. Проверить: уведомление НЕ пришло владельцу с `id=5`

## Важные моменты

1. **Номер телефона должен совпадать:**
   - Номер в настройках салона (`users.salon_phone`)
   - Номер, отправленный в Telegram-бот
   - Оба номера нормализуются в E.164 для сравнения

2. **Изоляция гарантируется:**
   - `booking.user_id` всегда равен `salonOwnerId`
   - Уведомление отправляется только владельцу с этим `id`
   - Невозможно получить уведомления о чужих записях

3. **Один Telegram-аккаунт - один владелец:**
   - Один `telegram_id` может быть привязан только к одному владельцу
   - При попытке привязать к другому владельцу - ошибка

## Переменные окружения

Для работы бота необходимо настроить:

```bash
# Базовый URL сайта салона
SALON_BASE_URL=http://155.212.184.10

# Токен Telegram-бота (опционально, можно указать в БД)
TELEGRAM_BOT_TOKEN=your_bot_token_here

# URL микросервиса Telegram-бота (для основного сервера)
TELEGRAM_BOT_URL=http://telegram-bot:3001
```

## Готово к использованию

Система полностью настроена и готова к работе:
- ✅ Номера телефонов нормализуются и сохраняются правильно
- ✅ Бот находит владельцев по номеру телефона
- ✅ Telegram ID привязывается к правильному владельцу
- ✅ Уведомления отправляются только для записей владельца
- ✅ Изоляция данных гарантирована
- ✅ Добавлено детальное логирование для отладки
